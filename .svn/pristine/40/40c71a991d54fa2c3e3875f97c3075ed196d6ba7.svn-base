var M = {
    lan: {
        ok: '确定',
        cancel: '取消',
        close: '关闭',
        systit: '系统信息',
        confirm: '信息确认'
    },
    i: 0,
    lock: false,
    D: {},
    exec: function(opt, par) {
        M.cssInit();
        var set = {};
        if (opt) {
            $.extend(set, opt);
            if (par) $.extend(set, par)
        }
        var d = new Dialog(set);
        M.D[d.id] = d
    },
    alert: function(c, opt) {
        M.exec({
            type: 'alert',
            content: c
        }, opt)
    },
    confirm: function(c, f, cf, opt) {
        M.exec({
            type: 'confirm',
            title: M.lan.confirm,
            content: c,
            callback: f,
            cancel: true,
            button: [{
                text: M.lan.ok,
                callback: 'ok',
                name: 'dialog_y'
            }, {
                text: M.lan.cancel,
                callback: cf
            }]
        }, opt)
    },
    ok: function(c, opt) {
        M.exec({
            type: 'ok',
            content: c
        }, opt)
    },
    err: function(c, opt) {
        M.exec({
            type: 'err',
            content: c
        }, opt)
    },
    text: function(c, w, h, opt) {
        M.exec({
            type: 'text',
            content: c,
            width: w,
            height: h,
            button: '',
            style: 'margin:5px'
        }, opt)
    },
    show: function(c, opt) {
        M.exec({
            type: 'text',
            content: c,
            width: 0,
            button: '',
            style: 'margin:0;overflow:hidden;',
            head: false,
            css: '#{id} .dialogBody{border:0;box-shadow:0 0 0;border-radius:0}'
        }, opt)
    },
    load: function(u, w, h, opt) {
        $.ajax({
            url: u,
            success: function(s) {
                M.text(s, w, h, opt)
            }
        })
    },
    open: function(u, opt) {
        $.ajax({
            url: u,
            success: function(s) {
                M.show(s, opt)
            }
        })
    },
    iframe: function(u, w, h, opt) {
        M.exec({
            type: 'url',
            url: u,
            width: w,
            height: h,
            button: '',
            style: ''
        }, opt)
    },
    loading: function(c, opt) {
        M.exec({
            type: 'loading',
            content: c,
            button: '',
            width: 0,
            head: false,
            style: 'margin:5px 20px 5px 5px',
            css: '#{id} .dialogBody{box-shadow:0 0 0;border-radius:0}'
        }, opt)
    },
    doing: function(c, opt) {
        M.loading(c, {
            alpha: 0
        })
    },
    loadend: function() {
        $.each(M.D, function(i, o) {
            if (o.set.type == 'loading') o.close()
        })
    },
    time: 0,
    keydown: function() {
        if (M.microtime() - M.time < 5) return false;
        return !$('.dialogAll').length
    },
    yes: function() {
        var lc = M.local();
        if (lc) lc.ok()
    },
    close: function(id) {
        if (id && M.D[id]) {
            M.D[id].close()
        } else {
            var lc = M.local();
            if (lc) lc.close()
        }
    },
    local: function() {
        var r = 0;
        $.each(M.D, function(i, o) {
            if (o.set.type != 'loading') r = o
        });
        return r
    },
    microtime: function() {
        return new Date().getTime()
    },
    $skin: typeof vars == 'object' && vars && vars.skinurl ? vars.skinurl + 'img/' : 'http://cmslib.oa.com/skin/img/',
    cssInit: function() {
        if (M._cssInit) return;
        M._cssInit = 1;
        var skin = M.$skin;
        $(document.body).append('<style>.dialogBg{width:100%}.dialogTitle,.dialogTitle a,.dialogButtons input,.dialog_img p{background:url(' + skin + 'dialog.jpg) no-repeat}.dialogBody{border:solid 1px #ccc;overflow:hidden;box-shadow:3px 3px 2px #999;border-radius:8px 8px 0 0}.dialogBody,.dialogBody input{font-size:12px}.dialogBody,.dialogBg{position:absolute;left:0;top:0;z-index:9999}.dialogTitle{height:31px;border-bottom:3px #e0e0e0 solid;color:#333;overflow:hidden;background-repeat:repeat-x}.dialogTitle b{cursor:move;padding-left:18px;background:url(' + skin + 'leftclose.gif) no-repeat 10px center;display:block;line-height:32px;font-size:13px}.dialogTitle a{background-position:0 -143px;float:right;width:19px;height:19px;cursor:pointer;margin:5px 8px 0 0;display:inline}.dialogTitle a:hover{background-position:-51px -143px}.dialogContent{overflow-x:hidden;overflow:auto}.dialogContents iframe{width:100%;border:0;overflow:hidden;overflow-y:auto}.dialogButtons{text-align:center;border-top:1px solid #ccc;background:#efefef}table.dialogContents{width:auto;border:0}table.dialogContents td{text-align:left;border:0}.dialogButtons input{background-position:0 -63px;margin:5px;padding:0 0 2px;height:20px;border:0;letter-spacing:1px;cursor:pointer;overflow:visible;width:70px;height:24px;line-height:24px}.dialogButtons input:hover{background-position:0 -87px}.dialog_img{width:60px;padding:0}.dialog_img p{width:32px;height:32px;margin:0 auto}p.dialog_img_confirm{background-position:0 -31px}p.dialog_img_alert{background-position:-38px -31px}p.dialog_img_ok{background-position:0 -111px}p.dialog_img_err{background-position:-38px -111px}.dialogText{margin:0}.dialogText_ok{color:green}.dialogText_err{color:red}.dialogText_loading{color:#666;font-size:14px}td.dialog_img_loading{width:40px}td.dialog_img_loading p{width:34px;height:34px}.dialog_img p.dialog_img_loading{color:#666;font-size:14px;background:url(' + skin + 'loadtexas.gif) no-repeat center}.dialogAll b{color:#333;font-weight:bold;margin:0}</style>')
    }
};
var Dialog = function(opt) {
    var I = this,
        doc = $(document.body),
        ww = $(window).width(),
        wh = $(window).height();
    I.set = {
        type: 'alert',
        url: '',
        title: M.lan.systit,
        content: '',
        closetit: M.lan.close,
        cancel: false,
        width: 300,
        height: 0,
        time: 0,
        timeObj: null,
        style: 'margin:20px',
        success: '',
        callback: '',
        close: '',
        mask: true,
        fade: 0,
        head: true,
        img: '',
        top: 0,
        top2: 0,
        left: 0,
        bgcolor: '#000',
        notBg: 0,
        alpha: 0.1,
        skin: M.$skin,
        button: [{
            text: M.lan.ok,
            callback: 'ok',
            name: 'dialog_y'
        }],
        css: ''
    };
    if (opt) $.extend(I.set, opt);
    var z_index = function(add) {
        if (typeof VAR == 'object' && VAR.zIndex) {
            return VAR.zIndex++
        } else {
            return 9999
        }
    };
    I.init = function() {
        I.id = 'M_' + M.i++;
        I.top = $(document).scrollTop();
        var bg = '';
        if (I.set.mask) bg = '<div class="dialogBg closeRight"></div>';
        var tt = I.set.head ? '<div class="dialogTitle closeRight"><a title="' + I.set.closetit + '"></a><b>' + I.set.title + '</b></div>' : '';
        var css = I.set.css ? '<style>' + I.set.css.replace(new RegExp('{id}', 'g'), I.id) + '</style>' : '';
        var closeload = I.set.type == 'loading' ? '<a onclick="M.close(\'' + I.id + '\')" style="display:block;background:url(' + I.set.skin + 'dialog.jpg) no-repeat;background-position:-56px -148px;width:9px;height:9px;position:absolute;right:3px;top:3px;"></a>' : '';
        var s = '<div class="dialogAll" id="' + I.id + '" style="display:none">' + css + bg + '<div class="dialogBody"' + (I.set.notBg ? '' : ' style="background:#fff"') + '>' + closeload + tt + '<div class="dialogContent">' + I.getCon() + '</div>' + I.getBtn() + '</div></div>';
        doc.append(s);
        I.obj = $("#" + I.id);
        I.bg = $(".dialogBg", I.obj);
        I.body = $(".dialogBody", I.obj);
        I.title = $(".dialogTitle", I.obj);
        I.titles = $("b", I.title);
        I.content = $(".dialogContent", I.obj);
        I.buttons = $(".dialogButtons", I.obj);
        if (I.set.mask) {
            I.bg.css({
                height: $(document).height(),
                backgroundColor: I.set.bgcolor,
                filter: "alpha(opacity=" + I.set.alpha * 100 + ")",
                'z-index': z_index(),
                opacity: I.set.alpha
            })
        }
        if (I.set.width) I.body.width(Math.min($(document).width() - 50, I.set.width));
        I.obj.show(I.set.fade);
        if (I.set.height > 0) {
            var ht = I.title[0] ? I.title.outerHeight() : 0,
                h = I.set.height - ht;
            h = I.set.button ? h - I.buttons.outerHeight() : h;
            if (I.set.type == "url") {
                $(".dialogContent iframe", I.obj).height(h)
            } else {
                I.content.height(h)
            }
            $(".dialogText", I.obj).css("vertical-align", "top")
        }
        var bw = I.body.outerWidth(),
            bh = Math.min($(document).height() - 50, I.body.outerHeight()),
            _h = (wh - bh) / 2;
        I.body.css({
            width: bw,
            height: Math.min($(document).height() - 50, I.body.height()),
            top: (I.set.top || (I.top + _h)) + I.set.top2,
            left: I.set.left || (ww - bw) / 2,
            'z-index': z_index()
        })
    };
    I.getCon = function() {
        var s, tag = 'div';
        switch (I.set.type) {
            case "url":
                s = '<iframe frameborder="0" src="' + I.set.url + '"></iframe>';
                break;
            case "text":
                s = I.set.content;
                break;
            default:
                tag = 'table';
                s = '<tr><td class="dialog_img dialog_img_' + I.set.type + '">' + (I.set.img || '<p class="dialog_img_' + I.set.type + '"></p>') + '</td><td class="dialogText dialogText_' + I.set.type + '">' + I.set.content + '</td></tr>'
        }
        return '<' + tag + ' class="dialogContents" style="' + I.set.style + '">' + s + '</' + tag + '>'
    };
    I.getBtn = function() {
        if (!I.set.button) return '';
        var b = '';
        $(I.set.button).each(function(i, o) {
            b += '<input type="button" value="' + o.text + '" id="dialogbtn' + i + '"' + (o.name ? ' class="' + o.name + '"' : '') + ' />'
        });
        return '<div class="dialogButtons closeRight">' + b + '</div>'
    };
    I.btnEvt = function() {
        $("input", I.buttons).click(function() {
            var i = this.id.replace("dialogbtn", "");
            if (I.set.button[i] && I.set.button[i].callback) {
                if (I.set.cancel) I.close();
                if (typeof I.set.button[i].callback == 'function') {
                    I.set.button[i].callback()
                } else {
                    try {
                        eval('I.' + I.set.button[i].callback + '()')
                    } catch (e) {}
                }
            } else {
                I.close()
            }
        });
        $(".closeRight", I.obj).each(function(i, o) {
            o.oncontextmenu = function() {
                return false
            };
            o.ondragstart = function() {
                return false
            };
            o.onselectstart = function() {
                return false
            };
            o.onbeforecopy = function() {
                return false
            }
        })
    };
    I.titEvt = function() {
        if (!I.title[0]) return;
        I.bg.click(function() {
            I.title.fadeOut(50).fadeIn(50).fadeOut(50).fadeIn(50).fadeOut(50).fadeIn(50)
        });
        $(".dialogTitle a", I.obj).click(I.close);
        I.titles.mousedown(function(e) {
            var o = I.body.offset();
            var a = e.clientX - o.left + 1;
            var b = e.clientY - o.top + 1;
            var l = 0,
                t = 0;
            doc.bind("mousemove", function(e) {
                l = e.clientX - a;
                t = e.clientY - b;
                l = l < 0 ? 0 : l;
                t = t < 0 ? 0 : t;
                I.body.css({
                    left: l,
                    top: t
                })
            }).mouseup(function() {
                doc.unbind("mousemove").unbind("mouseup")
            })
        })
    };
    I.timeEvt = function() {
        if (I.set.time <= 0) return;
        var o, s;
        if (I.titles[0]) {
            s = I.titles.text();
            if (s && s.indexOf('{time}') < 0) s += ' - [{time}]'
        }
        if (I.set.timeObj) o = $(I.set.timeObj, I.obj);

        function loop() {
            if (s) I.titles.html(s.replace("{time}", I.set.time));
            if (I.set.timeObj && o) o.html(I.set.time);
            if (I.set.time <= 0) {
                clearInterval(I.loopObj);
                I.ok()
            }
            I.set.time--
        }
        loop();
        I.loopObj = setInterval(loop, 1000)
    };
    I.ok = function() {
        I.close();
        if (typeof(I.set.callback) == "function") I.set.callback()
    };
    I.close = function() {
        if (I.set.time > 0) clearInterval(I.loopObj);
        I.obj.fadeOut(I.set.fade, function() {
            if (typeof(I.set.closebefore) == "function") I.set.closebefore();
            I.obj.remove();
            delete M.D[I.id];
            if (typeof(I.set.close) == "function") I.set.close()
        })
    };
    I.init();
    I.timeEvt();
    I.titEvt();
    I.btnEvt();
    if (typeof(I.set.success) == "function") I.set.success();
    if (I.set.type != 'loading') M.loadend()
};
var doingBar = function(objId, w, BASE) {
    if (!BASE) BASE = RIGHT || document.body;
    this.i = 0;
    this.ok = false;
    this.init = function() {
        w = w ? w : 300;
        var id = objId + "_" + Math.random().toString().replace(".", "");
        $("#" + objId).html('<div id="' + id + '" class="doingBar"><div class="doingBarBg"></div><div class="doingBarBody"></div><div class="doingBarNum">0%</div></div>');
        $("#" + id).css("width", w);
        this.bar = $("#" + id + " .doingBarBody", BASE);
        this.num = $("#" + id + " .doingBarNum", BASE)
    };
    this.add = function() {
        this.i++;
        if (this.i > this.allnum) return;
        w = this.i / this.allnum * 100;
        this.bar.css("width", w + "%");
        this.num.text(parseInt(w) + "%");
        if (this.i == this.allnum) {
            this.ok = true;
            if (typeof(this.callback) == "function") {
                this.callback(this)
            }
        }
    };
    this.init()
};
var Fun = new function() {
    var $evt = ['init', 'begin'],
        $evted = {},
        $added = {};
    var I = {
        add: function(k, f, i) {
            if ($.inArray(k, $evt) >= 0 && $evted[k]) {
                f()
            } else {
                if (!I.list[k]) I.list[k] = [];
                if (i) {
                    if (!$added[k]) $added[k] = {};
                    if ($added[k][i]) {
                        return 0
                    }
                    $added[k][i] = 1
                }
                I.list[k].push(f)
            }
            return 1
        },
        del: function(k, re) {
            var del = function(i) {
                delete I.list[i];
                delete $added[i]
            };
            if (re) {
                $.each(I.list, function(i, o) {
                    re = new RegExp(k);
                    if (re.test(i)) del(i)
                })
            } else {
                del(k)
            }
            return 1
        },
        list: {},
        exec: function(k, p1, p2, p3) {
            if (!k) return;
            if ($.inArray(k, $evt) >= 0) $evted[k] = 1;
            I.stop = 0;
            var arr = I.list[k];
            if (typeof arr != 'object' || !arr || !arr.length) return;
            $.each(arr, function(i, f) {
                if (typeof f != 'function') return;
                try {
                    f(p1, p2, p3)
                } catch (e) {
                    if (typeof console != 'undefined') console.log('Fun.exec(' + k + ',' + p1 + ',' + p2 + ',' + p3 + ')', e)
                }
            });
            return I.stop
        }
    };
    return I
};
$.fn.menu = function(haschild, Hover, time) {
    var css = this.selector;
    css = "<style>" + css + " ul," + css + " li{margin:0;padding:0;list-style:none;}" + css + " ul li{position:relative;font-size:0;}" + css + " ul ul{position:absolute;top:0;z-index:99;border:1px solid #333;padding:2px;display:none;}" + css + " ul a{white-space:nowrap;display:block;}</style>";
    $(this).before(css);
    var o = $("li", this),
        self = this,
        a, w, h, child, t = 0;
    o.each(function() {
        if ($("ul", this)[0]) $("a:first", this).addClass(haschild)
    });
    time = time ? time : 0;
    o.mouseenter(function() {
        a = $("a:first", this);
        h = a.height();
        if (a.hasClass(haschild)) {
            a.addClass(haschild + Hover)
        } else {
            a.addClass(Hover)
        }
        w = $(this).parent().width();
        if (w > 300) {
            w = 0;
            top = h
        } else {
            top = 0
        }
        child = $("ul:first", this);
        child.css({
            "left": w,
            "top": top
        });
        var hh = $(window).height(),
            top = $(this).offset().top,
            ch = child.height(),
            cw = child.width();
        if (top + ch > hh) {
            top = top < ch ? -top : h - ch;
            child.css("top", top)
        }
        child.show(time);
        $("> li > a", child).width(cw - 40)
    });
    o.mouseleave(function() {
        a = $("a:first", this);
        if (a.hasClass(haschild + Hover)) {
            a.removeClass(haschild + Hover);
            a.addClass(haschild)
        } else {
            a.removeClass(Hover)
        }
        $("ul:first", this).hide(time)
    })
};
var Delay = function(f, t) {
    if (typeof f != "function") return;
    var o = setTimeout(f, t);
    this.clear = function() {
        clearTimeout(o)
    }
};

function int(n, err) {
    err = err || 0;
    if (typeof(n) == 'undefined') n = err;
    if (n) n = n.toString().replace(/[^\.0-9]/g, '');
    n = parseInt(n);
    if (isNaN(n)) n = err;
    return n
}
function arrSort(opt) {
    var set = {
        'arr': null,
        'copy': false,
        'type': 'num',
        'order': 'desc',
        'key': ''
    };
    if (!opt) return;
    set = $.extend(set, opt);
    if (set.copy) set.arr = clone(set.arr);
    var k = set.key;
    set.arr.sort(function(a, b) {
        if (set.type == 'str') {
            if (set.order == 'desc') {
                return ((b[k] < a[k]) ? -1 : ((b[k] > a[k]) ? 1 : 0))
            } else {
                return ((a[k] < b[k]) ? -1 : ((a[k] > b[k]) ? 1 : 0))
            }
        } else {
            if (set.order == 'desc') {
                return b[k] - a[k]
            } else {
                return a[k] - b[k]
            }
        }
    });
    return set.arr
}
function microtime() {
    return new Date().getTime()
}
function getDom(e) {
    e = e || window.event;
    if (!e.target) e.target = e.srcElement;
    return e.target
}
function number_format(n, len, p, s) {
    if (typeof n == 'undefined') n = 0;
    p = p || '.';
    s = typeof s == 'undefined' ? ',' : s;
    var xs = '';
    if (len > 0) {
        var x = Math.pow(10, len);
        n = Math.round(n * x) / x;
        x = '000000';
        n = n.toString();
        if (n.indexOf('.') >= 0) {
            var a = n.split('.');
            a[1] += x;
            n = a[0];
            xs = p + a[1].substring(0, len)
        } else {
            xs = p + x.substring(0, len)
        }
    } else {
        n = Math.round(n).toString()
    }
    if (!s || !n || n.length < 4) return n + xs;
    var fh = n.charAt(0) == '-' ? '-' : '';
    if (fh) n = n.replace('-', '');
    var l = n.length - 1,
        i, r = n.charAt(l);
    for (i = 1; i <= l; i++) {
        if (i % 3 == 0) r = s + r;
        r = n.charAt(l - i) + r
    }
    return fh + r + xs
}
function setNum(n, len) {
    return number_format(n, len)
}
function get(n, l) {
    l = (l ? l : location.search).replace('?', '&');
    var k = '&' + n + '=';
    if (l && l.indexOf(k) >= 0) {
        l = l.split('&' + n + '=')[1];
        if (l) l = l.split('&')[0]
    } else {
        l = ''
    }
    if (l && l.indexOf('#') >= 0) l = l.split('#')[0];
    return l
}
function getPar(n, l) {
    return get(n, l)
}
function loadEditor(id, name, value, opt, cb) {
    if (!id) return;
    if (!VAR.editorCss) {
        JQ.body.append('<link type="text/css" rel="stylesheet" href="' + PATH.editor + 'themes/default/ueditor.css" />');
        VAR.editorCss = 1
    }
    if (!VAR.editorArr) VAR.editorArr = [];
    VAR.editorArr.push([id, name, value, opt, cb]);
    var exec = function(id, name, value, opt, cb) {
        if (value && value.indexOf(C.pagecut) > 0) value = value.replace(new RegExp(C.pagecut, 'g'), UEDITOR_CONFIG.pageBreakTag);
        var toolbar = opt && opt.toolbar ? opt.toolbar : "Basic";
        var option = {
            toolbars: UEDITOR_CONFIG['toolbars_' + toolbar],
            initialContent: value,
            minFrameHeight: 300,
            name: name,
            elementPathEnabled: toolbar == 'Article'
        };
        if (opt) {
            if (opt.height) opt.minFrameHeight = opt.height;
            option = extend(option, opt)
        }
        var editor = new baidu.editor.ui.Editor(option);
        editor.render(id);
        UEDITOR_CONFIG['editor_' + name] = editor;
        if (typeof cb == 'function') cb()
    };
    $.getScripts([PATH.editor + 'editor_config.js', PATH.editor + 'editor.js'], function() {
        if (typeof UEDITOR_CONFIG !== 'object') return;
        while (1) {
            var o = VAR.editorArr.shift();
            if (!o) break;
            exec(o[0], o[1], o[2], o[3], o[4])
        }
    })
}
function getEditor(name) {
    var s = UEDITOR_CONFIG['editor_' + name] ? UEDITOR_CONFIG['editor_' + name].getContent() : '';
    if (s && s.indexOf(UEDITOR_CONFIG.pageBreakTag) > 0) s = s.replace(new RegExp(UEDITOR_CONFIG.pageBreakTag, 'g'), C.pagecut);
    s = s == '<p><br /></p>' ? '' : s;
    return s
}
$.fn.setImg = function(w, h, url, f, e404) {
    var I = $(this),
        p = new Image(),
        ww, hh, pw, ph;
    p.onload = function() {
        I.hide().attr("src", url);
        I.show();
        pw = p.width;
        ph = p.height;
        p = null;
        if (!w || !h) return;
        var wBh = pw / ph;
        if (wBh >= w / h) {
            ww = pw >= w ? w : pw;
            hh = ww / wBh
        } else {
            hh = ph >= h ? h : ph;
            ww = hh * wBh
        }
        I.width(ww);
        I.height(hh);
        if (typeof f == 'function') f(hh, ww)
    };
    p.onerror = function(e) {
        url = e404 ? e404 : SKIN.img + '404.gif';
        I.hide().attr("src", url);
        I.show();
        p = null;
        I.width(30);
        I.height(30);
        if (typeof f == 'function') f()
    };
    p.src = url
};
$.fn.view = function(w, h, click, obj) {
    w = w ? w : 500;
    h = h ? h : w;
    var I, s, d, p, pos, t, l, doc = $(document),
        win = $(window),
        ws = win.width(),
        hs = win.height(),
        off = obj && obj.offset() ? obj.offset() : {
            'left': 0,
            'top': 0
        };
    this.mouseenter(function(e) {
        if (d) d.clear();
        I = $(this);
        s = I.attr("view");
        d = new Delay(function() {
            if (p) p.remove();
            $(document.body).append('<img style="background:#fff;display:none;position:absolute;z-index:999999;border:2px solid #999" src="' + s + '" id="viewTemp" onclick="$(this).remove()" />');
            p = $("#viewTemp");
            p.setImg(w, h, s, function(hh, ww) {
                move(e, hh, ww);
                I.mousemove(function(e) {
                    move(e, hh, ww)
                })
            })
        }, 100)
    });
    this.mouseleave(function() {
        if (d) d.clear();
        if (p) p.remove();
        I.unbind('mousemove')
    });

    function move(e, hh, ww) {
        var sl = doc.scrollLeft(),
            st = doc.scrollTop();
        l = e.clientX + sl + 15;
        t = e.clientY + st + 15;
        l = l > sl + ws - ww ? l - ww - 35 : l;
        t = t > st + hs - hh ? t - hh - 15 : t;
        p.css({
            top: t + off.top,
            left: l + off.left
        })
    }
    if (click) this.click(function() {
        window.open(s)
    })
};
(function($) {
    var printAreaCount = 0;
    var removePrintArea = function(id) {
        $("iframe#" + id).remove()
    };
    $.fn.printArea = function() {
        var ele = $(this);
        var idPrefix = "printArea_";
        removePrintArea(idPrefix + printAreaCount);
        printAreaCount++;
        var iframeId = idPrefix + printAreaCount;
        var iframeStyle = 'position:absolute;width:1px;height:1px;left:-100px;top:-100px;';
        iframe = document.createElement('IFRAME');
        $(iframe).attr({
            style: iframeStyle,
            id: iframeId
        });
        document.body.appendChild(iframe);
        var doc = iframe.contentWindow.document;
        $(document).find("link").filter(function() {
            return $(this).attr("rel").toLowerCase() == "stylesheet" && $(this).attr("href").indexOf('style.css') < 0
        }).each(function() {
            doc.write('<link type="text/css" rel="stylesheet" href="' + $(this).attr("href") + '" >')
        });
        doc.write('<div class="' + $(ele).attr("class") + '">' + $(ele).html() + '</div>');
        doc.close();
        var frameWindow = iframe.contentWindow;
        frameWindow.close();
        frameWindow.focus();
        setTimeout(function() {
            $('.noPrint', doc).remove();
            $('.forPrint', doc).show();
            frameWindow.print()
        }, 100)
    }
})(jQuery);
var Page = function(par, id) {
    var I = this;
    I.id = id;
    I.$page = 1;
    I.$size = 15;
    I.$group = 10;
    I.$all = 0;
    I.$url = 'P.go({page},' + id + ')';
    I.$callback = '';
    I.set = function(k, v) {
        if (typeof k == 'object') {
            $.each(k, function(i, o) {
                I['$' + i] = o
            })
        } else {
            I['$' + k] = v
        }
    };
    if (par) I.set(par);
    I.ref = I.go = function(p) {
        p = parseInt(p ? p : I.$page);
        if (isNaN(p)) p = 1;
        if (p < 0) return;
        if (typeof I.$callback == 'function') I.$callback(p)
    };
    I.getObj = function(s) {
        s = s || 0;
        var gOn, begin, end, on = I.$page,
            url = I.$url,
            gsize = I.$group;
        var p = {
            all: I.$all,
            size: I.$size,
            count: Math.ceil(I.$all / I.$size),
            on: on,
            first: '',
            back: '',
            next: '',
            last: '',
            change: '',
            body: []
        };
        I.$count = p.count;
        if (s) {
            begin = Math.max(on - gsize / 2, 1);
            end = Math.min(on + gsize / 2, p.count)
        } else {
            gOn = Math.ceil(on / gsize);
            begin = (gOn - 1) * gsize + 1;
            end = gOn * gsize
        }
        if (gOn && gOn > 1) p.body.push({
            'url': url.replace('{page}', on - gsize),
            'page': '...',
            'css': ' class="backgroup"'
        });
        for (i = begin; i <= end; i++) {
            if (i > p.count) break;
            p.body.push({
                'url': url.replace('{page}', i),
                'page': i,
                'css': i == on ? ' class="on"' : ''
            })
        }
        if (gOn && gOn < Math.ceil(p.count / gsize)) {
            n = on + gsize;
            n = n > p.count ? p.count : n;
            p.body.push({
                'url': url.replace('{page}', n),
                'page': '...',
                'css': ' class="nextgroup"'
            })
        }
        if (on > 1) {
            p.first = url.replace('{page}', 1);
            p.back = url.replace('{page}', on - 1)
        }
        if (on < p.count) {
            p.next = url.replace('{page}', on + 1);
            p.last = url.replace('{page}', p.count)
        }
        if (typeof I.change == 'function') p.change += I.change();
        return p
    }
};
var P = {
    i: 0,
    o: {},
    set: {},
    init: function(par, id) {
        if (typeof id == 'undefined') id = P.i++;
        var o = new Page(par, id);
        P.o[id] = o;
        return o
    },
    go: function(p, i) {
        i = i || 0;
        P.o[i].go(p)
    },
    ref: function(p, i) {
        i = i || 0;
        P.o[i].ref(p)
    },
    getObj: function(t, i) {
        i = i || 0;
        if (i == 0) P.o[0].set(P.set);
        return P.o[i].getObj(t)
    }
};
P.init();
var $D = {
    timezone: '',
    _diff: 0,
    date: function(str, d, local) {
        var tz;
        if (typeof d == 'undefined' || !d) {
            d = new Date();
            tz = 1
        } else if (typeof d != 'object') {
            d = new Date(parseInt(d) * 1000);
            tz = 1
        }
        if (tz && $D.timezone && !local) {
            tz = d.getTimezoneOffset() - $D.timezone.replace('ETC/GMT', '') * 60;
            d.setMinutes(d.getMinutes() + tz)
        }
        d = new $D.obj(d);

        function f(k) {
            var i = d[k];
            return new RegExp('m|d|H|i|s').test(k) && i < 10 ? '0' + i : i
        }
        return (str || 'Y-m-d H:i:s').replace(new RegExp('Y|y|m|d|H|i|s|w', 'g'), f)
    },
    time: function(m, d) {
        var diff = $D._diff;
        if (d) diff = 0;
        d = d ? d : new Date();
        var t = d.getTime() / 1000;
        if (!m) t = parseInt(t);
        return t + diff
    },
    diff: function(n, s, def) {
        var t = def ? new Date(def.replace(/-/g, '/')) : new Date();
        if (typeof t != 'object') return t;
        t.setDate(t.getDate() + n);
        return $D.date(s, t)
    },
    strtotime: function(str, set, retdate, timezone) {
        set = set || 'Y-m-d H:i:s';
        set = set.replace('Y', 'YYYY').replace('y', 'YY').replace('m', 'mm').replace('d', 'dd').replace('H', 'HH').replace('i', 'ii').replace('s', 'ss');
        if (!str || str.length != set.length) return '';
        var i, l = set.length,
            o = {
                'Y': '',
                'm': '',
                'd': '',
                'H': '',
                'i': '',
                's': ''
            },
            k;
        for (i = 0; i < l; i++) {
            k = set.charAt(i);
            if (typeof o[k] != 'undefined') o[k] += str.charAt(i)
        }
        var y = new Date().getFullYear().toString();
        if (!o.Y) {
            o.Y = y
        } else if (o.Y.length == 2) {
            o.Y = y.substr(0, 2) + o.Y
        }
        if (o.m) o.m -= 1;
        var d = new Date(o.Y, o.m, o.d, o.H, o.i, o.s);
        if ($D.timezone && timezone) {
            var tz = d.getTimezoneOffset() - $D.timezone.replace('ETC/GMT', '') * 60;
            d.setMinutes(d.getMinutes() - tz)
        }
        if (retdate) return d;
        return $D.time(0, d)
    },
    obj: function(d) {
        d || (d = new Date());
        this.Y = d.getFullYear();
        this.y = d.getFullYear().toString().substr(2, 2);
        this.m = d.getMonth() + 1;
        this.d = d.getDate();
        this.H = d.getHours();
        this.i = d.getMinutes();
        this.s = d.getSeconds();
        this.w = d.getDay()
    },
    back: function(str, now, Y, m, d, H, i, s) {
        if (now && typeof now == 'object') return $D.format(str, now);
        var t = now < 1356969600 ? now : Date.parse(new Date(Y, m - 1, d, H || 0, i || 0, s || 0)) / 1000 - now;
        var r = {};
        if (t <= 0) return t;
        r.d = parseInt(t / 86400);
        t %= 86400;
        r.H = parseInt(t / 3600);
        t %= 3600;
        r.i = parseInt(t / 60);
        r.s = t % 60;
        if (!str) return r;
        return $D.format(str, r)
    },
    format: function(s, r) {
        if (!s) return '';
        return s.replace(/d|H|i|s/g, function(k) {
            if (k != 'd' && r[k] < 10) r[k] = '0' + r[k];
            return r[k]
        })
    }
};

function getPosition(e, e2) {
    var x = 0,
        y = 0;
    while (e != null) {
        x += e.offsetLeft;
        y += e.offsetTop;
        e = e.offsetParent;
        if (e2 && e2 == e) break
    }
    return {
        left: x,
        top: y
    }
}
var D = {
    i: 0,
    o: {},
    init: function(my, s, par) {
        D.i++;
        var p = {
            id: 'Calendar_' + D.i
        };
        p.obj = $(my);
        p.value = my.value;
        if (s) p.format = s;
        if (par) {
            if (typeof par == 'function') par = {
                'callback': par
            };
            $.extend(p, par)
        }
        D.lan();
        D.o[p.id] = new Calendar(p)
    },
    css: function() {
        var n = 'myCalendar';
        return '.' + n + '{background:#f4f4f4;border:1px solid #ccc;border-bottom:0px;border-collapse:collapse;position:absolute;z-index:99999;width:' + D.lang.width + 'px;color:#111}.' + n + ' *{word-break:keep-all}.' + n + ' a,.' + n + ' b{cursor:pointer;padding:2px 5px;font-family:"宋体";font-weight:normal}.' + n + ' table{margin:0;width:100%}.' + n + ' select{margin:0 1px}.' + n + ' a{cursor:pointer;border:1px solid #ccc;margin:0 5px}.' + n + ' td,.' + n + ' th{border-bottom:1px solid #ccc;padding:3px;text-align:center;height:auto}.' + n + ' th{background:#eee}.' + n + ' .m0,.' + n + ' .ed{background-color:#f4f4f4!important;color:#ccc!important}.' + n + ' .ed{cursor:default!important}.' + n + ' .m0,.' + n + ' .m1{cursor:pointer}.' + n + ' .on{background:url(' + vars.cdn + 'images/isright.gif) no-repeat right bottom #C8E9C8}.' + n + ' .at{background-color:#C8E9C8!important}.' + n + ' .today{font-weight:bold;color:#800;font-size:16px;padding:0}.' + n + ' .wk0,.' + n + ' .wk6{color:red}.' + n + ' .hover{background-color:#ccc}.' + n + ' input.err{border:1px solid red}.' + n + ' .ck{backgrond-color:#C8E9C8}'
    },
    lan: function() {
        if (typeof lang_calendar == 'object' && typeof lang_calendar.week == 'object' && lang_calendar.week.length === 7) {
            D.lang = lang_calendar;
            var w = parseInt(D.lang.width) || 0;
            D.lang.width = Math.max(w, 188)
        }
    },
    lang: {
        'width': 188,
        'now': 'now',
        'close': '关闭',
        'ok': '确定',
        'today': '今日',
        'clear': '清空',
        'c0': '清零时间',
        'week': ['日', '一', '二', '三', '四', '五', '六']
    },
    pos: function(o) {
        if (!o || !o[0]) return {
            left: 0,
            top: 0
        };
        if (D.offset) {
            return o.offset()
        } else {
            return getPosition(o[0])
        }
    },
    setpos: function(I, opt) {
        var of = D.pos(opt.obj),
            wh = $(window).height(),
            ch = I.obj.outerHeight(),
            oh = opt.obj.outerHeight();
        if (of.top + ch - wh + oh > 0) {
            oh = of.top - ch
        } else {
            oh += of.top
        }
        I.obj.css({
            'left': of.left,
            'top': oh
        })
    }
};
var Calendar = function(par) {
    var I = this,
        opt = {
            'dom': '',
            'obj': '',
            'format': 'Y-m-d H:i:s',
            'value': '',
            'min': 1900,
            'max': 2100,
            'callback': null
        };
    I.$ = function(s) {
        return $(s, I.obj)
    };
    I.init = function() {
        if (par) $.extend(opt, par);
        I.date = new Date();
        I.mn = {
            'Y': [opt.min, opt.max],
            'y': [0, 99],
            'm': [0, 11],
            'H': [0, 23],
            'i': [0, 59],
            's': [0, 59]
        };
        I.id = opt.id;
        I.def();
        I.build()
    };
    I.def = function() {
        var s = opt.format,
            o = {
                'Y': 'yyyy',
                'y': 'yy',
                'm': 'mm',
                'd': 'dd',
                'H': 'HH',
                'i': 'ii',
                's': 'ss'
            },
            arr = ['Y', 'y', 'm', 'd', 'H', 'i', 's'],
            i;
        s = s.replace(new RegExp('Y|y|m|d|H|i|s', 'g'), function(k) {
            return o[k]
        });
        $.each(arr, function(i, k) {
            I[k] = opt.value.substring(s.indexOf(o[k][0]), s.lastIndexOf(o[k][0]) + 1);
            I[k]--;
            I[k]++;
            I['_' + k] = I[k]
        });
        if (!I.Y && I.y) I.Y = I.date.getFullYear().toString().substring(0, 2) + I.y;
        if (I.m >= 0) {
            I.m--;
            I._m--
        }
    };
    I.set = function(k, f) {
        I[k] = parseInt(I[k]);
        if (isNaN(I[k]) || I[k] < I.mn[k][0] || I[k] > I.mn[k][1]) I[k] = I.date['get' + f]();
        I.date['set' + f](I[k])
    };
    I.build = function() {
        var t = I.date,
            s, r, ts;
        I.set('Y', 'FullYear');
        I.set('m', 'Month');
        I.set('H', 'Hours');
        I.set('i', 'Minutes');
        I.set('s', 'Seconds');
        t.setDate(1);
        s = '<style>' + D.css() + '</style><table><tr><td><b fn="back">&lt;</b></td><td colspan="5">' + I.select('Y', t) + '-' + I.select('m', t) + '</td><td><b fn="next">&gt;</b></td></tr><tr>';
        ts = opt.format.indexOf('H') > 0 ? '<tr><td colspan="7"><b fn="c0" title="' + D.lang.c0 + '">x</b>' + I.select('H', t) + ':' + I.select('i', t) + ':' + I.select('s', t) + '<b fn="now">' + D.lang.now + '</b></td></tr>' : '';
        var d = I.date.getDay();
        if (opt.double) {
            I.num = 36
        } else {
            I.num = new Date(I.Y, I.m + 1, 0).getDate() + d
        }
        if (d > 0) t.setDate(1 - d);
        $.each(D.lang.week, function(i, o) {
            s += '<th>' + o + '</th>'
        });
        s += '</tr>';
        I.No = 0;
        r = I.builds();
        while (r) {
            if (I.No > 140) break;
            if (r.w == 0) s += '<tr>';
            var c = r.m == I.m ? 'm1' : 'm0';
            c += ' wk' + r.w;
            s += '<td class="' + c + '" d="' + r.Y + '_' + r.m + '_' + r.d + '">' + r.d + '</td>';
            if (r.w == 6) s += '</tr>';
            t.setDate(r.d + 1);
            I.No++;
            r = I.builds(r.w == 6)
        }
        s += ts;
        if (!opt.double) s += '<tr><td colspan="7"><b fn="clear">' + D.lang.clear + '</b><b fn="today">' + D.lang.today + '</b><b fn="ok">' + D.lang.ok + '</b><b fn="close">' + D.lang.close + '</b></td></tr>';
        s += '</table>';
        I.obj = $('#' + I.id);
        if (!I.obj[0]) {
            (opt.dom || $(document.body)).append('<div class="myCalendar" id="' + I.id + '">' + s + '</div>');
            I.obj = $('#' + I.id);
            if (opt.dom) {
                I.obj.css({
                    'left': opt.oi == 2 ? I.obj.outerWidth() + 5 : 0,
                    'top': 0
                })
            } else {
                D.setpos(I, opt)
            }
            I.obj.mouseenter(function() {
                I.on = 1
            }).mouseleave(function() {
                I.on = 0
            })
        } else {
            I.obj.html(s)
        }
        I.$('.m0,.m1').click(I.ok).mouseenter(function() {
            $(this).addClass('hover')
        }).mouseout(function() {
            $(this).removeClass('hover')
        });
        I.$('[fn]').click(function() {
            var fn = $(this).attr('fn');
            if (typeof I[fn] == 'function') I[fn](this)
        });
        I.$('select').change(I.onchange);
        I.$('[d="' + I._Y + '_' + I._m + '_' + I._d + '"]').addClass('on');
        t = new Date();
        I.$('[d="' + t.getFullYear() + '_' + t.getMonth() + '_' + t.getDate() + '"]').addClass('today');
        if (opt.double) {
            if (typeof opt.callback == 'function') opt.callback(opt.oi, true, I.obj, I);
            return
        }
        setTimeout(function() {
            $(document.body).bind('click', I.closes)
        }, 100)
    };
    I.builds = function(br) {
        var t = I.date;
        if (br && I.No >= I.num) return;
        var ret = {
            'Y': t.getFullYear(),
            'm': t.getMonth(),
            'd': t.getDate(),
            'w': t.getDay()
        };
        return ret
    };
    I.select = function(s, t) {
        var i, r = '<select name="' + s + '">',
            def = $D.date(s, t),
            v;
        for (i = I.mn[s][0]; i <= I.mn[s][1]; i++) {
            v = s == 'm' ? i + 1 : i;
            if (v < 10) v = '0' + v;
            r += '<option value="' + i + '"' + (v == def ? ' selected="true"' : '') + '>' + v + '</option>'
        }
        return r + '</select>'
    };
    I.onchange = function() {
        I[this.name] = this.value;
        I.build()
    };
    I.input = function() {
        var i = this;
        if (I._input) clearTimeout(I._input);
        I._input = setTimeout(function() {
            var n = i.name,
                v = parseInt(i.value);
            if (isNaN(v) || !I.mn[n] || v < I.mn[n][0] || v > I.mn[n][1]) {
                i.focus();
                i.className = 'err';
                return
            }
            if (n == 'm') v--;
            I[n] = v;
            I.build()
        }, 500)
    };
    I.back = function() {
        I.m--;
        if (I.m < 0) {
            I.Y--;
            I.m = 11
        }
        I.build()
    };
    I.next = function() {
        I.m++;
        if (I.m > 11) {
            I.Y++;
            I.m = 0
        }
        I.build()
    };
    I.clear = function() {
        opt.obj.val('');
        I.close()
    };
    I.today = function() {
        I.date = new Date();
        I.Y = '';
        I.m = '';
        I.build()
    };
    I.now = function() {
        I.date = new Date();
        I.Y = '';
        I.m = null;
        I.H = '';
        I.i = '';
        I.s = '';
        I.build()
    };
    I.c0 = function() {
        I.date = new Date();
        I.Y = '';
        I.m = null;
        I.H = 0;
        I.i = 0;
        I.s = 0;
        I.build()
    };
    I.fmt = function(d, d2) {
        d = d.split('_');
        return $D.date(opt.format, new Date(d[0], d[1], d[2], d2 ? 0 : I.H, d2 ? 0 : I.i, d2 ? 0 : I.s))
    };
    I.ok = function() {
        var my = this,
            d = $(my).attr('d');
        if ($(my).hasClass('ed')) return;
        d = d && typeof d == 'string' ? d : I.$('.on').attr('d');
        if (!d) {
            d = new $D.obj();
            d = d.Y + '_' + (d.m - 1) + '_' + d.d
        }
        var ret = I.fmt(d),
            cb = function() {
                if (typeof opt.callback == 'function') return opt.callback(opt.oi, ret, my, I)
            };
        if (opt.double) {
            if (cb()) {
                var a = d.split('_');
                I.d = I._d = a[2];
                if (I.Y != a[0] || I.m != a[1]) {
                    I.Y = I._Y = a[0];
                    I.m = I._m = a[1];
                    I.build();
                    I.$('[d="' + d + '"]').addClass('on')
                } else {
                    I.$('.on').removeClass('on');
                    $(my).addClass('on')
                }
            }
        } else {
            opt.obj.val(ret);
            I.close();
            cb()
        }
    };
    I.closes = function() {
        if (I.on) return;
        $(document.body).unbind('click', I.closes);
        I.close()
    };
    I.close = function() {
        I.obj.remove();
        delete D.o[I.id]
    };
    I.init()
};
D.init2 = function(my, n1, n2, par) {
    var c = {
        andstr: ' ~ ',
        format: 'Y-m-d H:i:s',
        callback: ''
    };
    if (par) $.extend(c, par);
    var id, $on, o = {
            0: $(my).find('[name="' + n1 + '_' + n2 + '"]'),
            1: $(my).find('[name="' + n1 + '"]'),
            2: $(my).find('[name="' + n2 + '"]')
        },
        $v = {
            1: o[1].val(),
            2: o[2].val()
        },
        _init = function() {
            D.i++;
            D.lan();
            id = 'Calendar2_' + D.i;
            var s = '<div id="' + id + '" style="position:absolute;background:#fff;z-index:9999;border:1px solid #ccc;padding:5px">';
            s += '<div id="' + id + '_obj" style="position:relative"></div>';
            s += '<div style="position:relative;text-align:center;padding-top:5px" id="' + id + '_btn"><div style="position:absolute;left:5px;top:10px"><a fn="clear">[' + D.lang.clear + ']</a></div><input type="button" fn="ok" value="' + D.lang.ok + '" style="padding:5px 10px" /></div>';
            s += '</div>';
            $(document.body).append(s);
            D.setpos({
                obj: $('#' + id)
            }, {
                obj: o[0]
            });
            $('#' + id + '_btn [fn]').click(function() {
                var fn = $(this).attr('fn');
                if (typeof _fn[fn] == 'function') _fn[fn](this)
            });
            $('#' + id).mouseenter(function() {
                $on = 1
            }).mouseleave(function() {
                $on = 0
            });
            setTimeout(function() {
                $(document.body).bind('click', _close)
            }, 100);
            par = {
                dom: $('#' + id + '_obj'),
                format: c.format,
                double: 1,
                callback: _callback,
                oi: 1
            };
            D.init(o[1][0], '', par);
            par.oi = 2;
            D.init(o[2][0], '', par);
            _val()
        },
        _fn = {
            clear: function() {
                $v[1] = $v[2] = '';
                _fn.ok()
            },
            ok: function() {
                var v = _val();
                _del();
                if (typeof c.callback == 'function') c.callback(v, my)
            }
        },
        _callback = function(nid, val, at, I) {
            if (val === true) {
                if (nid == 2) {
                    par.dom.width(I.obj.outerWidth() * 2 + 5);
                    par.dom.height(I.obj.outerHeight())
                }
                if ($v[nid]) {
                    var t = $D.strtotime($v[nid], c.format, false, true),
                        Y = $D.date('Y', t),
                        m = parseInt($D.date('m', t)) - 1,
                        d = parseInt($D.date('d', t));
                    at = at.find('[d="' + Y + '_' + m + '_' + d + '"]');
                    if (Y == I.Y && m == I.m && at[0]) {
                        at.click()
                    } else if ($v[1] && $v[2]) {
                        _sta(I)
                    }
                }
            } else {
                var old = $v[nid];
                $v[nid] = val;
                if ($v[1] && $v[2]) {
                    if ($v[1] > $v[2]) {
                        $v[nid] = old;
                        return false
                    }
                    _sta(I)
                }
                return true
            }
        },
        _sta = function(I) {
            var rl = par.dom.find('.myCalendar');
            rl.find('.ed').removeClass('ed');
            rl.find('.at').removeClass('at');
            rl.eq(0).find('[d]').each(function(i, o) {
                var d = I.fmt($(o).attr('d'), true);
                if ($v[1] <= d && d <= $v[2]) {
                    $(o).addClass('at')
                } else if (d > $v[2]) {
                    $(o).addClass('ed')
                }
            });
            rl.eq(1).find('[d]').each(function(i, o) {
                var d = I.fmt($(o).attr('d'), true);
                if ($v[1] <= d && d <= $v[2]) {
                    $(o).addClass('at')
                } else if (d < $v[1]) {
                    $(o).addClass('ed')
                }
            })
        },
        _val = function() {
            var v = $v[1] && $v[2] ? $v[1] + c.andstr + $v[2] : '';
            o[0].val(v);
            o[1].val($v[1]);
            o[2].val($v[2]);
            return v
        },
        _del = function() {
            o[0].removeAttr('Calendar2');
            $('#' + id).remove()
        },
        _close = function() {
            if ($on) return;
            $(document.body).unbind('click', _close);
            _del()
        };
    if (o[0].attr('Calendar2')) return;
    o[0].attr('Calendar2', 1);
    _init()
};

function cookie(key, value, options) {
    if (arguments.length > 1 && String(value) !== "[object Object]") {
        options = options && typeof options == 'object' ? options : {};
        if (value === null || typeof(value) == 'undefined') options.expires = -1;
        if (typeof options.expires === 'number') {
            var days = options.expires,
                t = options.expires = new Date();
            t.setDate(t.getDate() + days)
        }
        if (typeof options.time === 'number') {
            var s = options.time,
                t = options.expires = new Date();
            t.setSeconds(t.getSeconds() + s)
        }
        if (options.time == 'day') {
            t = options.expires = new Date();
            t.setDate(t.getDate() + 1);
            t.setHours(0);
            t.setMinutes(0);
            t.setSeconds(0)
        }
        value = String(value);
        return (document.cookie = [encodeURIComponent(key), '=', options.raw ? value : encodeURIComponent(value), options.expires ? ';expires=' + options.expires.toUTCString() : '', options.path ? ';path=' + options.path : '', options.domain ? ';domain=' + options.domain : '', options.secure ? ';secure' : ''].join(''))
    }
    options = value || {};
    var result, decode = options.raw ?
        function(s) {
            return s
        } : decodeURIComponent;
    return (result = new RegExp('(?:^|; )' + encodeURIComponent(key) + '=([^;]*)').exec(document.cookie)) ? decode(result[1]) : null
}
function replaceVars(s, o) {
    var v = o ? $.extend(clone(o), vars) : vars,
        n;
    if (s && (typeof s == 'string') && v) {
        var re = s.match(/\{\$.*?\$\}/g);
        if (re) {
            $.each(re, function(i, o) {
                i = o.replace('{$', '').replace('$}', '');
                n = evals(v, i);
                if (typeof n == 'string' || typeof n == 'number') s = s.replace(o, n);
                try {
                    n = eval(i);
                    if (typeof n == 'string' || typeof n == 'number') s = s.replace(o, n)
                } catch (e) {}
            })
        }
    }
    return s
}
function evals(d, k) {
    if (!d || !k) return;
    if (k.indexOf('.') >= 0) {
        var s = k.split('.')[0];
        return evals(d[s], k.replace(s + '.', ''))
    } else {
        return d[k]
    }
}
var Tpl = Dream = function(obj, $node) {
    var I = this;
    I.obj = obj;
    I.tpl = typeof obj == 'object' ? obj.html() : '';
    I.content = '';
    I.data = {};
    I.config = '';
    I.funBase = '';
    I.before = function() {
        if (!I.tpl) return;
        _repair();
        var s = I.tpl;
        s = s.replace(/{([^$}]*)}/g, '');
        s = s.replace(/{([^}]*)}(.*?){\/\1}/g, '');
        I.obj.html(s)
    };
    I.exec = function() {
        if (!I.tpl) {
            if (typeof console == 'object') console.trace('#Error:tpl is empty!');
            return false
        }
        _repair();
        I.tpl = I.tpl.replace(new RegExp('<!---', 'g'), '@L@').replace(new RegExp('--->', 'g'), '@R@');
        I.tpl = I.tpl.replace(new RegExp('<!--', 'g'), '').replace(new RegExp('-->', 'g'), '');
        I.tpl = I.tpl.replace(new RegExp('@L@', 'g'), '<!---').replace(new RegExp('@R@', 'g'), '--->');
        _script();
        I.content = _reLabel(I.tpl, I.data);
        I.content = I.content.replace(/DKHL/g, '{').replace(/DKHR/g, '}');
        I.content = replaceVars(I.content) + $script;
        return true
    };
    I.fetch = function() {
        if (I.exec()) {
            return I.content
        } else {
            return ''
        }
    };
    I.node = function() {
        $node = arguments
    };
    I.display = function(opt) {
        if ($node) return _node();
        if (opt && opt.data) {
            _page(opt)
        } else {
            if (I.append && I.appendx) {
                I.obj.append(I.fetch())
            } else {
                I.obj.html(I.fetch());
                if (I.append && !I.appendx) I.appendx = 1
            }
        }
    };
    I.check = function(ret, cb) {
        if (!ret || !ret.ok) {
            cb = typeof cb == 'function' ? cb : function(e) {
                M.err(e)
            };
            if (ret && ret.msg) cb(ret.msg);
            return false
        }
        return true
    };
    I.reset = function() {
        I.appendx = 0
    };
    var _node = function() {
        I.$nodeTpl = I.$nodeTpl || {};
        var obj, base = I.obj;
        $.each($node, function(i, sel) {
            if (i == 0 && typeof sel == 'object') {
                base = sel;
                return
            }
            obj = $(sel, base);
            if (typeof I.$nodeTpl[sel] == 'undefined') I.$nodeTpl[sel] = obj.html();
            I.tpl = I.$nodeTpl[sel];
            obj.html(I.fetch())
        })
    };
    var _tm, _fn = function() {
        if (_tm) clearTimeout(_tm);
        _tm = setTimeout(function() {
            var min = int(I.scroll.min) || 10,
                n = I.obj.height() - I.scroll.obj.scrollTop() - I.scroll.obj.height() + int(I.append);
            if (n <= min && I.appendx < I.pg2.$count) I.pg2.go(++I.appendx)
        }, 200)
    };
    var _page = function(opt) {
        I.data = opt.data;
        if (opt.funBase) I.funBase = opt.funBase;
        var p = opt.pageSet;
        if (p && (p.callback || opt.funPage)) {
            if (!p.page) p.page = 1;
            if (opt.funPage) p.callback = opt.funPage;
            if (!I.pg || !I.pg2) {
                var o = p.sel;
                if (typeof o == 'string') o = $(o, I.obj);
                I.pg = new Tpl(o);
                I.pg.tpl = p.tpl || o.html();
                if (!I.pg.tpl) {
                    var s = '',
                        lan = p.lan || lang.page || ['', '', '', '', ''];
                    if (lan[4]) s += lan[4];
                    if (lan[0] !== false) s += '<a href="javascript:{p.first}" class="page_first">' + lan[0] + '</a>';
                    if (lan[1] !== false) s += '<a href="javascript:{p.back}" class="page_back">' + lan[1] + '</a>';
                    s += '{p.body}<a href="javascript:{url}"{css}>{page}</a>{/p.body}';
                    if (lan[2] !== false) s += '<a href="javascript:{p.next}" class="page_next">' + lan[2] + '</a>';
                    if (lan[3] !== false) s += '<a href="javascript:{p.last}" class="page_last">' + lan[3] + '</a>';
                    I.pg.tpl = s
                }
                I.pg2 = P.init(p, p.poid)
            } else {
                I.pg2.set(p)
            }
            I.pg.data.p = I.pg2.getObj()
        }
        I.display();
        if (I.pg && p) {
            if (typeof p.sel == 'string') I.pg.obj = $(p.sel, I.obj);
            I.pg.display();
            $('a[href="javascript:"]', I.pg.obj).addClass('nopage')
        }
        if (I.append && I.appendx === 1 && I.scroll && I.scroll.obj && I.pg && I.pg.obj) {
            I.pg.obj.hide();
            I.scroll.obj.unbind('scroll', _fn).scroll(_fn)
        }
    };
    var $script, _script = function() {
        $script = '';
        if (!I.script) return;
        var fn = function(k) {
            var re = new RegExp('<script tpl="' + k + '">(.*?)<\/script>', 'g'),
                e = I.tpl.match(re),
                s = '';
            if (!e) return s;
            $.each(e, function(i, o) {
                I.tpl = I.tpl.replace(o, '');
                s += o
            });
            return s
        };
        var s = fn('before');
        if (s) I.obj.append(s);
        $script = fn('after')
    };
    var _getDb = function(d, k) {
        if (!d || !k) return '';
        if (k == '[index]') return d;
        if (k.indexOf('.') > 0) {
            var s = k.split('.')[0];
            return _getDb(d[s], k.replace(s + '.', ''))
        } else {
            if (typeof d[k] == 'string' && d[k] != '') d[k] = d[k].replace(/\{/g, 'DKHL').replace(/\}/g, 'DKHR');
            return d[k]
        }
    };
    var _par = function(p) {
        if (!p) return ['', ''];
        if (p.indexOf(':') > 0) return _pars(p);
        var o = p && p.indexOf(',') ? p.split(',') : [p];
        return [o[0], o]
    };
    var _pars = function(p) {
        var ret = {},
            arr = p && p.indexOf(',') ? p.split(',') : [p];
        $.each(arr, function(k, v) {
            if (v && v.indexOf(':') > 0) {
                v = v.split(':');
                ret[v[0]] = v[1]
            } else {
                ret[k] = v
            }
        });
        return [arr[0], ret]
    };
    var _repair = function() {
        I.tpl = I.tpl.replace(new RegExp("\r?\n", "g"), "").replace(new RegExp("\t", "g"), "").replace(new RegExp('}="">', 'g'), '}>').replace(new RegExp('%7B', 'g'), '{').replace(new RegExp('%7D', 'g'), '}');
        var ie = navigator.userAgent.indexOf("MSIE") > 0 ? /(\s+\w+=)('|")?(.*?)('|")?(?=\s+\w+=|\s*>|\s*\/>)/gi : "";
        if (ie) {
            I.tpl = I.tpl.replace(ie, "$1\"$3\"");
            I.tpl = I.tpl.replace(/\s\{css\}\">/g, ' {css}>')
        }
    };
    var _reLabel = function(tpl, rs, child) {
        tpl = _reLabels(tpl, rs);
        var re = /{([^$}]*)}/g,
            e = tpl.match(re),
            s = '',
            f, par, arr, val;
        if (!e) return tpl;
        $.each(e, function(i, o) {
            if (tpl.indexOf(o) < 0) return;
            s = o.replace(/^{|}$/g, '');
            if (s && s.indexOf('|') > 0) {
                arr = s.split('|');
                f = s.replace(arr[0] + '|', '');
                s = arr[0];
                if (f.indexOf('_') > 0) {
                    arr = f.split('_');
                    par = f.replace(arr[0] + '_', '');
                    f = arr[0]
                } else {
                    par = ''
                }
                if (typeof I.funBase == 'object' && typeof I.funBase[f] == 'function') {
                    f = I.funBase[f]
                } else {
                    if (f.indexOf('.') < 0 && I.funBase) f = I.funBase + '.' + f;
                    try {
                        eval('f=' + f)
                    } catch (e) {
                        console.log('[Tpl.reLabel]修饰函数错误', f, e)
                    }
                }
            } else {
                f = ''
            }
            val = _getDb(rs, s);
            val = typeof val == 'undefined' ? '' : val;
            if (typeof f == 'function') {
                par = _par(par);
                try {
                    val = f(val, rs, par[0], s, par[1], I)
                } catch (e) {
                    if (typeof SYS === 'object' && typeof SYS.log === 'function') {
                        SYS.log(e + '#' + val + '#' + f.toString(), 'jsErrLog')
                    }
                }
            }
            var num = 0;
            while (tpl.indexOf(o) >= 0 && o != val) {
                if (num++ > 5) break;
                tpl = tpl.replace(o, val)
            }
        });
        return tpl
    };
    var _reLabels = function(tpl, data) {
        var re = /{([^}]*)}(.*?){\/\1}/,
            e = tpl.match(re),
            s, d, No = 1,
            tmp, num = 0;
        while (e && e[1] && e[2]) {
            if (num++ > 10) break;
            s = '';
            d = _getDb(data, e[1]);
            d = typeof d == 'undefined' ? null : d;
            if (d) {
                if (typeof d == 'object') {
                    $.each(d, function(k, o) {
                        if (typeof o != 'object') o = {
                            'value': o
                        };
                        o.index = k;
                        o.No = No++;
                        tmp = _reLabel(e[2], o, 1);
                        if (tmp) {
                            if (tmp.indexOf('tpl.continue') > 0) return;
                            if (tmp.indexOf('tpl.break') > 0) return false
                        }
                        s += tmp
                    })
                } else {
                    s += _reLabel(e[2], d)
                }
            }
            if (s.indexOf('$&') >= 0) s = s.replace(/\$&/g, '$ &');
            tpl = tpl.replace(e[0], s);
            e = tpl.match(re)
        }
        return tpl
    }
};

function l(s, v) {
    if (s && v) {
        for (var k in v) {
            s = s.replace(new RegExp('#' + k, 'g'), v[k])
        }
    }
    return s ? s : ''
}
$.fn.display = function(v) {
    var s = $(this).html();
    $(this).html(replaceVars(s, v)).show()
};
var Form = function(id, obj) {
    var I = this;
    if (typeof id == 'object') {
        obj = id
    } else {
        obj = obj ? obj : document.body;
        obj = $(id, obj)
    }
    I.mesType = typeof APP == 'object' || typeof U == 'object' ? 'Msg' : '';
    I.mes = null;
    I.value = '';
    I.tip = $(document.body);
    I.editor = {};
    I.L = typeof L == 'object' ? L.form : {};
    I.getValue = function() {
        var t = '';
        I.load = {};
        I.data = {};
        I.input.each(function(i, o) {
            t = o.name;
            if (!t) t = $(o).attr('name');
            if (!t || I.load[t]) return true;
            if (t.indexOf('[]') > 0) {
                t = t.replace('[]', '');
                if (!I.data[t]) I.data[t] = [];
                var v, tp = $(o).attr('type');
                if (tp === 'radio' || tp === 'checkbox') {
                    v = $(o).is(':checked') ? $(o).val() : ''
                } else if (tp === 'div') {
                    v = $(o).html()
                } else {
                    v = $(o).val()
                }
                I.data[t].push($.trim(v))
            } else {
                I.data[t] = I.getVal($(o));
                I.load[t] = true
            }
        });
        var arr = [];
        $.each(I.data, function(n, v) {
            if (typeof v == 'object') {
                $.each(v, function(i, v2) {
                    arr.push(n + '[]=' + encodeURIComponent(v2))
                })
            } else {
                if (v) v = encodeURIComponent(v);
                arr.push(n + '=' + v)
            }
        });
        I.value = arr.join('&');
        return I.value
    };
    I.getVal = function(E) {
        var v = '',
            n = E.attr('name');
        if (E.hasClass('EDITOR')) {
            I.editor[n] = 1;
            v = getEditor(n)
        } else {
            switch (E.attr('type')) {
                case 'radio':
                    E = $('input[name="' + n + '"]:checked', obj);
                    v = E[0] ? E.val() : '';
                    break;
                case 'checkbox':
                    E = $('input[name="' + n + '"]:checked', obj);
                    $.each(E, function(i, o) {
                        v += o.value + ','
                    });
                    v = v ? v.replace(/,$/, '') : '';
                    break;
                case 'div':
                    v = E.html();
                    break;
                case 'button':
                    break;
                default:
                    v = E.val()
            }
        }
        return $.trim(v)
    };
    I.set = function(set) {
        $.each(set, function(i, o) {
            obj.find('[name="' + o[0] + '"]').attr(o[1], o[2])
        })
    };
    I.check = function(lock) {
        if (lock) {
            Msg.err('数据暂未加载完成，提交锁定中！');
            return false
        }
        I.suc = true;
        I.e1 = null;
        I.$e = null;
        $('.ckf').remove();
        var E = I.input,
            v = '',
            f = '',
            must;
        E.each(function(i, o) {
            if (I.mesType != '' && !I.suc) return true;
            o = $(o);
            I.now = o;
            f = o.attr('fn');
            must = o.attr('must');
            if (!f && !must) return true;
            v = I.getVal(o);
            if (must) {
                if (!v) {
                    I.err(must);
                    return true
                } else {
                    I.show('Ok')
                }
            }
            if (!f) return true;
            try {
                if (typeof I[f] == 'function') {
                    f = I[f]
                } else {
                    eval('f=' + f);
                    if (typeof f != 'function') return false
                }
                var fc = f(v, o);
                if (fc !== true) {
                    I.err(fc);
                    return true
                }
            } catch (e) {}
        });
        I.getValue();
        return I.suc
    };
    I.err = function(n, addx) {
        I.suc = false;
        var str = I.L;
        str = str[n] ? str[n] : n;
        var E = I.now,
            type = E[0].type;
        if (!I.$e) I.$e = E;
        if (!I.e1 && (type == 'text' || type == 'textarea')) I.e1 = E;
        if (typeof I.error == 'function') {
            I.error(str, I.e1)
        } else {
            switch (I.mesType) {
                case 'Msg':
                    Msg.err(str);
                    break;
                case 'M':
                    M.err(str);
                    break;
                case 'alert':
                    alert(str);
                    break;
                default:
                    I.show('Err', str, '', addx)
            }
        }
        if (I.e1) I.e1.focus()
    };
    I.show = function(css, str, obj, addx) {
        if (I.mesType != '') return;
        str = str ? str : '';
        if (obj) I.clear();
        var E = obj ? obj : I.now;
        var type = E[0].type;
        var pos = E.offset();
        var l = pos.left;
        var w = E.outerWidth();
        var hh = E.outerHeight();
        var h = hh < 22 ? 22 : hh;
        h -= 2;
        h = h > 22 ? 22 : h;
        var t = pos.top;
        addx = addx ? addx : 0;
        if (type == 'radio' || type == 'checkbox') {
            var n = E.length - 1;
            var x = $(E[n]).offset().left;
            n = n ? (x - l) / n * (n + 1) : 0;
            l += n
        } else {
            l = l + w + 10
        }
        l += addx;
        I.tip.append('<div class="ckf checkForm' + css + '" style="min-height:' + h + 'px;height:auto!important;height:' + h + 'px;left:' + (l - 5) + 'px;top:' + (t - 1) + 'px;font:normal 12px/' + h + 'px Aria">' + str + '</div>')
    };
    I.end = function(ret, fn) {
        try {
            eval('ret=' + ret)
        } catch (e) {
            return
        };
        if (ret.err) {
            var s = I.L[ret.err] || ret.err;
            s = l(s, [ret.limit, ret.length]);
            if (ret.name) {
                I.clear();
                var o = $('name=' + ret.name + ']', obj);
                if (o[0]) {
                    I.show('Err', s, o, ret.addx);
                    o.focus();
                    return
                }
            } else {
                alert(s)
            }
            return
        } else if (ret.ok && typeof fn == 'function') {
            fn()
        }
    };
    I.clear = function(c) {
        $('.ckf').remove();
        if (!c) return;
        $('[name=checkcode]').val('');
        refcheckcode()
    };
    I.checkFun = function(re, v, key) {
        if (v == '' || re.test(v)) {
            if (v) I.show('Ok');
            return true
        }
        I.err(key);
        return false
    };
    I.email = function(v, o) {
        if (o && !o.attr('must') && !v) return true;
        return I.checkFun(/^[\w\-\.]+@[\w\-]+\.[\w\-]+$/, v, 'email')
    };
    I.mobile = function(v, o) {
        if (o && !o.attr('must') && !v) return true;
        return I.checkFun(/^0?(13|15|18)\d{9}$/, v, 'mobile')
    };
    I.checkcode = function(v) {
        if (!v || !/^[a-zA-Z0-9]{4}$/.test(v)) {
            I.err('checkcode', 150);
            return false
        } else {
            return true
        }
    };
    I.suc = true;
    I.now = null;
    I.e1 = null;
    I.input = $(':input,[contenteditable=true]', obj).not('.calendar2')
};

function array_flip(arr) {
    arr = obj(arr);
    var temp = {};
    $.each(arr, function(i, o) {
        temp[o] = i
    });
    return temp
}
function array_keys(arr) {
    return array_values(arr, 'key')
}
function array_values(arr, type) {
    arr = obj(arr);
    var temp = [];
    $.each(arr, function(i, o) {
        if (type === 'key') {
            temp.push(i)
        } else {
            temp.push(o)
        }
    });
    return temp
}
function pp(s) {
    alert(s && typeof s == 'object' ? $.toJSON(s) : s)
}
function ref() {
    Msg.doing();
    $.JSON(CGI.ajax + '?cmd=ref', function(ret) {
        Msg.close();
        COMM.suc(ret)
    })
}
function sendcms() {
    Msg.doing();
    $.get(CGI.ajax + '?cmd=sendcms', function(ret) {
        Msg.close();
        SYS.window({
            html: ret
        })
    })
}
function versionlock() {
    Msg.doing();
    $.JSON(CGI.ajax + '?cmd=versionlock', function(ret) {
        Msg.close();
        COMM.suc(ret)
    })
}
function addCmsLang() {
    Msg.doing();
    $.POST(PATH.api + '?cmd=addCmsLang', {
        data: VAR.addCmsLang
    }, function(ret) {
        Msg.close();
        COMM.suc(ret)
    })
}
function count(d) {
    var n = 0;
    if (d && typeof d == 'object') {
        $.each(d, function(i, o) {
            if (typeof o != 'undefined') n++
        })
    }
    return n
}
function As3Call(id, msg) {
    if (id === 5) {
        if (msg) msg = decodeURIComponent(msg);
        try {
            eval(msg)
        } catch (e) {
            echo('执行错误', id, msg, e)
        }
    } else {
        if (id === 6) return;
        var set = ['', 'FLASH加载完成', '连接小喇叭成功', '小喇叭断线', '重连成功', '发送消息', '心跳包'];
        echo(id, set[id])
    }
}
var $o = function(s, base) {
    return $(s, base || RIGHT)
};

function oo(s) {
    var o = window,
        t;
    if (!s) return o;
    s = s.split(',');
    for (var i in s) {
        t = o.document.getElementById(s[i]);
        if (!t) return o;
        o = t.contentWindow
    }
    return o
}
function echo() {
    if (typeof console == 'object') {
        var s = ['"["+$D.date("H:i:s")+"]"'];
        $.each(arguments, function(i, o) {
            s.push(typeof o == 'object' ? 'arguments[' + i + ']' : '"["+arguments[' + i + ']+"]"')
        });
        s = 'console.log(' + s.join(',') + ')';
        try {
            eval(s)
        } catch (e) {
            console.log('Ac.log', e, s)
        }
    }
}
function htmlspecialchars(s, tpl) {
    if (!s || typeof s != 'string') return s;
    s = s.replace(/&/g, '&amp;');
    s = s.replace(/</g, '&lt;');
    s = s.replace(/>/g, '&gt;');
    s = s.replace(/\"/g, '&quot;');
    s = s.replace(/\'/g, '&#039;');
    if (s && tpl) {
        s = s.replace(/\{/g, 'DKHL');
        s = s.replace(/\}/g, 'DKHR')
    }
    return s
}
function clearCookie() {
    var ck = document.cookie,
        re = /[^=]*=[^;]*;?/g,
        s;
    ck = ck.match(re);
    $.each(ck, function(i, o) {
        s = o.split('=')[0].replace(';', '').replace(' ', '');
        cookie(s, '', {
            time: -1
        })
    })
}
function obj(o) {
    return typeof o == 'object' && o ? o : {}
}
var langfixs = new function() {
    var I = {
        gLan: function(set) {
            I.$data = set ? S.gLangfixs : '';
            return ''
        },
        data: function() {
            return I.$data || S.langfixs || [S.langfix]
        },
        cfg: function(def) {
            var d = I.data(),
                r = def || {};
            $.each(d, function(i, o) {
                r[o] = L.config[o]
            });
            return r
        },
        tit: function(n, rs, t) {
            var d = I.data(),
                tit = '';
            $.each(d, function(i, o) {
                if (o == S.langfix) return;
                tit += L.config[o] + '：' + rs[n + '_' + o] + '\n'
            });
            if (t) return tit;
            return '<div title="' + tit + '">' + (rs[n] || rs[n + '_' + S.langfix]) + '</div>'
        },
        form: function(n, rs, must) {
            Err('[function.js->langfixs.form]<br><b>多语言表单出错，请将错误信息提供给安凌志！</b><br>' + location.href)
        },
        tpl: function(str, p, must) {
            var rs, name, nm, r = [],
                lan, lang, tit, s, _fmt = function(s, o, lang, lan) {
                    s = s.replace(/#langfix/g, o);
                    s = s.replace(/#lang/g, lang);
                    s = s.replace(/#lan/g, lan);
                    return s
                };
            if (typeof p == 'object') {
                must = p.must;
                rs = p.rs;
                name = p.name;
                p = p.join
            }
            $.each(I.data(), function(i, o) {
                lang = '_' + o;
                lan = o == S.langfix ? '' : lang;
                tit = L.config[o];
                s = str;
                s = s.replace(/#tit/g, tit);
                if (lan && !must) s = s.replace(/must=".+?"/, '');
                s = _fmt(s, o, lang, lan);
                if (rs && typeof rs == 'object' && name) {
                    nm = _fmt(name, o, lang, lan);
                    s = s.replace('{value}', rs[nm] || '')
                }
                r.push(s)
            });
            if (typeof p == 'undefined') p = '<br>';
            return r.join(p)
        }
    };
    return I
};

function d(t, s) {
    Alert(t2d(t, s))
}
function t(d) {
    Alert(d2t(d))
}
function t2d(t, s) {
    s = s || 'Y-m-d H:i:s';
    return TPL.date(t, '', s)
}
function d2t(d) {
    if (!d) return 0;
    var d = $.trim(d).split(' '),
        d1 = d[0].split('-'),
        d2 = d[1] ? d[1].split(':') : [0, 0, 0];
    d = new Date(d1[0], d1[1] - 1, d1[2], d2[0] || 0, d2[1] || 0, d2[2] || 0).getTime();
    if (d) d = d / 1000;
    return d
}
function cmsapi() {
    COMM.ajax('sendcmsapi')
}
function allcmsapi() {
    COMM.ajax('sendallcmsapi')
}
function lang(sign, parent, w, h) {
    w = w || 100;
    h = h || '';
    var p = '',
        s = sign;
    if (parent == 'comm' || !parent) {
        p = 'comm';
        parent = ''
    } else {
        p = parent;
        parent = '.' + parent
    }
    if (sign.indexOf('.') > 0) s = sign.replace(/\./g, '"]["');
    var tag = 'L' + parent + '.' + sign,
        val;
    try {
        val = eval('L' + parent + '["' + s + '"]');
        val = val || tag
    } catch (e) {
        val = tag
    }
    val = val || tag;
    if (VAR.translate != 1) return val;
    return '<span class="chv translate" pack="L" parent="' + p + '" sign="' + sign + '" w="' + w + '" h="' + h + '" style="background:none" title="' + L.translate + '：' + tag + '">' + val + '</span>'
}
function helpCheck(v) {
    WIN[0].close();
    $o('[name=' + v + ']').val(VAR.self.html())
}
function encode(s) {
    return encodeURIComponent(s)
}
function getPng(src, tag, style, attr) {
    if (typeof(getPngIe6) == 'function') {
        return getPngIe6(src, tag, style, attr)
    } else {
        style = style ? style : '';
        attr = attr ? ' ' + attr : '';
        return '<' + tag + attr + ' style="background:url(' + SKIN.icon + src + '.png) no-repeat center;' + style + '"></' + tag + '>'
    }
}
function okFun() {
    var par = typeof WIN[0].confirmFun == 'function' ? WIN[0].confirmFun(1) : '';
    var fun = WIN[0].okFun;
    WIN[0].close();
    if (VAR.msgObj) VAR.msgObj.show(true);
    if (typeof(fun) == 'function') fun(par)
}
function cancelFun() {
    var par = typeof WIN[0].confirmFun == 'function' ? WIN[0].confirmFun(0) : '';
    var fun = WIN[0].cancelFun;
    WIN[0].close();
    if (VAR.msgObj) VAR.msgObj.show(true);
    if (typeof(fun) == 'function') fun(par)
}
function initWinTip(opt, h) {
    var _h = function(str, size, w) {
        size = int(size) || 12;
        w = int(w);
        w = w > 99 ? w + 'px' : 'auto';
        var o = $('#getHeight');
        var h = o.html('<style>#getHeight,#getHeight *{font-size:' + size + 'px!important}#getHeight{width:' + w + '}</style>' + str).height();
        o.html('');
        return h
    };
    h = int(h);
    if (h < 150) {
        if (opt.height && opt.height.toString().indexOf('%') > 0) {
            h = VAR.wh * int(opt.height.replace('%', '')) / 100
        } else {
            h = _h(opt.html, '', opt.width || APP['win'].width - 60);
            h = Math.max(h, 200)
        }
    }
    h = Math.min(h, VAR.wh - 200);
    opt.height = h;
    opt.html = opt.html.replace(/\[h\]/g, h - 62);
    new windowClass(opt, APP['win']);
    h = $o('[h]');
    var h2 = int(h.attr('h'));
    if (h.height() > h2) h.height(h2)
}
function Confirm(str, okFun, par, h) {
    VAR.msgObj = WIN[0];
    $('input[type=button]').blur();
    var type = 'confirm',
        opt = {
            'from': WIN[0] ? WIN[0].funStr : '',
            'fromId': WIN[0] ? WIN[0].id : 0,
            'sign': type + VAR._window++,
            'pic': 'sysHelp',
            'okFun': okFun,
            'title': L.confirm
        };
    if (par) $.extend(opt, par);
    opt.html = '<table style="width:100%"><tr><td class="dialog_img" style="text-align:center;height:[h]px">' + (opt.img || '<p class="dialog_img_' + type + '"></p>') + '</td><td class="dialog_str"><div h="[h]" style="overflow:auto">' + str + '</div></td></tr><tr><td colspan="2" align="center"><div class="dialogButtons closeRight"><input type="button" class="app dialog_y" fun="okFun" value="&nbsp;' + (opt.btnok || L.btn.ok) + '&nbsp;"><input type="button" class="app dialog_y" fun="cancelFun" value="&nbsp;' + (opt.btncancel || L.btn.cancel) + '&nbsp;"></div></td></tr></table>';
    initWinTip(opt, h)
}
function Alert(str, par) {
    VAR.msgObj = WIN[0];
    $('input[type=button]').blur();
    var h, type = 'alert',
        diyBtn = '',
        opt = {
            'from': WIN[0] ? WIN[0].funStr : '',
            'fromId': WIN[0] ? WIN[0].id : 0,
            'sign': type + VAR._window++,
            'pic': 'tip',
            'title': L.confirm
        };
    if (par) $.extend(opt, par);
    if (opt.img == 'NULL') {
        opt.img = '';
        str = '<div style="height:[h]px;overflow:auto">' + str + '</div>'
    } else {
        opt.img = '<td class="dialog_img" style="height:[h]px">' + (opt.img || '<p class="dialog_img_' + type + '"></p>') + '</td>'
    }
    if (opt.button) {
        $.each(opt.button, function(i, o) {
            diyBtn += '<input type="button" class="app" fun="' + i + '" value="&nbsp;' + o + '&nbsp;" onclick="WIN[0].close()">'
        })
    }
    opt.html = '<table style="width:100%"><tr>' + opt.img + '<td class="dialogText dialogText_' + type + '"><div h="[h]" style="overflow:auto">' + str + '</div></td></tr><tr><td colspan="2" align="center"><div class="dialogButtons closeRight"><input type="button" class="app dialog_y" fun="cancelFun" value="&nbsp;' + L.btn.ok + '&nbsp;">' + diyBtn + '</div></td></tr></table>';
    initWinTip(opt)
}
function Err(str, par) {
    console.trace('Err', str, par);
    VAR.msgObj = WIN[0];
    $('input[type=button]').blur();
    var type = 'err',
        opt = {
            'from': WIN[0] ? WIN[0].funStr : '',
            'fromId': WIN[0] ? WIN[0].id : 0,
            'sign': type + VAR._window++,
            'pic': 'tip',
            'title': L.tip
        };
    if (par) $.extend(opt, par);
    opt.html = '<table style="width:100%"><tr><td class="dialog_img" style="height:[h]px"><p class="dialog_img_' + type + '"></p></td><td class="dialogText dialogText_' + type + '"><div h="[h]" style="overflow:auto">' + str + '</div></td></tr><tr><td colspan="2" align="center"><div class="dialogButtons closeRight"><input type="button" class="app dialog_y" fun="cancelFun" value="&nbsp;' + L.btn.ok + '&nbsp;"></div></td></tr></table>';
    initWinTip(opt)
}
function setSpace(str) {
    return str ? str.replace(/\s/g, C.space) : ''
}
function getSpace(str) {
    var re = eval('/' + C.space + '/g');
    return str ? str.replace(re, ' ') : ''
}
function goTo(url) {
    if (url) {
        if (typeof url == 'number') {
            history.go(url)
        } else {
            location.href = url
        }
    } else {
        location.href = location.href.split('#')[0]
    }
}
function checkAll(name, all) {
    $o('input[name="' + name + '"]').each(function(i, o) {
        o.checked = all ? VAR.self[0].checked : !o.checked
    })
}
function getCheckBox(name, obj, andstr) {
    if (!obj) obj = RIGHT;
    var temp = [];
    $('input[name="' + name + '"]:checked', obj).each(function(i, o) {
        temp.push(o.value)
    });
    if (andstr == 'array') return temp;
    temp = temp.join(andstr || ',');
    return temp
}
function getCheckbox(name) {
    var v = getCheckBox(name);
    if (v == '') Err(L.noselect);
    return v
}
function getValues(str, type) {
    type = type ? type : 'name';
    var temp = '';
    $o('input[' + type + '="' + str + '"]').each(function(i, o) {
        temp += o.value + ','
    });
    if (temp) temp = temp.replace(/,$/, '');
    return temp
}
function getAppDom(e) {
    e = e || window.event;
    if (!e.target) e.target = e.srcElement;
    var el = e.target;
    if (!el.getAttribute('fun')) {
        while (el.parentNode && el.parentNode.tagName != 'BODY' && !el.parentNode.getAttribute('fun')) {
            el = el.parentNode
        }
        el = el.parentNode
    }
    if (el && el.tagName != 'BODY' && el.getAttribute('fun')) return el;
    return false
}
function getObj(e, tags) {
    e = e || window.event;
    if (!e.target) e.target = e.srcElement;
    var el = e.target;
    if (el.nodeName != tags) {
        while (el.parentNode && el.parentNode.tagName != tags) el = el.parentNode;
        el = el.parentNode
    }
    if (el && el.nodeName == tags) return el
}
function getIdDom(e) {
    e = e || window.event;
    if (!e.target) e.target = e.srcElement;
    var el = e.target;
    if (!el.id) {
        while (el.parentNode && !el.parentNode.id) el = el.parentNode;
        el = el.parentNode
    }
    if (el && el.id) return el
}
function clone(obj) {
    if (typeof(obj) != 'object' || obj == null) return obj;
    var newObj = obj instanceof Array ? [] : {};
    for (var i in obj) {
        newObj[i] = clone(obj[i])
    }
    return newObj
}
function extend(base, opt) {
    base = clone(base);
    for (var i in opt) {
        base[i] = opt[i]
    }
    return base
}
$(function() {
    P.ref = function() {
        var p = WIN[0].pageObj;
        if (typeof p == 'object') p.ref()
    };
    P.chg = function(v, i) {
        i = i || 0;
        P.o[i].chg(v)
    };
    P.pageto = function(m, i) {
        i = i || 0;
        P.o[i].pageto(m)
    };
    Page.prototype.change = function() {
        var I = this;
        var s = '<select onchange="P.chg(this.value,' + I.id + ')"><option value="' + I.$size + '">' + I.$size + '</option>',
            i = 5;
        while (i <= 100) {
            s += '<option value="' + i + '">' + i + '</option>';
            if (i < 50) i += 5;
            else if (i < 100) i += 10;
            else i += 50
        }
        return s + '<select>'
    };
    Page.prototype.chg = function(v) {
        var I = this;
        I.$size = v;
        cookie('pagesize', v);
        WIN[0].pageObj.set('size', v);
        P.set.size = v;
        v = Math.ceil(I.$all / v);
        if (v > I.$page) v = I.$page;
        I.ref(v)
    };
    Page.prototype.pageto = function(m) {
        var I = this;
        var p = $(m).prev().val();
        I.go(p)
    }
});
Number.prototype.indexOf = function(v) {
    var s = this.toString();
    return s.indexOf(v)
};

function loadScript(src, callback) {
    var script = document.createElement('script');
    script.onload = callback;
    script.type = 'text/javascript';
    script.src = CMS_PATH + src + '.js';
    document.getElementsByTagName('head').item(0).appendChild(script)
}
function loadStyle(href) {
    var link = document.createElement('link');
    link.type = 'text/css';
    link.rel = 'stylesheet';
    link.href = CMS_PATH + href + '.css';
    document.getElementsByTagName('head').item(0).appendChild(link)
}
var CMS_PATH = (function() {
    var r = location.pathname,
        a = r.split('/'),
        s = a[a.length - 1];
    if (s) r = r.replace(s, '');
    r = r.replace('/user/', '/');
    return r
})();
var C = {
    'version': 'v1.0',
    'onlineLoop': 300,
    'online': 86400,
    'loginId': 'CMS_LOGINID',
    'hTit': 25,
    'hMenu': 22,
    'hBtn': 39,
    'hTool': 30,
    'hDeskTop': 10,
    'iconsize': 100,
    'hL': 153,
    'hR': 95,
    'spStr': 'sp',
    'bag': {
        'base': 100,
        'money': 0,
        'real': 1,
        'gift': 2,
        'prop': 3,
        'vip': 4,
        'face': 5,
        'interact': 6,
        'collects': 7,
        'byb': 8,
        'integral': 9,
        'bag': 10,
        'score': 11,
        'exp': 12,
        'nothing': 13,
        'mycard': 14,
        'levels': 15,
        'corona': 16,
        'bycard': 17,
        'liquan': 18,
        'ingot': 19,
        'addchips': 20,
        'fame': 21,
        'startkt': 22,
        'rongyu': 23,
        'vcard': 24
    },
    'noData': '<tr><td colspan="20" class="noData notBgCg">' + L.nodata + '</td></tr>',
    'cdn': 'http://mvussppk02.ifere.com/',
    'mf': 'http://mf.oa.com/',
    'border': '1px solid #333',
    'space': '~S~',
    'del': ' class="del" title="' + L.isdel + '"',
    'lock': ' class="lock" title="数据未通过审核，锁定中！"',
    'loginbg': '<style>.dialog_bg{background:url(skin/sys/loginbg.jpg) right bottom;}</style>',
    'str1': '&nbsp;&nbsp;&nbsp;&nbsp;',
    'rm': 'desktop,desktopPic,window,left,myAppList',
    'desktop': [{
        'sign': 'myAppList'
    }, {
        'sign': 'applist'
    }, {
        'sign': 'refDb'
    }, {
        'sign': 'version'
    }],
    'bfh': '!',
    'notHash': 'setWin|checkAll|SYS|COMM|Fun',
    'id': {
        'levels': 264,
        'act': 3,
        'gift': 4,
        'prop': 5,
        'promotion': 6,
        'feed': 7,
        'chat': 8,
        'collects': 9,
        'msg': 11,
        'sys': 20,
        'doc': 18,
        'bag': 17,
        'tables': 115,
        'integralgifts': 136,
        'sports': 279,
        'closepage': 290,
        'maintpl': 21,
        'limit': 160,
        'nqueue': 357,
        'nqueues': 31,
        'hallTables': 432,
        'as2jsold': 192,
        'as2js': 572,
        'flashui': 99,
        'translate': 456,
        'croupier': 524,
        'loadingCfg': 561,
        'warning': 592,
        'wenjuan': 604
    },
    'pagecut': '<div style="page-break-after: always;"><span style="display: none;">&nbsp;</span></div>',
    'allowOpt': {
        'fileupload': L.file.upload,
        'filedel': L.file.del
    },
    'dataCut': '@_@',
    'dev': location.hostname.indexOf('vm.') === 0
};
var PATH = {
    'app': CMS_PATH + 'app/',
    'api': CMS_PATH + 'api/',
    'data': CMS_PATH + 'data/',
    'dbfile': CMS_PATH + 'data/dbfile/',
    'help': CMS_PATH + 'data/help/',
    'upload': CMS_PATH + 'data/',
    'log': CMS_PATH + 'data/log/',
    'tpl': CMS_PATH + 'tpl/',
    'js': CMS_PATH + 'js/',
    'jsdev': CMS_PATH + 'jsdev/',
    'hrgroup': 'http://cms.oa.com/api/?cmd=hrgroup',
    'hrgroups': 'http://by.oa.com/api/?cmd=hr_group&var=$HR_GROUPS',
    'jl_from': 'http://by.oa.com/js/jl_from.js?' + vars.versions,
    'job_position': 'http://by.oa.com/js/job_position.js?' + vars.versions,
    'xueli': 'http://by.oa.com/js/xueli.js?' + vars.versions,
    'hchar': vars.cmslib + 'plugins/Highcharts/js/',
    'editor': vars.cmslib + 'plugins/editor/',
    'ueditor': vars.cmslib + 'plugins/ueditor/',
    'socket': vars.cmslib + 'js/socket.io.js',
    'coud': function(aid) {
        return [CMS_PATH + 'js/Coud.js?' + vars.versions, CMS_PATH + 'api/coud.php?cmd=cfg&aid=' + aid + '&by_sid=' + S.id]
    },
    'init': function() {
        PATH.$wmode = PATH.api + '?cmd=wmodemap&by_sid=' + S.msid;
        PATH.$prop = PATH.data + 'map/prop.js?' + COMM.version('map.prop')
    }
};
var CGI = {
    'ajax': PATH.api + 'ajax.php',
    'login': PATH.api + 'login.php',
    'tpl': PATH.api + 'tpl.php',
    'lc': 'http://210.5.191.163/api/lcdata.php',
    'mf': C.mf + 'Servlet',
    'mf2': 'http://192.168.202.89:8080/HBServlet/Servlet',
    'cmsmf': 'http://cms_mf.oa.com/',
    'mfsql': C.mf + 'dbFileQuery',
    'mflog': C.mf + 'hbFileQuery',
    'mflist': C.mf + 'dbQuery',
    'mfsum': C.mf + 'sum',
    'mfenter': C.mf + 'log/hiveQuery',
    'mfcenter': 'http://mf.boyaagame.com/api/',
    'mftest': 'http://172.20.52.10:8080/HBServlet/dbFileQuery',
    'app': function(url, sign) {
        return PATH.app + SYS.commApp(url, sign)
    }
};
var SKINS = vars.skinurl;
if (!SKINS) SKINS = 'http://cms.oa.com/skin/';
var SKIN = {
    'path': SKINS,
    'bg': SKINS + 'bg/',
    'table': SKINS + 'table/',
    'winBtn': SKINS + 'winBtn/',
    'icon': SKINS + 'icon/',
    'sys': SKINS + 'sys/',
    'img': SKINS + 'img/',
    'filepic': SKINS + 'img/filepic/',
    'admingroup': SKINS + 'admingroup/'
};
var VAR = {
    'lock': false,
    'admin': {},
    'searchTemp': {},
    'hashLock': true,
    'jsLoaded': {},
    'model': 'normal',
    'zIndex': 1000,
    'ww': $(window).width(),
    'wh': $(window).height(),
    'by_cfgon': 0,
    '_window': 0,
    'num': 0,
    'tn': 8,
    'mtn': 20
};
var S = {};
var MENU = [{
    sign: 'sysSet'
}, {
    sign: 'links'
}];
var JQ = {
    'body': $(document.body),
    'normal': $('#normal'),
    'window': $('#window'),
    'checkFormMes': $('#checkFormMes')
};
var MY = {};
var WIN = [];
var PAR = '';
var PARS = '';
var TABLE = [];
var START = [];
var RUNWORD = [];
var LOCAL = document.body;
var RIGHT = document.body;
var FAST = [{
    'sign': 'showTable'
}, {
    'sign': 'closeAll'
}, {
    'sign': 'sysHelp'
}];
var APP = {};
APP['win'] = {
    width: 350,
    height: 200,
    allow: 1,
    fullScreen: false,
    lockSize: true,
    leftDisplay: 'forbid',
    overflow: 'hidden',
    toolbar: false,
    min: false,
    max: false,
    keepOpen: true,
    lock: true,
    init: 'null',
    notList: true,
    notLoad: true
};
APP['myAppList'] = {
    pic: 'sysInfo',
    leftDisplay: 'forbid',
    init: 'SYS.myAppList',
    allow: 1,
    js: '-',
    notList: true,
    notLoad: true
};
APP['showTable'] = {
    package: 'SYS',
    allow: 1,
    notList: true,
    notLoad: true
};
APP['clearTemp'] = {
    package: 'SYS',
    allow: 1,
    notList: true,
    notLoad: true
};
APP['closeAll'] = {
    pic: 'closeAll',
    package: 'SYS',
    allow: 1,
    notList: true,
    notLoad: true
};
APP['lockScreen'] = {
    pic: 'lockScreen',
    package: 'SYS',
    allow: 1,
    notList: true,
    notLoad: true
};
APP['upload'] = {
    url: PATH.app + '?t=h&f=upload/?' + Math.random(),
    comm: 1,
    allow: 1,
    width: 400,
    height: 360,
    js: '-',
    fullScreen: false,
    lockSize: true,
    lock: true,
    notList: true
};
APP['webftp'] = {
    url: PATH.app + '?t=h&f=webftp/?' + Math.random(),
    comm: 1,
    allow: 1,
    width: 840,
    js: '-',
    lockSize: true,
    lock: true,
    fullScreen: false,
    notList: true
};
var SYS = {
    init: function() {
        COMM.init();
        Tj.init();
        this.keyEvt();
        this.live('app', 'click');
        this.live('dbl', 'dblclick');
        this.live('kup', 'keyup');
        this.hashchange();
        this.helpEvt();
        Chv.live();
        VAR.translate = cookie('translate');
        if (!VAR.translate) SO.live();
        SYS.initLogin()
    },
    socket: function(at) {
        if (typeof io == 'undefined' || !VAR.kiper) return;
        if (SYS.$sock && at) return SYS.$sock.emit('at', at + (C.dev ? '(vm)' : ''));
        var t;
        SYS.$sock = new BYSocket(VAR.kiper);
        SYS.$sock.on('online', function(n) {
            if (t) clearTimeout(t);
            t = setTimeout(function() {
                $('#cms_online').attr('title', '当前在线：' + n + '人');
                if (WIN[0].sign === 'cmsonlineinfo' && typeof cmsonlineinfo == 'object') cmsonlineinfo.init(true)
            }, 1000)
        });
        SYS.$sock.init()
    },
    initLogin: function() {
        var rs = VAR.loginData;
        vars.auth_apply = rs.auth_apply;
        if (!rs.cfg) {
            clearCookie();
            COMM.notLogin();
            return
        }
        if (vars.sysname === 'cms') $.getScript(PATH.socket, SYS.socket);
        cookie('location_href', '');
        vars.model = cookie('_model') === 'window' ? 'window' : 'normal';
        $('#' + vars.model).display();
        SYS.userInfo(rs.info);
        var f = function() {
            $.ajaxError = '';
            SYS.dataLan();
            VAR.applist = {};
            VAR.applistArr = {};
            VAR.applistTemp = {};
            VAR.addCmsLang = {};
            $.each(VAR.appData, function(i, o) {
                i = int(i.replace('c', ''));
                var temp = {
                    'id': i
                };
                $.each(o, function(k, v) {
                    temp[VAR.appSet[k]] = v;
                    if (typeof temp.par == 'undefined') temp.par = ''
                });
                if (temp.diyBtn) {
                    $.each(temp.diyBtn, function(k, v) {
                        v = v.split('`');
                        v = {
                            'title': v[0],
                            'fun': v[1],
                            'key': v[2],
                            'hide': v[3]
                        };
                        temp.diyBtn[k] = v
                    })
                }
                o = temp;
                if (!o.sign && VAR.applist[o.fid] && VAR.applist[o.fid].sign) o.sign = VAR.applist[o.fid].sign;
                o.title = L.appid[i] || o.title;
                VAR.addCmsLang['appid.' + i] = o.title;
                if (!VAR.applistArr[o.fid]) VAR.applistArr[o.fid] = [];
                VAR.applist[i] = o;
                temp = {
                    'id': i,
                    'title': o.title,
                    'sign': o.sign || '',
                    'par': o.par || '',
                    'notList': o.notList || '',
                    'topid': o.topid
                };
                if (o.blank) temp.blank = o.blank;
                if (o.sign && (o.right || o.extend || o.diyBtn) && o.isapp) {
                    SYS.setApp(o);
                    if (SYS.allow(o.sign)) VAR.applistArr[o.fid].push(temp)
                } else {
                    VAR.applistArr[o.fid].push(temp);
                    if (o.sign) VAR.applistTemp[o.sign] = o.fid
                }
            });
            $.each(VAR.applistTemp, function(sign, fid) {
                if (SYS.allow(sign)) return;
                var arr = VAR.applistArr[fid];
                if (!arr) return;
                $.each(arr, function(i, o) {
                    if (o.sign && o.sign == sign) {
                        delete arr[i]
                    }
                });
                var temp = [];
                $.each(arr, function(i, o) {
                    if (o) temp.push(o)
                });
                VAR.applistArr[fid] = temp
            });
            SYS.appLang();
            SYS.fmtCgi();
            if (typeof sys_start == 'function') sys_start();
            if (!SYS.enterInit()) return false;
            var tip = L.platformname + '：' + S.name + '(' + (S.langfix ? S.langfix + ',' : '') + S.id + ')';
            Msg.err(tip, {
                time: 10000
            });
            SYS.cmsmsg(rs.cmsmsg);
            VAR.appData = null;
            D.offset = 1;
            JQ.checkFormMes.mouseenter(function() {
                if (VAR.msgLock) return;
                JQ.checkFormMes.html('');
                Msg.clear()
            })
        };
        $.ajaxError = f;
        SYS.sites(rs.cfg, f)
    },
    _log: [],
    _logs: {},
    log: function(v, path) {
        if (SYS._logs[v]) return;
        SYS._logs[v] = 1;
        SYS._log.push(v);
        if (SYS._logtm) clearTimeout(SYS._logtm);
        SYS._logtm = setTimeout(function() {
            $.post(CGI.ajax + '?cmd=jsLog&path=' + (path || ''), {
                data: SYS._log.join("\n\n")
            });
            SYS._log = []
        }, 1000)
    },
    fmtCgi: function() {
        PATH.init();
        CGI.upload = 'http://' + location.host + CMS_PATH + 'app/' + SYS.commApp('upload/upload.php');
        CGI.webftp = CGI.app('webftp/webftp.php');
        CGI.log = CGI.app('log/log.php');
        CGI.logs = CGI.app('logs/logs.php');
        CGI.bag = CGI.app('bag/bag.php');
        CGI.diyLang = CGI.app('diyLang/diyLang.php');
        CGI.cmsmsg = CGI.app('cmsmsg/cmsmsg.php');
        CGI.special = CGI.app('special/special.php');
        CGI.version = CGI.app('version/version.php');
        CGI.dc = CGI.app('dc/dc.php');
        if (vars.server == 2 || getPar('debug')) CGI.mf = CGI.mf2
    },
    cmsmsg: function(rs) {
        if (!rs || !rs.id || !rs.content) return;
        setTimeout(function() {
            var hidden, re = rs.content.match(/\[doc=([^\]]*)\]/);
            if (re && re[1]) {
                hidden = 1;
                rs.content = '<iframe src="http://' + location.host + CMS_PATH + 'doc/' + re[1] + '.html?' + vars.versions + '" width="100%" height="100%" frameborder="0"></iframe>'
            }
            SYS.window({
                title: 'CMS系统公告 (点击头像旁边的消息图标可以查看所有消息)',
                html: rs.content,
                width: '80%',
                height: '80%',
                closeFun: function() {
                    $.JSON(CGI.cmsmsg + '?cmd=read&id=' + rs.id)
                }
            });
            if (hidden) RIGHT.css('overflow', 'hidden')
        }, 1000)
    },
    dataLan: function() {
        if (typeof LL != 'object') return;
        $.each(['collects', 'user'], function(i, o) {
            if (L[o] && LL[o]) $.extend(L[o], LL[o])
        })
    },
    dataLanLoad: function(fn) {
        $.getScript(vars.cmslib + 'data/L/' + (S.langfix || 'th') + '.data.js?' + COMM.version('LL'), fn)
    },
    ref: function() {
        if (location.search) {
            location.href = location.href.replace(location.search, '?sid=' + S.id)
        } else {
            SYS.refUrl()
        }
    },
    appLang: function() {
        var i, btn, ii, b, s;
        for (i in APP) {
            if (!APP[i].pic) APP[i].pic = 'showTable';
            if (!APP[i].title) {
                if (L.app[i]) {
                    APP[i].title = L.app[i]
                } else if (APP[i].action && VAR.applist[APP[i].action]) {
                    APP[i].title = VAR.applist[APP[i].action].title
                } else {
                    APP[i].title = i
                }
            }
        }
    },
    setApp: function(o) {
        var temp = {
                'title': o.title,
                'id': o.id,
                'par': ''
            },
            ext = o.extend && APP[o.extend] ? clone(APP[o.extend]) : 0;
        $.each(VAR.appSet, function(i, k) {
            if (typeof o[k] != 'undefined') temp[k] = o[k];
            if (k != 'allow' && ext && ext[k]) {
                if (k == 'diyBtn' && temp[k]) {
                    temp[k] = ext[k].concat(temp[k])
                } else if (!temp[k]) {
                    temp[k] = ext[k]
                }
            }
        });
        if (ext) {
            temp.sign = o.extend;
            temp.signs = o.sign
        }
        if (temp.diyBtn) {
            $.each(temp.diyBtn, function(ii, oo) {
                if (!oo.title && oo.key) oo.title = oo.key;
                oo.title = L.btn[oo.title] || oo.title
            })
        }
        if (temp.right == '-') temp.right = '';
        if (temp.allow && o.sign) {
            if (!MY.allow) MY.allow = [];
            MY.allow.push(o.sign)
        }
        var s = temp.js || temp.right || temp.sign;
        if (s === '-') s = temp.sign;
        s = s.split('/')[0] + '/';
        APP[o.sign] = temp
    },
    userInfo: function(rs) {
        rs = rs ? rs : {};
        rs.table = 'def.jpg';
        rs.bg = 'bg.jpg';
        MY = rs
    },
    deving: function(s) {
        Msg.service(s || '非常抱歉，功能还在开发中...', {
            closeBtn: 1,
            time: 1
        })
    },
    enterInit: function() {
        P.set.size = parseInt(MY.pagesize) || 20;
        if (L.diycss) JQ.body.append('<style>' + L.diycss + '</style>');
        var i, temp = clone(C.desktop);
        for (i in TABLE) {
            temp.push(TABLE[i])
        }
        TABLE = temp;
        JQ.desktop = $('#desktop');
        JQ.myTools = $('#myTools');
        if (vars.model === 'normal') {
            VAR.defapp = 'begin';
            C.hTool = 0;
            JQ.normal.show();
            JQ.window.show();
            SYS.loadTopApp();
            JQ.adminInfo = $('#adminInfo');
            JQ.normalMenu = $('#normalMenu');
            JQ.normalLefts = $('.normalLeft');
            JQ.normalLeft = $('#normalLeft');
            JQ.normalRight = $('#normalRight');
            JQ.adminInfo.html('<div class="headpic app" fun="adminuserForm_my" title="' + L.sys.edit + '">' + SYS.headpic(0, 40) + '</div><div class="info"><b>' + (MY.name ? MY.name : MY.username) + '<i>(' + MY.gname + ')</i></b><i title="' + L.sys.last + '">' + MY.logintime + '</i><p><img class="app" fun="SYS.lockScreen" title="' + L.sys.lock + '" src="' + SKIN.sys + 'info_lock.png" width="16" />' + (vars.sysname == 'cms' ? '<img class="app" fun="cmsmsg" title="CMS系统消息" src="' + SKIN.sys + 'info_mes.png" width="16" /><img class="app" fun="cmsonlineinfo" src="' + SKIN.sys + 'info_count.png" width="16" id="cms_online" />' : '') + '<img class="app" fun="SYS.quit" title="' + L.sys.quit + '" src="' + SKIN.sys + 'info_quit.png" width="16" /></p></div>');
            SYS.setTopMenu();
            $('#normalHead .appRun').appRun(1)
        } else {
            MY.app = '';
            JQ.desktopPic = $('#desktopPic');
            JQ.myFast = $('#myFast');
            JQ.startMenu = $('#startMenu');
            JQ.startMenuTop = $('#startMenuTop');
            JQ.startLeft = $('#startLeft');
            JQ.startRight = $('#startRight');
            JQ.toolbar = $('#toolbar');
            JQ.startMenu = $('#startMenu');
            JQ.rightMenu = $('#rightMenu');
            JQ.myTime = $('#myTime');
            JQ.myTimes = $('#myTimes');
            JQ.myTip = $('#myTip');
            JQ.myTips = $('#myTips');
            JQ.desktop.height(VAR.wh - C.hTool);
            VAR.defapp = '';
            $('#normalCss').remove();
            JQ.normal.remove();
            JQ.window.show();
            JQ.body.css('background', 'url(' + SKIN.bg + MY.bg + ')');
            JQ.desktop.css('background', 'url(' + SKIN.table + MY.table + ') no-repeat center');
            JQ.toolbar.show();
            TABLE.push({
                'sign': 'changeSid'
            });
            TABLE.push({
                'sign': 'sysRun'
            });
            SYS.loadDeskTop();
            SYS.loadFast();
            SYS.time();
            MES.init();
            MES.mes('当前系统是窗口模式；<br>您可以通过<a class="app" fun="changeSid">【平台切换】</a>功能切换回普通模式；<br>按F11可以有更好的体验哦！');
            JQ.startMenu.mouseleave(SYS.clear)
        }
        SYS.topIo(1);
        SYS.leftIo(1);
        SYS.setHover();
        VAR.repeatTemp = {};
        if (!COMM.allow(S.id)) {
            Err(COMM.notAllowTip('notAllowsitelist.' + S.id));
            return
        }
        if (cookie('lockScreen')) {
            SYS.lockScreen()
        } else {
            Msg.close();
            Msg.close();
            $('>li>a.app[fun=""]', JQ.normalMenu).each(function() {
                if (!$(this).next().hasClass('child')) $(this).parent().remove()
            });
            SYS.defApp()
        }
        return true
    },
    headpic: function(wid, w, click) {
        if (!wid) wid = MY.id;
        var src = vars.cmslib + 'api/headpic.php?id=' + wid;
        if (w == 'src') return src;
        w = w ? ' width="' + w + '"' : '';
        click = click ? ' onclick="window.open(this.src)" style="cursor:pointer"' : '';
        return '<img' + w + click + ' src="' + src + '" />'
    },
    live: function(str, ev) {
        $('.' + str).live(ev, function(e) {
            var I = $(this);
            Tj.send(e, I.attr('fun'));
            var app = SYS.getApp(I, 1);
            if (app) {
                if (ev == 'change') app.par = this.value;
                VAR.self = I;
                SYS.app(app)
            }
        })
    },
    moreApp: function(hide) {
        var s = '<select onchange="SYS.moreAppExec(this)"><option style="font-weight:bold" value="">★更多操作★</option>';
        $.each(hide, function(i, o) {
            s += '<option value="' + o.fun + '">' + o.title + '</option>'
        });
        s += '</select>';
        return s
    },
    moreAppExec: function(i) {
        if (i.value) SYS.appStr(i.value);
        $('[value=""]', i).attr('selected', true)
    },
    commApp: function(u, s, tp) {
        if (!s) s = u.split('/')[0];
        if (!tp) {
            if (u.indexOf('.html') > 0 || u.indexOf('.tpl.php') > 0) {
                tp = 'h'
            } else if (u.indexOf('.js') > 0) {
                tp = 'j'
            } else {
                tp = 'p'
            }
        }
        return APP[s] && APP[s].comm ? '?t=' + tp + '&f=' + u.replace('?', '&') : u
    },
    appStr: function(str, e) {
        SYS.app(SYS.getApp(str, e))
    },
    app: function(app) {
        if (!app || VAR.lock) return;
        if (typeof(app.func) == 'function') {
            var par = app.par;
            if (par && par.indexOf(',') >= 0) {
                var arr = par.split(',');
                par = [];
                for (var i in arr) {
                    par.push('"' + arr[i] + '"')
                }
                par = par.join(',');
                eval('app.func(' + par + ')')
            } else {
                app.func(par)
            }
            return
        }
        if (vars.sysname === 'cms') {
            $('#api_img').remove();
            if ($.inArray(app.sign, ['lock', 'sysSet', 'prop']) === -1) $('#appLockImg').remove();
            if ($.inArray(app.id, VAR.apiArr) >= 0 || app.id == 0 && vars.api) {
                $('#adminInfo').append('<img id="api_img" src="' + SKIN.img + 'api_' + vars.api + '.png?" style="position:absolute;top:42px;left:33px" title="' + L.api[vars.api] + '独立应用" />')
            }
        }
        if (WIN[0]) {
            var t = (app.fullScreen == 0 ? 'window' : 'normal') + '_' + app.sign;
            if (WIN[t]) {
                WIN[t].from = WIN[0] ? WIN[0].funStr : '';
                WIN[t].fromId = WIN[0] ? WIN[0].id : 0;
                WIN[t].par = app.par;
                WIN[t].topid = app.topid;
                WIN[t].signs = app.signs ? app.signs : app.sign;
                WIN[t].funStr = VAR.funStr;
                WIN[t].show();
                WIN[t].opt.right = app.right;
                WIN[t].opt.diyBtn = app.diyBtn;
                if (WIN[t].action != app.action) {
                    WIN[t].action = app.action;
                    WIN[t].opt.title = WIN[t].title = app.title;
                    WIN[t].updateLeft()
                }
                WIN[t].action = WIN[t].action ? WIN[t].action : '';
                WIN[t].right.html('');
                WIN[t].update();
                return
            }
        }
        SYS.newApp(app)
    },
    newApp: function(app) {
        var model = vars.model,
            md, id = app.sign,
            a;
        app.from = WIN[0] ? WIN[0].funStr : '';
        app.fromId = WIN[0] ? WIN[0].id : 0;
        if (typeof app.action == 'undefined') app.action = '';
        if (SYS._hash) {
            md = model = 'normal';
            SYS._hash = ''
        } else {
            md = 0
        }
        if (app.js && app.js.indexOf('.js') < 0) {
            if (!md && app.fullScreen == 0) model = 'window';
            a = app;
            eval('new ' + model + 'Class(a)')
        } else {
            var str = app.sign.replace(new RegExp('Form$'), ''),
                path = app.js && app.js.indexOf('.js') > 0 ? app.js : str + '/' + str + '.js',
                jsfile;
            if (app.comm) {
                jsfile = PATH.app + '?t=j&f=' + path;
                CGI[str] = PATH.app + '?t=p&f=' + path.replace('.js', '.php')
            } else {
                jsfile = PATH.app + path + '?' + vars.versions;
                CGI[str] = PATH.app + path.replace('.js', '.php')
            }
            $.getScript(jsfile, function() {
                if (!md && app.fullScreen == 0) model = 'window';
                a = app;
                eval('new ' + model + 'Class(a)')
            })
        }
    },
    getApp: function(str, errtip) {
        if (!str) {
            Err('Err:SYS.getApp!');
            return false
        }
        if (typeof(str) == 'object') str = str.attr('fun');
        var f = str,
            par = '';
        if (!str) return false;
        if (str.indexOf('_') > 0) {
            f = str.split('_')[0];
            par = str.split(f + '_')[1]
        }
        var app = APP[f];
        if (app) {
            if (!app.allow && !SYS.allow(f)) {
                if (errtip) SYS.notAllow(f);
                return false
            }
            if (!app.signs) app.signs = f;
            if (!app.sign) app.sign = f;
            if (app.signs.indexOf('_') >= 0) {
                f = app.signs.split('_')[0];
                app.par = app.signs.split(f + '_')[1];
                app.signs = f
            } else {
                app.par = par
            }
            if (!app.action && app.signs.indexOf('-')) app.action = app.signs.split('-')[1];
            VAR.funStr = str
        } else {
            try {
                eval('var fn=' + f)
            } catch (e) {}
            if (typeof(fn) == 'function') {
                app = {};
                app.func = fn;
                app.par = par
            }
            if (!app && errtip) SYS.notAllow(f)
        }
        return app
    },
    allow: function(str) {
        return COMM.allow(str)
    },
    notAllow: function(str) {
        if (!M.dialogLoaded) {
            M.loading();
            M.loadend()
        }
        Err(l(L.sys.error, [str]), {
            width: 450
        })
    },
    setHash: function(app) {
        if (typeof(app) == 'string') {
            VAR.hashLock = true;
            SYS.setHashs(app);
            return
        }
        if (app && (app.lock || app.fullScreen == 0) || VAR.funStr.indexOf('.') > 0 || new RegExp(C.notHash, 'g').test(VAR.funStr)) return;
        VAR.hashLock = true;
        if (location.hash != VAR.funStr) SYS.setHashs(VAR.funStr)
    },
    setHashs: function(s) {
        location.hash = s;
        s && SYS.socket(s);
        cookie('_app' + vars.api, s)
    },
    hashchange: function() {
        $(window).bind('hashchange', function(e) {
            if (VAR.hashLock) {
                VAR.hashLock = false;
                return
            }
            var hash = location.hash ? location.hash.replace('#', '') : '';
            if (hash) SYS.appStr(hash)
        })
    },
    defApp: function() {
        VAR.defapp = $('#normalMenu [fun]').eq(0).attr('fun');
        var hash = location.hash ? location.hash.replace('#', '') : MY.app || VAR.defapp;
        if (hash) {
            var s = hash.split('_')[0];
            if (!APP[s] || !COMM.allow(s)) hash = VAR.defapp;
            SYS._hash = hash;
            SYS.appStr(hash, true)
        }
    },
    topIo: function(c) {
        var n = 'topIo';
        if (c) {
            if (cookie(n) == 1) SYS.topIo();
            return
        }
        var o = $('#topMenu');
        if (o.is(':visible')) {
            o.hide();
            $('span.' + n).html('<img src="' + SKIN.sys + 'topIo2.png?1" />').css('top', -11).attr('title', L.unfold);
            cookie(n, 1);
            C.hL = 94;
            C.hR = 36
        } else {
            $('span.' + n).html('<img src="' + SKIN.sys + 'topIo.png?1" />').css('top', -12).attr('title', '向上' + L.fold);
            o.show();
            cookie(n, 0);
            C.hL = 153;
            C.hR = 95
        };
        SYS.setSize()
    },
    leftIo: function(c) {
        var n = 'leftIo';
        if (c) {
            if (cookie(n) == 1) SYS.leftIo();
            return
        }
        var o = JQ.normalLefts,
            ml;
        if (o.is(':visible')) {
            o.hide();
            $('span.' + n).html('<img src="' + SKIN.sys + 'leftIo2.png?1" />').css('left', -12).attr('title', L.unfold);
            cookie(n, 1)
        } else {
            $('span.' + n).html('<img src="' + SKIN.sys + 'leftIo.png?1" />').css('left', 184).attr('title', '向左' + L.fold);
            o.show();
            cookie(n, 0)
        }
    },
    start: function() {
        var o = JQ.startMenu;
        if (o.is(':visible')) {
            o.hide()
        } else {
            SYS.loadStart();
            $('ul ul', JQ.startRight).hide();
            Delay(function() {
                o.show()
            }, 100)
        }
    },
    time: function() {
        var t;
        JQ.myTime.date('H:i', 5000).mouseover(function() {
            t = JQ.myTimes.date('Y-m-d H:i:s', 1000).show()
        });
        JQ.myTime.mouseout(function() {
            JQ.myTimes.hide();
            t.clear()
        })
    },
    setSize: function() {
        if (!JQ.desktop) return;
        if (VAR.delay) VAR.delay.clear();
        VAR.delay = new Delay(function() {
            VAR.ww = $(window).width();
            VAR.wh = $(window).height();
            if (vars.model === 'normal') {
                $('.lefts').height(VAR.wh - C.hL);
                $('.contents').height(VAR.wh - C.hR)
            } else {
                var h = VAR.wh - C.hTool;
                JQ.desktop.height(h);
                SYS.loadDeskTop(h - C.hDeskTop);
                for (var i in WIN) {
                    if (WIN[i] && WIN[i].full) {
                        WIN[i].win.height(h);
                        $('.winBody', WIN[i].win).height(h - WIN[i]._hCon)
                    }
                }
            }
            if (WIN[0] && typeof(WIN[0].chgWinSize) == 'function') WIN[0].chgWinSize(WIN[0].win)
        }, 100)
    },
    loadTopApp: function(get) {
        var obj = $('#normalHead u>span').eq(1);
        if (get) return obj;
        var s = '',
            app, sign, title, pic, package = '';
        $(TABLE).each(function(i, o) {
            if (!o.sign || o.sign == 'myAppList') return;
            app = SYS.getApp(o.sign.split('_')[0]);
            if (!app) return true;
            title = o.title ? o.title : app.title;
            sign = o.sign;
            package = app.package ? app.package + '.' : '';
            s += '|<a class="app" fun="' + package + sign + '">' + title + '</a>'
        });
        var link = {
            '': '快捷入口'
        };
        if (L.togame && S.url) link['SYS.refUrl'] = '刷新CMS';
        if (L.togame && S.url) link['SYS.togame_url'] = L.togame;
        if (L.todev && S.url2) link['SYS.togame_url2'] = L.todev;
        if (L.todemo && S.dev_config && S.dev_config.appUrl && $.inArray(MY.gid, [2, 35]) == -1) link['SYS.togame_dev_config.appUrl'] = L.todemo;
        if (L.togameno4 && S.urlno4) link['SYS.togame_urlno4'] = L.togameno4;
        if (L.togetdata) link[CGI.mfenter] = L.togetdata;
        if (L.unlockno4) link['SYS.no4Unlock'] = L.unlockno4;
        var toplink = TPL.script(function() {
            $('[name=toplink]').change(function() {
                var u = this.value;
                if (!u) return;
                this.value = '';
                if (u.indexOf('http') == 0) return window.open(u);
                SYS.appStr(u)
            })
        });
        s = toplink + COMM.getSelect({
                'name': 'toplink',
                'data': link,
                'attr': 'style="width:75px""'
            }) + s;
        s += '|<a class="app" fun="List.init" style="color:#0f0">快速提List</a>';
        if (vars.auth_apply && !VAR.isMobile) s += '|<a href="' + COMM.authApply() + '" target="_blank" style="color:#0f0">权限申请</a>';
        if (s) {
            obj.append(s)
        }
    },
    togame: function(s) {
        var url = '',
            temp = '';
        if (s.indexOf('.') != -1) {
            temp = s.split('.');
            if (temp[0] && temp[1] && S[temp[0]] && S[temp[0]][temp[1]]) url = S[temp[0]][temp[1]]
        } else {
            url = S[s]
        }
        window.open(url)
    },
    loadDeskTop: function(h) {
        h = h ? h : JQ.desktop.height();
        var n = parseInt(h / C.iconsize),
            s = '',
            l, t, app, sign, title, pic, fun, ii = 0,
            package = '';
        $(TABLE).each(function(i, o) {
            if (!o.sign) return true;
            app = SYS.getApp(o.sign.split('_')[0]);
            if (!app) return true;
            title = o.title ? o.title : app.title;
            pic = o.pic ? o.pic : app.pic;
            sign = o.sign;
            package = app.package ? app.package + '.' : '';
            exec();
            ii++
        });

        function exec() {
            l = parseInt(ii / n) * C.iconsize;
            t = parseInt(ii % n) * C.iconsize;
            s += "<a id='desktopPic_" + sign + "' class='app' fun='" + package + sign + "' style='left:" + l + "px;top:" + t + "px;'>" + getPng('_' + pic, 'p') + "<h1>" + title + "</h1><h2>" + title + "</h2><h3>" + title + "</h3><h4>" + title + "</h4><u>" + title + "</u></a>"
        }
        JQ.desktopPic.html(s)
    },
    loadFast: function() {
        var s = '',
            package = '';
        $(FAST).each(function(i, o) {
            app = SYS.getApp(o.sign);
            if (!app) return true;
            package = app.package ? app.package + '.' : '';
            s += "<a class='app' fun='" + package + o.sign + "' title='" + app.title + "'>" + getPng(app.pic, 'b') + "</a>"
        });
        JQ.myFast.html(s)
    },
    loadStart: function() {
        if (VAR.loadStart) return;
        $("#startMenuBottom").html('<a class="app" fun="sysRun"><img src="' + SKIN.sys + 'sysRun.gif" />运行</a><a class="app" fun="SYS.lockScreen"><img src="' + SKIN.sys + 'lockScreen.gif" />锁屏</a><a class="app" fun="SYS.quit"><img src="' + SKIN.sys + 'quit.gif" />注销</a><a class="app" fun="SYS.close"><img src="' + SKIN.sys + 'closesys.gif" />关闭系统</a>');
        var s = '',
            app, title, num = 0,
            pic, ii = 0,
            package = '';
        $('b', JQ.startMenuTop).html('<img src="' + SKIN.admingroup + 'admin.gif" />' + MY.name + ' ( ' + MY.gname + ' )');
        $('p', JQ.startMenuTop).html(getPng('_showTable', 'span'));
        $(START).each(function(i, o) {
            if (!o.sign) return true;
            app = SYS.getApp(o.sign.split('_')[0]);
            if (!app) return true;
            if (ii >= 15) return false;
            if (ii % 5 == 0 && ii > 0) s += '<a class="border"></a>';
            pic = o.pic ? o.pic : app.pic;
            title = o.title ? o.title : app.title;
            package = app.package ? app.package + '.' : '';
            s += '<a class="app" fun="' + package + o.sign + '">' + getPng(pic, 'p') + title + '</a>';
            ii++
        });
        JQ.startLeft.html(s);
        s = '<ul>';
        $(MENU).each(function(i, o) {
            app = SYS.getApp(o.sign);
            if (!app) return true;
            title = o.title ? o.title : app.title;
            package = app.package ? app.package + '.' : '';
            s += '<li class="menu_' + o.sign + '"><a class="app" fun="' + package + o.sign + '">' + getPng('__' + app.pic, 'p') + title + '</a></li>';
            num++
        });
        s += '</ul>';
        JQ.startRight.html(s);
        Delay(function() {
            var left, fun, app;
            $(MENU).each(function(i, o) {
                num--;
                app = SYS.getApp(o.sign);
                left = app.left;
                if (!left) return true;
                $.gets(left, function(s) {
                    $('.menu_' + o.sign).append(s);
                    if (num <= 0) JQ.startRight.menu('haschild', 'Hover')
                })
            });
            $('> ul > li > a', JQ.startRight).mouseenter(function() {
                app = SYS.getApp($(this));
                if (app) $('p', JQ.startMenuTop).html(getPng('_' + app.pic, 'span'))
            })
        }, 100);
        VAR.loadStart = true
    },
    setHover: function() {
        $('.myTable tr').live('mouseenter', function() {
            if ($(this).hasClass('notBgCg') || $(this).hasClass('myTableTitle')) return;
            $(this).addClass('hover')
        }).live('mouseleave', function() {
            $(this).removeClass('hover')
        })
    },
    clear: function() {
        JQ.startMenu.hide();
        JQ.rightMenu.hide();
        JQ.checkFormMes.html('')
    },
    delDeskTop: function(sign) {
        var temp = [],
            i;
        for (i in TABLE) {
            if (TABLE[i].sign != sign) temp.push(TABLE[i])
        }
        TABLE = temp;
        $.get(CGI.ajax + '?cmd=delDeskTop&sign=' + sign)
    },
    refPage: function() {
        location.href = location.href
    },
    showTable: function() {
        for (var i in WIN) {
            if (i != 0 && WIN[i] && !WIN[i].opt.keepOpen) {
                WIN[i].Min(true)
            }
        }
    },
    closeAll: function() {
        for (var i in WIN) {
            if (i != 0 && WIN[i] && !WIN[i].opt.keepOpen) {
                Confirm('确定关闭所有程序窗口？', function() {
                    for (var i in WIN) {
                        if (i != 0 && WIN[i] && !WIN[i].opt.keepOpen) WIN[i].close()
                    }
                });
                return
            }
        }
        Alert('当前没有程序开启！', {
            time: 3000
        })
    },
    lockScreen: function() {
        M.lock = true;
        cookie('lockScreen', 1);
        VAR.enterSubmit = function() {
            SYS.openScreen()
        };
        M.show(C.loginbg + "<div class='sysCloseFace'><h1>锁屏</h1><div><b>请输入密码：<input type='password' id='lockPwd' /></b></div><p><input type='button' value='确定' class='app' fun='SYS.openScreen' /></p></div>", {
            alpha: 1
        });
        $('#lockPwd').focus()
    },
    openScreen: function() {
        var obj = $('#lockPwd');
        var pwd = obj.val();
        if (pwd == '') {
            obj.val('').focus();
            return false
        }
        $.get(CGI.login + '?cmd=openScreen&pwd=' + pwd, function(data) {
            if (data && data.indexOf('{ok}') >= 0) {
                cookie('lockScreen', null);
                M.lock = false;
                M.close();
                SYS.defApp()
            } else {
                obj.val('').focus();
                return false
            }
        })
    },
    quit: function() {
        Confirm('确定登出？', function() {
            COMM.notLogin('quit')
        })
    },
    close: function() {
        M.lock = true;
        M.show("<div class='sysCloseFace'><h1>" + L.sys.close + "</h1><div><a class='app' fun='SYS.closeY'><img src='" + SKIN.sys + "closes.gif' />" + L.btn.close + "</a><a class='app' fun='SYS.reStart'><img src='" + SKIN.sys + "restart.gif' />" + L.sys.reload + "</a></div><p><input type='button' value='" + L.btn.cancel + "' class='app' fun='M.close' /></p></div>", {
            alpha: 0.5
        })
    },
    closeY: function() {
        Msg.close();
        $.get(CGI.login + '?cmd=quit');
        this.window.opener = null;
        window.open('', '_parent', '');
        window.close();
        goTo()
    },
    reStart: function() {
        goTo()
    },
    setWin: function(str) {
        try {
            eval('WIN[0].' + str + '()')
        } catch (e) {}
    },
    switchwindow: function(par) {
        var id = 'window_' + par;
        if (WIN[id]) WIN[id].display()
    },
    myAppList: function(obj) {
        var i, temp = '<div class="icons">',
            app, sign, title, pic, package = "";
        VAR.funStrTemp = VAR.funStr;
        for (i in APP) {
            if (APP[i].notList) continue;
            app = SYS.getApp(i);
            if (!app) continue;
            title = app.title;
            pic = app.pic;
            package = APP[i].package ? APP[i].package + "." : "";
            temp += '<a id="myAppList_' + package + i + "_" + WIN[0].id + '" class="app" fun="' + package + i + '">' + getPng('_' + pic, 'p') + '<u>' + title + '</u></a>'
        }
        obj = obj ? obj : RIGHT;
        obj.html(temp + '</div>');
        VAR.funStr = VAR.funStrTemp
    },
    adminIo: function(obj) {
        return COMM.adminIo(obj)
    },
    setTopMenu: function() {
        var s = '',
            c = '',
            f, fun;
        if (VAR.applistArr[0]) {
            $.each(VAR.applistArr[0], function(i, o) {
                if (o.notList || o.sign && !SYS.allow(o.sign)) return;
                f = o.sign + COMM.appPar(o, 1);
                if (o.blank) {
                    fun = 'target="_blank" href="' + location.href.split('#')[0] + '#' + f + '"'
                } else {
                    fun = 'fun="' + f + '"'
                }
                s += '<li><a class="app topid' + o.topid + '" ' + fun + '>' + o.title + '</a>' + getChild(o) + '</li>'
            })
        }
        JQ.normalMenu.html(s);
        $('>li', JQ.normalMenu).live('mouseenter', function() {
            $('.child', this).show();
            $('a', this).first().addClass('hover')
        }).live('mouseleave', function() {
            $('.child', this).hide();
            $('a', this).first().removeClass('hover')
        });
        $('li>a[fun=""]', JQ.normalMenu).each(function() {
            var fun = $(this).next().find('a').attr('fun');
            fun && $(this).attr('fun', fun)
        });

        function getChild(o) {
            var s = '',
                f, fun;
            if (!VAR.applistArr[o.id]) return '';
            $.each(VAR.applistArr[o.id], function(ii, oo) {
                f = oo.sign ? oo.sign : o.sign;
                if (oo.notList || !SYS.allow(f)) return;
                f += COMM.appPar(oo, 1);
                if (oo.blank) {
                    fun = 'target="_blank" href="' + location.href.split('#')[0] + '#' + f + '"'
                } else {
                    fun = 'fun="' + f + '"'
                }
                s += '<a class="app" ' + fun + '>' + oo.title + '</a>'
            });
            return s ? '<div class="child">' + s + '</div>' : ''
        }
    },
    clearTemp: function() {
        Msg.doing();
        $.get(CGI.ajax + '?cmd=clearTemp', function(ret) {
            Msg.close();
            Msg.ok()
        })
    },
    by_cfgon: function(i) {
        VAR.by_cfgon = i.checked ? 1 : 0
    },
    keyEvt: function() {
        $(document).keydown(function(e) {
            if (e.keyCode == 13) {
                var dom = getDom(e);
                if (WIN[0] && WIN[0].opt.enter && (dom.tagName != 'TEXTAREA' || dom.className == 'isEnter') && dom.name != 'appRun' && typeof(VAR.enterSubmit) == 'function' && !VAR.enterLock) VAR.enterSubmit();
                if (dom.tagName == 'TEXTAREA' && dom.className == 'isEnter') {
                    SO.submit(2);
                    return false
                }
            }
            if (WIN[0] && WIN[0].opt.esc && e.keyCode == 27) {
                WIN[0].close();
                return false
            }
            if (!VAR.lock) return;
            switch (e.keyCode) {
                case 27:
                    WIN[0].close();
                    break;
                case 32:
                case 13:
                    if ($o('[fun=okFun]')[0]) {
                        okFun()
                    } else {}
                    break
            }
        })
    },
    helpEvt: function() {
        $('.help').live('click', function() {
            var I = $(this),
                key = I.attr('key');
            if (key) {
                if (key.indexOf('http') === 0) {
                    window.open(key)
                } else {
                    SYS.helpLoad(key, I.attr('w'), I.attr('h'))
                }
            } else {
                var s = I.attr('title');
                if (s) {
                    s = escape(s).replace(/%0D/g, '<br>');
                    s = unescape(s)
                } else {
                    s = I.html()
                }
                Alert('<ul style="padding:0 10px 0 25px"><li>' + s + '</li></ul>', {
                    title: L.syshelp,
                    img: 'NULL',
                    pic: 'sysHelp'
                })
            }
        })
    },
    helpLoad: function(key, w, h) {
        $.get(PATH.help + vars.langfix + '/' + key + '.html?' + vars.versions, function(s) {
            Alert('<div style="margin:5px 10px">' + s + '</div>', {
                title: L.syshelp,
                img: 'NULL',
                pic: 'sysHelp',
                width: w || 500,
                height: h || 300
            })
        })
    },
    help: function(s, t) {
        if (t == 'key') {
            return '<i class="help" key="' + s + '"></i>'
        } else if (t) {
            return '<i class="help">' + s + '</i>'
        } else {
            return '<i class="help" title="' + s + '"></i>'
        }
    },
    gameid: function() {
        return vars.api == 2 ? 1 : vars.api
    },
    sites: function(cfg, fn) {
        S = cfg;
        if (S.timezone) $D.timezone = S.timezone;
        vars.cdn = S.cdn;
        if (vars.sysname != 'cms') C.cdn = S.cdn;
        S.name = L.S[S.id];
        S.imagesUrl = S.cdnImg = vars.imagesUrl = S.cdn + 'images/';
        S.apicked = cookie('cmsApicked') || 0;
        cookie('versions', S.versions);
        vars.versions = S.versions;
        var s = L.platformname + '：',
            main = S.fid != S.id && S.fid ? '' + L.S[S.fid] + '(' + S.fid + ')<b class="zh" style="margin:0 3px;color:#aaa">→</b>' : '';
        s += '<a class="app" fun="changeSid" title="' + l(L.platformtip, [L.config[vars.langfix]]) + '">' + main + S.name + '(' + (S.langfix ? S.langfix + ',' : '') + S.id + ')</a>';
        var have_demo = vars.sysname === 'cms' || vars.sysname === 'ipk' || vars.sysname === 'kop';
        if (!C.dev || MY.id == 438) {
            if (vars.server == 2) {
                if (have_demo) s += '<a onclick="SYS.refUrl(0,1)"><b style="color:#0f0">[内网]</b></a>';
                S.jsonp = S.cmsapidemo
            } else {
                if (have_demo) s += '<a onclick="SYS.refUrl(0,2)"><b style="color:red">[外网]</b></a>';
                S.jsonp = S.cmsapi
            }
        }
        if (vars.sysname === 'cms') s += COMM.getSelect('_api', L.api, '', 'onchange="SYS.changeApi(this)"');
        $('#normalHead u>span').eq(0).html(s);
        $('select[name=_api] option[value=' + vars.api + ']').attr('selected', true);
        SYS.dataLanLoad(fn);
        document.title = '【' + S.name + '】' + $('#normalHead p:eq(0)').html();
        S._blowup = S.blowup > 1 ? '<b style="font-weight:bold;font-size:14px;color:red" title="这是游戏币需要加乘的倍数；这样标示还要填错的同学，直接拖出去枪毙了！">×' + S.blowup + '</b>&nbsp;' : '';
        COMM.toHref();
        if (typeof s == 'undefined') fn()
    },
    refUrl: function(sid, server) {
        var _i = int(cookie('_i')),
            get = 0;
        if (sid == 'get') {
            sid = S.id;
            get = 1
        } else {
            _i++;
            cookie('_i', _i)
        }
        if (server) vars.server = server;
        if (vars.sysname === 'cms') {
            var host = C.dev ? 'vm.boyaa.com' : (vars.server === 1 ? 'cms.oa.com' : 'cmsdemo.oa.com'),
                server = vars.cache ? '' : '&server=' + vars.server,
                url = 'http://' + host + CMS_PATH + '?api=' + vars.api + '&sid=' + (sid || S.id) + server + '&' + _i + location.hash
        } else if (vars.sysname === 'ipk' || vars.sysname === 'kop') {
            var server = '&server=' + vars.server,
                url = location.origin + CMS_PATH + '?sid=' + (sid || S.id) + server + '&' + _i + location.hash
        } else {
            var server = vars.cache ? '' : '&server=' + vars.server,
                url = location.origin + CMS_PATH + '?sid=' + (sid || S.id) + server + '&' + _i + location.hash
        }
        if (get) return url;
        location.href = url
    },
    changeMode: function(k, i) {
        cookie(k, i.value, {
            expires: 365
        });
        SYS.refUrl()
    },
    changeApi: function(i) {
        vars.api = vars.api = i.value;
        SYS.changeMode('_api', i)
    },
    changeLan: function(i) {
        $.JSON(CGI.ajax + '?cmd=sysLang&v=' + i.value, function() {
            SYS.refUrl()
        })
    },
    window: function(opt, f, set) {
        var def = {
            id: 0,
            fid: WIN[0].appId,
            topid: WIN[0].topid,
            title: L.tip,
            pic: 'showTable',
            sign: 'diy' + VAR._window++,
            esc: WIN[0].opt.esc || 0,
            enter: WIN[0].opt.enter || 0,
            api: WIN[0].opt.api,
            fullScreen: 0,
            lock: false,
            js: '-',
            lockSize: true,
            notList: true,
            allow: true,
            diy: 1
        };
        if (opt && typeof opt === 'string') {
            if (f && typeof f == 'object') {
                set = f
            } else {
                set = obj(set);
                if (typeof f == 'function') set.init = f
            }
            set.right = opt;
            opt = set
        }
        if (opt && typeof opt == 'object') {
            if (!opt.title) opt.title = WIN[0].opt.title;
            if (opt.addtitle) opt.title += opt.addtitle;
            if (!opt.sign && opt.right) opt.sign = opt.right.replace(new RegExp('/', 'g'), '').replace('.html', '').replace('.tpl.php', '').split('?')[0].split('&')[0];
            $.extend(def, opt)
        }
        def.signs = def.sign;
        if (def.right) {
            if (def.right.indexOf('?') > 0) {
                var t = def.right.split('?');
                if (def.right.indexOf('.tpl.php') > 0 && t[1] && t[1].indexOf('=') > 0) {
                    def.right = def.right.replace('?', '&')
                } else {
                    def.right = t[0]
                }
                def.par = t[1] ? t[1].split('&')[0] : t[1];
                if (t[1] && t[1].indexOf('=')) {
                    var pars = {},
                        a = t[1].split('&');
                    $.each(a, function(k, v) {
                        v = v.split('=');
                        pars[v[0]] = v[1]
                    });
                    def.pars = pars
                }
            }
            if (!def.comm) {
                var s = def.right.split('/')[0];
                def.comm = APP[s] ? APP[s].comm : 0
            }
        }
        if (def.html && def.padding) def.html = '<div style="padding:' + def.padding + 'px">' + def.html + '</div>';
        SYS.app(def)
    },
    cancel: function() {
        var i = WIN[0].fromId;
        WIN[0].close();
        WIN[i].show()
    },
    del: function(cgi, re, callback, val) {
        var ids = val || getCheckBox('ids');
        if (ids == '') {
            Err(L.noselect);
            return
        }
        Confirm(re ? L.ifredel : L.ifdel, function() {
            Msg.doing();
            re = re ? 0 : 1;
            $.JSONP(cgi + '&del=' + re + '&ids=' + ids, function(ret) {
                Msg.close();
                $o('input[fun="checkAll_ids"]').attr('checked', false);
                COMM.suc(ret, function() {
                    P.ref();
                    if (typeof callback == 'function') callback()
                })
            })
        })
    },
    diyLang: function(pack, parent) {
        SYS._diyLang = [pack, parent];
        SYS.appStr('diyLangForm')
    },
    changeTab: function(def, fun) {
        if (def === 'not') {
            def = 0
        } else {
            $o('.changeTab').show()
        }
        var a = $o('.changeTab a');
        if (typeof fun !== 'function') fun = function(my) {
            var i = $(my).index(),
                o = $o('.changeTabs').hide().eq(i),
                u = o.attr('url');
            if (u) {
                o.html('').show().loads(u)
            } else {
                o.show()
            }
        };
        a.click(function() {
            var s = fun(this);
            if (s == '[stop]') return;
            $o('.changeTab a.on').removeClass('on');
            $(this).addClass('on')
        });
        if (typeof def !== 'undefined') a.eq(def).click()
    },
    service: function(n) {
        n = n || '100%';
        return COMM.swf(S.cdnImg + 'gifts/1277.swf', n, n)
    },
    tpl: function(f, t, id, param, cb) {
        var addurl = '',
            notld = 0;
        if (typeof f == 'object') {
            var o = f;
            f = o.from;
            t = o.to;
            id = o.id;
            param = o.param || '';
            cb = o.callback;
            if (o.addurl) addurl = '&' + o.addurl;
            notld = o.notld || 0
        }
        if (!notld) Msg.doing();
        if (f) f = f.replace('{langfix}', S.langfix).replace('{sid}', S.id);
        if (t) {
            t = t.replace('{langfix}', S.langfix).replace('{sid}', S.id);
            t = t.replace('[langfix]', S.langfix).replace('[sid]', S.id)
        }
        $.JSON(CGI.tpl + '?from=' + f + '&to=' + (t || f) + '&id=' + id + addurl, {
            'param': param
        }, function(ret) {
            Msg.close();
            if (typeof cb == 'function') {
                cb(ret)
            } else {
                if (notld) return;
                COMM.suc(ret)
            }
        })
    },
    sendonline: function(t) {
        Confirm('确定发布相关到文件正式环境？', function() {
            Msg.doing();
            $.JSON(CGI.ajax + '?cmd=sendOnline&type=' + t, function(ret) {
                Msg.close();
                var msg;
                if (ret && ret.ok) {
                    msg = '<b>发布成功，回滚版本号：</b><br>' + ret.rollback_key + '<br><b>文件列表：</b><br>' + ret.file
                } else {
                    msg = '<b style="color:red">发布失败！</b><br>' + ret.msg
                }
                SYS.window({
                    html: '<div style="padding:10px">' + msg + '</div>',
                    width: 500,
                    height: 300
                })
            })
        })
    },
    confirm: function(f) {
        var type = vars.server == 2 ? '内网' : (VAR.by_cfgon ? '线上' : 'no3');
        Confirm('目前是操作<b style="color:red">' + type + '环境</b>，请确认？', f)
    },
    bag: function(id, par, tag, e, aid) {
        $.getScripts([PATH.data + 'L/bag2lang.js?' + COMM.version(), PATH.data + 'act/' + S.id + '.js?' + COMM.version('actArr'), PATH.data + 'map/act.js?' + COMM.version('map.act'), PATH.data + 'map/gift.js?' + COMM.version('map.gift'), PATH.data + 'gift/' + S.id + '.js?' + COMM.version('giftArr'), PATH.data + 'map/prop.js?' + COMM.version('map.prop'), PATH.data + 'collects/' + S.langfix + '.js?' + COMM.version('collectArr'), PATH.data + 'real/' + S.langfix + '.js?' + COMM.version('realArr'), PATH.data + 'levels/' + S.id + '.js?' + COMM.version('levelsArr'), PATH.data + 'map/levels.js?' + COMM.version('map.levels'), PATH.dbfile + 'comm/mycardtype.js?' + COMM.version('mycardArr'), PATH.dbfile + 'mycard.js?' + COMM.version('mycardArr')], function() {
            if (id == 'init') return;
            if (id === 'ac3') return SYS.appStr('bagform_' + par);
            SYS._bagDef = '';
            if (par) try {
                eval(par + '()')
            } catch (e) {
                echo('SYS.bag', par, e)
            }
            SYS._bagCallback = id == 0 && e ?
                function(id) {
                    $(e).parent().html(TPL.bag(id, {}, par, tag))
                } : '';
            SYS.appStr('bagform_' + (id || 0) + ',' + (aid || 0))
        })
    },
    bagView: function(id, e, aid) {
        $('#bagView').remove();
        $(document.body).append('<div id="bagView"></div>');
        var o = $('#bagView'),
            pos = COMM.mousePos(e),
            top = pos.y,
            left;
        $.get($.cmsAjax(CGI.bag + '?cmd=view&id=' + id + '&aid=' + (aid || 0)), function(ret) {
            o.html(ret).show();
            if (o.height() > 400) o.height(400);
            var h = o.height();
            if (top > $(document.body).height() - h) top -= h - 5;
            o.css({
                'left': pos.x - o.width() / 2,
                'top': top - 8
            })
        })
    },
    auditIng: function(start, on, end, sid, api) {
        if (typeof start === 'object') {
            sid = int(start.sid);
            api = int(start.api) || vars.api;
            on = int(start.levelon);
            end = int(start.levelend);
            start = int(start.levelstart)
        } else {
            sid = int(start.sid);
            api = int(start.api) || vars.api;
            on = int(start.levelon);
            end = int(start.levelend);
            start = int(start.levelstart)
        }
        var i, s = [];
        for (i = Math.max(start, 1); i <= Math.min(end, 3); i++) {
            if (start && start.levelon && !start.log) continue;
            if (S.auditor0 && S.auditor0[api * 10] && i == Math.max(start, 1)) s.push(TPL.uid(S.auditor0[api * 10]));
            s.push(TPL.uid(S.auditorall[S.sid2fid[sid]][i * 10 + api]))
        }
        if (s[on]) s[on] = '<u>' + s[on] + '</u>';
        return s.join(' <i class="zh">-></i> ').replace(/,/g, '/')
    },
    diffcfg: function(file) {
        Msg.doing();
        $.JSONP(S.cmsapi + 'api.php?cmd=diffcfg', {
            'file': file || ''
        }, function(ret) {
            Msg.close();
            SYS.window({
                width: '80%',
                height: '80%',
                title: '与线上配置差异比较(左右无差异表示正常)',
                html: ret.diffcfg
            })
        })
    },
    no4Unlock: function(file) {
        Confirm('确定解锁NO4？', function() {
            Msg.doing();
            $.JSONP(S.cmsapi + 'api.php?cmd=no4Unlock', function(ret) {
                Msg.close();
                COMM.suc(ret)
            })
        })
    },
    outXml: function(t) {
        return Err('此功能已经废弃');
        var f = function() {
            $.getScript(PATH.data + 'map/otable.js?' + COMM.version('otable'), function() {
                var defTab = ['tbltb', 'tblsng', 'tblbonus'];
                var cfgTab = ['tblTimeSmallBlind', 'tblrapidconfig', 'tblmatchpropcfg', 'tblpropcfg', 'tblhandcard', 'tbrobot', 'tblgfscfg'];
                var html = '',
                    tmp, name = '',
                    tab, checked = '';
                html += '<table class="myTable notBgCg left"><tr><td>' + '<label class="checkbox"><input type="checkbox" class="app" fun="checkAll_otable" title="反选" />反选</label>' + '<label class="checkbox"><input type="checkbox" class="app" fun="checkAll_otable,all" title="全选/取消" />全选/取消</label>' + ' <strong style="color:red">注：1、红色字样的表数据可能比较多，建议逐一选择导出；2、为了避免超时，选项请不要超过24项！</strong></td></tr><tr><td>';
                $.each(VAR.otable, function(i, o) {
                    if ($.inArray(i, defTab) == -1) return;
                    tmp = o.val ? eval(o.val) : '';
                    if (tmp && tmp[0]) {
                        html += '<label class="checkbox" style="float:left;width:420px;border:1px solid #ccc;margin:3px;padding:3px">';
                        if (tmp[0].indexOf('table') != -1) {
                            tab = '<u>' + tmp[0] + '</u>'
                        } else if ($.inArray(i, cfgTab) != -1) {
                            tab = '<i>' + tmp[0] + '</i>';
                            checked = ' checked="checked" '
                        } else {
                            tab = '<b>' + tmp[0] + '</b>'
                        }
                        html += '<span style="width:160px"><input type="checkbox" name="otable" ' + checked + ' value="' + i + '">' + tab + '</span>';
                        html += tmp[1] ? ' <span style="width:120px"><i>' + tmp[1] + '</i></span>' : '';
                        html += '</label>'
                    }
                    checked = ''
                });
                html += '</td></tr></table>';
                SYS.window({
                    width: '80%',
                    height: '80%',
                    title: '请选择需要导出的表',
                    html: '<table>' + html + '<div class="myBtns"><input type="button" value="确定" onclick="SYS.doOutXml(\'' + t + '\')"></div></div>'
                })
            })
        };
        Confirm('确定导出dbXml？', f)
    },
    cdncopy: function(from, to, fn) {
        if (!from) return Err('缺少必要参数SYS.cdncopy(from)！');
        Msg.doing();
        $.JSON(CGI.ajax + '?cmd=cdncopy&file=' + from + '&to=' + (to || ''), function(ret) {
            Msg.close();
            COMM.suc(ret);
            if (typeof fn == 'function') fn(ret)
        })
    },
    doOutXml: function(t) {
        var f = new Form(RIGHT);
        if (!f.check()) return;
        if (t == 'tables' && !f.data['otable']) return Msg.err('请至少选择一个表进行导出！');
        if (f.data['otable'].split(',').length > 24) return Msg.err('为了避免超时，选项请不要超过24项！');
        var tab = (t == 'tables' && f.data['otable']) ? '&tables=' + f.data['otable'] : '';
        Msg.doing();
        $.JSONP(S.cmsapi + 'api.php?cmd=outXml&memory_limit=1&type=' + t + tab, function(ret) {
            Msg.close();
            COMM.suc(ret, function() {
                var aArr = [];
                if (t == 'tables' && f.data['otable']) {
                    var url, def, zip, html = '';
                    $.each(ret.table, function(i, o) {
                        url = S.cmsapi.replace('cmsapi/', 'data/'), def = o.def, zip = o.zip, html;
                        html += '未压缩：<a href="' + url + def[0] + '" target="_blank">' + url + def[0] + '(' + def[1] + 'K)' + '</a><br>';
                        html += '压缩：<a href="' + url + zip[0] + '" target="_blank">' + url + zip[0] + '(' + zip[1] + 'K)' + '</a><br><br>';
                        if (url && def[0] && (url + def[0])) aArr.push(url + def[0])
                    })
                } else {
                    var url = S.cmsapi.replace('cmsapi/', 'data/'),
                        def = ret.def,
                        zip = ret.zip,
                        html;
                    html = '未压缩：<a href="' + url + def[0] + '" target="_blank">' + url + def[0] + '(' + def[1] + 'K)' + '</a><br>';
                    html += '压缩：<a href="' + url + zip[0] + '" target="_blank">' + url + zip[0] + '(' + zip[1] + 'K)' + '</a>'
                }
                SYS.window({
                    width: '600',
                    height: '300',
                    title: '导出dbXml',
                    html: '<div style="padding:10px">' + html + '</div>'
                });
                if (aArr) $.JSON(CGI.tables + '?cmd=sendXml&file=' + aArr.join(), function() {})
            })
        })
    }
};
$.fn.appRun = function(run) {
    new appRun().init(this, run);
    return this
};
var appRun = function() {
    var I = this,
        $run, $ipt, $list;
    I.init = function(dom, run) {
        run = run ? '<input type="button" value="' + L.run + '" />' : '';
        dom.html('<input class="run" />' + run + '<div class="run appList"></div>');
        $run = run;
        $ipt = $('input.run', dom);
        $list = $('div.appList', dom);
        $ipt.val(L.app.defText);
        $ipt.focus(function() {
            if (this.value == L.app.defText) this.value = ''
        }).blur(function() {
            if (this.value == '') this.value = L.app.defText;
            setTimeout(function() {
                $list.hide()
            }, 300)
        }).keyup(function() {
            _list()
        }).keydown(function(e) {
            if (e.keyCode == 13) setTimeout(_submit, 200)
        });
        if (!run) return;
        dom.find('input[value="' + L.run + '"]').click(_submit)
    };
    var _list = function() {
        var v = $ipt.val();
        if (v == '') {
            $list.hide();
            return
        }
        var i, temp = '',
            tit = '',
            n = 0,
            loaded = {},
            v2 = '<b>' + v + '</b>';
        for (i in APP) {
            if (loaded[i] || APP[i].notList || !SYS.allow(i) || !APP[i].title) continue;
            tit = APP[i].title;
            if (i.indexOf(v) == 0 || tit.indexOf(v) == 0) {
                loaded[i] = 1;
                temp += '<a val="' + i + '"><em>' + i.replace(v, v2) + '</em>' + tit.replace(v, v2) + '</a>';
                if (++n > 10) break
            }
        }
        if (n < 10) {
            for (i in APP) {
                if (loaded[i] || APP[i].notList || !SYS.allow(i) || !APP[i].title) continue;
                tit = APP[i].title;
                if (i.indexOf(v) > 0 || tit.indexOf(v) > 0) {
                    loaded[i] = 1;
                    temp += '<a val="' + i + '"><em>' + i.replace(v, v2) + '</em>' + tit.replace(v, v2) + '</a>';
                    if (++n > 10) break
                }
            }
        }
        if (n < 10 && VAR.applist) {
            $.each(VAR.applist, function(ii, o) {
                if (!o.sign || o.sign == 'other') return;
                tit = o.title;
                i = o.sign + (o.par == '' ? '' : '_' + (o.par === '-1' ? o.id : o.par));
                if (!loaded[i] && (i.indexOf(v) >= 0 || tit.indexOf(v) >= 0)) {
                    loaded[i] = 1;
                    temp += '<a val="' + i + '"><em>' + i.replace(v, v2) + '</em>' + tit.replace(v, v2) + '</a>';
                    if (++n > 10) return false
                }
            })
        }
        if (temp) {
            $list.show().html(temp);
            $list.find('a').click(function() {
                var v = $(this).attr('val');
                $ipt.val(v);
                if ($run) SYS.app(SYS.getApp(v));
                $list.hide()
            })
        } else {
            $list.hide().html('')
        }
    };
    var _submit = function() {
        Msg.close();
        var v = $ipt.val();
        if (v == '' || v == L.app.defText) {
            Msg.err(L.app.defText);
            $ipt.focus();
            return
        }
        if (v && v.toString().indexOf('(') > 0) {
            try {
                eval(v)
            } catch (e) {
                Msg.err(e)
            };
            $list.hide();
            return
        }
        var app = SYS.getApp(v);
        if (!app) {
            app = $list.find('a');
            if (app[0]) {
                app = app.eq(0).attr('val');
                app = SYS.getApp(app)
            } else {
                app = false
            }
            if (!app) {
                Msg.err(l(L.app.error, [v]));
                return
            }
        }
        SYS.app(app);
        $list.hide()
    }
};
var Tj = new function() {
    var I = this;
    I.init = function() {};
    I.send = function(e, fun) {
        if (C.dev) return;
        var p = {
            x: e.clientX,
            y: e.clientY,
            sign: fun,
            from: WIN[0].sign,
            w: $(window).width(),
            h: $(window).height()
        };
        p.top = RIGHT && typeof RIGHT.scrollTop == 'function' ? RIGHT.scrollTop() : 0;
        $.POST(CGI.ajax + '?cmd=tj', p)
    }
};
var COMM = {
    json: function(o) {
        return $.toJSON(o)
    },
    arg2obj: function(d) {
        d = Array.prototype.slice.call(d);
        var f = d[0];
        d.shift();
        return [f, d]
    },
    unserialize: function(s) {
        if (!s) return {};
        var r = {},
            arr = s.split(',');
        $.each(arr, function(i, o) {
            if (!o) return;
            o = o.split(':');
            r[$.trim(o[0])] = $.trim(o[1])
        });
        return r
    },
    init: function() {
        L.btn.edits = '<img src="' + SKIN.img + 'edit.png" title="' + L.btn.edit + '" />';
        L.dateLocal = SYS.help(L.dateLocal);
        M.cssInit();
        if (typeof sys_init == 'function') sys_init()
    },
    authApply: function() {
        var url = 'http://cms.oa.com/doc/170.html';
        if (!vars.auth_apply) return url;
        url = 'http://auth.oa.com/?sid=' + vars.newsso + '#apply';
        if (C.dev) url = 'http://vm.oa.com/auth/?sid=' + vars.newsso + '#apply';
        return url
    },
    UC: function(name, val, opt) {
        return TPL.UC(val, '', '', name, opt)
    },
    uCheck: function(name, val, opt, id) {
        id = id || COMM.fmtId(name);
        $('#uc_' + id).uCheck(name, val, opt)
    },
    fmtId: function(s) {
        return s.toString().replace(/\[|\]/g, '_')
    },
    unidArr: function(add, s) {
        s = s ? '$s' : '';
        if (!S.sameSite) S.sameSite = [S.id];
        if (S.sameSite && S.sameSite.length) {
            var ret = {};
            $.each(S.sameSite, function(i, o) {
                ret[s + o] = o + ' - ' + L.S[o]
            });
            if (add && vars.sysname === 'cms') {
                var sp = {
                    79: L.visitor,
                    233: L.bymbpass,
                    237: L.mbTwitter,
                    238: L.mbYahoo
                };
                $.each(sp, function(i, o) {
                    ret[s + i] = i + ' - ' + o
                })
            }
            return ret
        }
        return ['数据异常']
    },
    notLogin: function(type) {
        var u = CGI.login + '?cmd=toAuth&href=' + encodeURIComponent(location.href);
        if (type === 'quit') u += '&quit=1';
        location.href = u
    },
    page: function(opt) {
        opt = obj(opt);
        var p = WIN[0].pageObj;
        if (!p) {
            p = P.init('', WIN[0].appId);
            p.$appname = WIN[0].title;
            WIN[0].pageObj = p
        }
        if (!opt.size) {
            opt.size = int(cookie('pagesize'));
            if (!opt.size) opt.size = p.$size
        }
        p.set(opt);
        return p
    },
    version: function(name, t) {
        if (!name) return vars.versions;
        if (t) cookie(name, M.microtime());
        t = cookie(name);
        if (!t) {
            t = M.microtime();
            cookie(name, t)
        }
        return vars.versions + t
    },
    apiSelect: function(name, evt, type) {
        var data = {},
            label = vars.sysname === 'kop' ? '=请选择版本ID=' : '=请选择站点ID=',
            apiArr = S.apiArr;
        if (typeof evt == 'object') {
            apiArr = evt;
            evt = ''
        }
        $.each(apiArr, function(i, o) {
            if (!S.apicked) S.apicked = i;
            if (type && o[1] != type && vars.sysname !== 'kop') return;
            if (vars.sysname === 'kop') {
                data[i] = i + ' - ' + o.name
            } else {
                data[i] = i + ' - ' + L.S[o[0]] + '(' + o[0] + ')'
            }
        });
        evt = 'COMM.apiSelectCb(this);' + (evt || '');
        return COMM.getSelect(name, data, '<optgroup label="' + label + '"></optgroup>', ' onchange="' + evt + '"', S.apicked)
    },
    apiSelectCb: function(i) {
        cookie('cmsApicked', i.value, {
            expires: 365
        });
        S.apicked = i.value
    },
    delApicked: function() {
        cookie('cmsApicked', 0, {
            expires: -1
        })
    },
    show: function(i) {
        var obj = $o('.myTable');
        if (i == 'all') {
            obj.show()
        } else {
            obj.hide();
            obj.eq(i).show()
        }
        COMM.setTitleAndOn()
    },
    setTitleAndOn: function() {
        $('a', WIN[0].left).removeClass('on');
        VAR.self.addClass('on');
        WIN[0].setGuid()
    },
    setAttr: function(table, set) {
        var obj = $o('.setAttr'),
            I, id, v, pic;
        if (!set) obj.hide();
        set = set.split(',');
        obj.each(function(i, o) {
            I = $(this);
            if (i == 0) {
                v = I.html('');
                $.each(set, function(ii, s) {
                    I.append('<i>' + s + '</i>')
                })
            } else {
                id = I.attr('id');
                v = I.html();
                I.html('');
                $.each(set, function(ii, s) {
                    pic = v && v.indexOf(s) >= 0 ? 'on.gif' : 'off.gif';
                    I.append('<img src="' + SKIN.img + pic + '" class="app" fun="COMM.setAttrExec_' + table + ',' + id + ',' + s + '" />')
                })
            }
        })
    },
    setAttrExec: function(table, id, attr) {
        Msg.doing();
        $.get(CGI.ajax + '?cmd=setAttr&table=' + table + '&id=' + id + '&attr=' + encodeURI(attr), function(s) {
            Msg.close();
            if (s == 'on' || s == 'off') VAR.self.attr('src', SKIN.img + s + '.gif');
            else Msg.err('操作失败！')
        })
    },
    openUrl: function() {
        var url = VAR.self.val();
        if (url) window.open(url)
    },
    del: function(re, table, sign, callback) {
        SYS.del(CGI.ajax + '?cmd=del&table=' + table + '&key=id&sign=' + (sign || table), re, callback)
    },
    dels: function(re, table, sign, callback) {
        SYS.del(S.cmsapi + table + '.php?cmd=del&table=' + table + '&sign=' + (sign || table), re, callback)
    },
    lock: function(re, table, cgi, callback) {
        var ids = getCheckBox('ids');
        if (ids == '') {
            Err(L.nodata);
            return
        }
        Msg.doing();
        cgi = cgi ? cgi : CGI.ajax;
        re = re ? 0 : 1;
        $.get(cgi + '?cmd=lock&table=' + table + '&lock=' + re + '&ids=' + ids, function(ret) {
            Msg.close();
            $o('input[fun="checkAll_ids"]').attr('checked', false);
            COMM.suc(ret, function() {
                P.ref();
                if (typeof callback == 'function') callback()
            })
        })
    },
    sorts: function(v, rs, par) {
        return Sort.tplfun(v, rs, par)
    },
    sort: function(table, db) {
        Sort.exec(table, db)
    },
    suc: function(ret, fn) {
        if (!ret) {
            if (!COMM._err) M.err('<b>[COMM.suc]</b><br>' + L.error);
            COMM._err = 0
        } else {
            try {
                ret.msg = eval(ret.msg)
            } catch (e) {}
            var f = (ret.tiptype || 'Msg.ok/Msg.err').split('/');
            var run = function(s, v) {
                var fn = eval(f[v]);
                fn(s)
            };
            if (ret.ok || (typeof ret == 'string') && (ret.indexOf('{ok}') >= 0 || ret.indexOf('"ok":1') > 0)) {
                run(ret.msg, 0);
                if (typeof fn == 'function') fn(ret)
            } else if (ret.msg) {
                run(ret.msg, 1)
            } else if (typeof ret == 'string') {
                run(ret, 1)
            } else {
                pp(ret)
            }
        }
    },
    jsonCb: function(ret, fn) {
        if (!ret) {
            Msg.close();
            M.err('<b>[COMM.jsonCb]</b><br>' + L.error);
            COMM._err = 1
        }
        editLock.tips(ret);
        COMM.sucErr(ret && ret.msg ? ret.msg : '', function() {
            if (typeof fn == 'function') fn(ret)
        })
    },
    sucErr: function(s, f) {
        s = s.toString();
        if (s.indexOf('notLogin') >= 0) {
            Msg.close();
            M.err(L.notLogin, {
                callback: COMM.notLogin
            })
        } else if (s.indexOf('notAllow') >= 0) {
            Msg.close();
            M.err(COMM.notAllowTip(s), {
                callback: function() {
                    goTo(-1)
                }
            })
        } else {
            f()
        }
    },
    notAllowTip: function(s) {
        var tag = s ? s.toString().split('notAllow')[1] : '';
        tag = tag ? '【' + tag.replace(':', '') + '】' : '';
        var s = L.notAllow + tag;
        if (typeof U == 'undefined') s += '<br><i>点击右上方入口 <a href="' + COMM.authApply() + '" target="_blank" style="color:green">权限申请</a> 可以自主申请权限！</i>';
        return s
    },
    toHref: function() {
        var href = cookie('location_href');
        if (href) {
            cookie('location_href', '');
            location.href = href
        }
    },
    clearInput: function(s) {
        $o('[name=' + s + ']').val('')
    },
    appPar: function(o, t) {
        var r;
        if (o.par == '-1') {
            r = o.id
        } else {
            r = typeof o.par != 'undefined' ? o.par : ''
        }
        if (t) {
            return r ? '_' + r : ''
        } else {
            return r
        }
    },
    applistLeft: function(set) {
        var opt = {
            'fun': '',
            'setfun': 0,
            'fid': WIN[0].topid,
            'my': '',
            'child': ''
        };
        if (set) $.extend(opt, set);
        var _list = function(fid, deep) {
            var s = '',
                f, p, c, fun;
            var arr = VAR.applistArr[fid];
            if (arr) {
                var app = VAR.applist[fid] || {},
                    fsign = app.sign || app._fun;
                $.each(arr, function(i, o) {
                    if (o.notList == 1) return;
                    f = o.sign || opt.fun || fsign;
                    if (!f) return;
                    p = COMM.appPar(o, 1);
                    if (APP[f] && APP[f].childmenu) {
                        c = '<ul></ul>';
                        (f == opt.my) && (c = opt.child)
                    } else {
                        if (opt.setfun && deep == 1) f = opt.fun;
                        VAR.applist[o.id]._fun = f;
                        c = _list(o.id, deep + 1)
                    }
                    if (o.blank) {
                        fun = 'target="_blank" href="' + location.href.split('#')[0] + '#' + f + p + '"'
                    } else {
                        fun = 'fun="' + f + p + '"'
                    }
                    s += '<li><a class="app" ' + fun + '>' + o.title + '</a>' + c + '</li>'
                })
            }
            if (s) s = '<ul>' + s + '</ul>';
            return s
        };
        var s = _list(opt.fid, 1);
        return WIN[0].loadLeft(s)
    },
    cmsSelect: function(fid, name, model, def, attr) {
        if (fid && typeof fid == 'object') {
            var o = fid;
            fid = o.fid;
            name = o.name;
            model = o.model;
            def = o.def;
            attr = o.attr
        }
        var _child = function(fid, str, vals) {
                var o = VAR.applistArr[fid],
                    i, temp = '',
                    c, ck, val;
                for (i in o) {
                    if (o[i].notList == 2) continue;
                    val = COMM.appPar(o[i]);
                    c = _child(o[i].id, str + C.str1, vals + ',' + val);
                    ck = typeof def != 'undefined' && def == val ? ' selected="true"' : '';
                    temp += '<option fid="' + fid + '" id="' + o[i].id + '" child="' + (c ? 1 : 0) + '" values="' + vals + ',' + val + '" value="' + val + '"' + ck + '>' + str + '|- ' + o[i].title + '</option>';
                    temp += c
                }
                return temp
            },
            temp = '<select ' + (attr || '') + ' name="' + name + '" onchange="COMM.ckCmsSelect()" must="' + L.selectCid + '"><option value="">' + L.selectCid + '</option>',
            o, i, c, ck, val;
        for (i in VAR.applistArr[fid]) {
            o = VAR.applistArr[fid][i];
            if (model && o.sign && o.sign != model) continue;
            if (o.notList == 2) continue;
            val = COMM.appPar(o);
            c = _child(o.id, C.str1, val);
            ck = typeof def != 'undefined' && def == val ? ' selected="true"' : '';
            temp += '<option fid="' + fid + '" id="' + o.id + '" child="' + (c ? 1 : 0) + '" value="' + val + '"' + ck + '>|- ' + o['title'] + '</option>';
            temp += c
        }
        temp += '</select>';
        return temp
    },
    ckCmsSelect: function() {
        $o('select option[child=1]').attr('selected', false)
    },
    setCmsSelect: function(sel, fid, name, def, model) {
        $o(sel).html(COMM.cmsSelect(fid, name, model, def));
        COMM.ckCmsSelect()
    },
    count: function() {
        $o('.count').remove();
        VAR.self.after('<i class="count">' + l(L.inputcount, [VAR.self.val().length]) + '</i>')
    },
    repeat: function(s, t) {
        t = t ? t * 1000 : 60000;
        var time = microtime();
        if (!VAR.repeatTemp[s]) {
            VAR.repeatTemp[s] = time;
            return false
        } else {
            var ts = t - (time - VAR.repeatTemp[s]);
            ts = parseInt(ts / 1000);
            if (ts > 0) {
                Msg.err(l(L.toofast, [ts]));
                return true
            } else {
                VAR.repeatTemp[s] = time;
                Msg.clear();
                return false
            }
        }
    },
    setRadio: function(arr, rs, t) {
        var n, v;
        $.each(arr, function(i, o) {
            n = !rs || t ? i : o;
            v = rs ? rs[n] : o;
            $o('[name=' + n + '][value=' + v + ']').attr('checked', true)
        })
    },
    setCheckbok: function(arr, rs) {
        $.each(arr, function(i, o) {
            if (rs && rs[o]) {
                t = rs[o].split(',');
                $.each(t, function(ii, oo) {
                    $o('[name=' + o + '][value=' + oo + ']').attr('checked', true)
                })
            }
        })
    },
    fastText: function(obj, data, add) {
        var s = cookie('CMS_notice');
        s = s ? '<option value="0">' + s + '</option>' : '';
        return COMM.getSelect('', data, add ? '<option value="">' + add + '</option>' + s : '', ' id="' + obj + '" onchange="COMM.fastTextExec(this)" style="width:300px"')
    },
    fastTextExec: function(i) {
        var o = $(i.id);
        if (!o[0]) return;
        var v = i.value ? $('option:selected', i).html() : '';
        $('option:selected', i).attr('selected', false);
        o.val(v).focus()
    },
    getSelect: function(name, data, add, attr, def, showId) {
        var o;
        if (name && typeof name == 'object') {
            o = name
        } else {
            o = {
                'name': name,
                'data': data,
                'add': add,
                'attr': attr,
                'def': def,
                'showId': showId
            }
        }
        var s = '<select defval="' + (o.def || '') + '" name="' + o.name + '"' + (o.attr ? ' ' + o.attr : '') + '>' + (o.add || ''),
            ck;
        o.data = obj(o.data);
        $.each(o.data, function(i, v) {
            i = TPL.$s(i);
            ck = typeof o.def != 'undefined' && o.def == i ? ' selected="true"' : '';
            if (o.showId) v = i + '-' + v;
            var r = COMM.optionTitle(v);
            s += '<option value="' + i + '"' + ck + r.tit + '>' + r.v + '</option>'
        });
        return s + '</select>'
    },
    optionTitle: function(v) {
        var tit;
        if (v && v.indexOf('|tit:') > 0) {
            v = v.split('|tit:');
            tit = ' title="' + v[1] + '"';
            v = v[0]
        } else {
            tit = ''
        }
        return {
            'tit': tit,
            'v': v
        }
    },
    loadSelect: function(name, data, def, add, attr) {
        var obj = $('#' + name + 'Obj');
        obj.html(COMM.getSelect(name, data, add, attr));
        if (def) $('select option[value=' + def + ']', obj).attr('selected', true)
    },
    mapSearch: function(n, i, tag) {
        if (VAR.dl) VAR.dl.clear();
        if (!tag) tag = $(i).prev().attr('name');
        VAR.dl = new Delay(function() {
            COMM.mapSel(n, $(i).val(), '', 1, '', tag)
        }, 200)
    },
    mapSel: function(n, key, ret, ck, def, tag) {
        var s = '',
            y = 0,
            err = '';
        if (!key && $.inArray(n, ['act']) >= 0) s += '<option value="">-请选择-</option>';
        $.each(VAR[n + 'Map'], function(i, o) {
            if (key && i.indexOf(key) < 0 && o.indexOf(key) < 0) return;
            if (VAR[n + 'Arr'] && VAR[n + 'Arr'][i]) {
                if (!y) y = i;
                return
            }
            if (i > 490 && i < 501 && n == 'act') return;
            s += '<option value="' + i + '"' + (def && def == i ? ' selected="true"' : '') + '>' + i + '-' + o + '</option>'
        });
        err = '编号[' + y + ']已经存在，不可以重复操作！';
        if (ck && y) Msg.err(err);
        if (ret) return s;
        if (!s) s = ck && y ? '<option value="">' + err + '</option>' : '<option value="">编号[' + key + ']未曾注册</option>';
        $o('[name="' + (tag || 'pid') + '"]').html(s)
    },
    checkPackData: function(s) {
        var d;
        switch (s) {
            case 'sid':
                d = L.S;
                break;
            case 'prop':
                d = VAR.propMap;
                break;
            case 'wmode':
                d = VAR.wmodeMap;
                break;
            default:
                d = VAR[s + 'Arr']
        }
        return d
    },
    checkpack: function(s, rs, par, name, pArr) {
        if (pArr && pArr[1]) name = pArr[1];
        var d = COMM.checkPackData(par);
        if (!d) {
            if (par === 'prop' || par === 'wmode') {
                var id = 'c' + Math.random().toString().replace('.', '');
                return '<div id="' + id + '"></div>' + TPL.o(function() {
                        $.getScript(PATH['$' + par], function() {
                            $o('#' + id).html(COMM.checkpack(s, rs, par, name, pArr))
                        })
                    }, 'script')
            } else {
                return '[' + par + '未获取到配置]'
            }
        }
        VAR['checkpack.' + name] = s;
        var price = 0,
            priceArr = VAR[par + 'priceArr'] || {},
            r = '';
        if (rs && rs.model && rs.model == 'bagworking') {
            var more = (s.toString().indexOf(',') != -1) ? 1 : 0;
            r = s ? '<input type="hidden" name="' + name + '" value="' + s + '" /><span class="viewObj checkpack"><b  class="app" fun="checkpack_' + par + ',' + name + ',bagworking"><a></a>' + (more ? '多种' : d[s]) + '</b></span>' : '<a class="app" fun="checkpack_' + par + ',' + name + ',bagworking">[' + L.filecheck + ']</a>'
        } else {
            r = '<input ' + (par == 'sid' ? 'must="' + L.needcheck + '"' : '') + ' name="' + name + '" value="' + s + '" readonly="true" disabled="true" ' + (par == 'sid' ? 'type="hidden"' : '') + ' /><span class="viewObj checkpack">'
        }
        if (s === 'all') {
            r += '<b>全平台通用</b>'
        } else if (s) {
            if (rs && rs.model && rs.model == 'bagworking') {
                r += ''
            } else {
                s = s.toString().split(',');
                $.each(s, function(i, o) {
                    if (!o || !d[o]) return;
                    if (priceArr[o]) price += int(priceArr[o]);
                    r += '<b onclick="COMM.checkpackdel(this,' + o + ',\'' + par + '\',\'' + name + '\')"><a></a>' + d[o] + '</b>'
                })
            }
        }
        r += (rs && rs.model && rs.model == 'bagworking') ? '' : '</span>&nbsp;<a class="app" fun="checkpack_' + par + ',' + name + '">[' + L.filecheck + ']</a>';
        if ($.inArray(par, ['prop', 'gift', 'levels', 'collects']) >= 0) {
            var el = $o('[name="' + name + '"]')[0];
            if (el) setTimeout(function() {
                bagform.autoName(el)
            }, 100)
        } else if (par === 'real') {
            $o('[name="' + name.replace('[val]', '[price]') + '"]').val(price)
        }
        return r
    },
    checkpackdel: function(my, v, par, tag) {
        var s = ',' + VAR['checkpack.' + tag] + ',';
        s = s.replace(',' + v + ',', ',');
        s = s.replace(/^,|,$/g, '');
        $(my).parent().parent().html(COMM.checkpack(s, '', par, tag))
    },
    loadTblSel: function(tbl, opt) {
        opt = opt || {};
        var i, tb = {},
            s, begin = opt.i || 0;
        for (i = begin; i > -MY.tblnum; i--) {
            s = tbl + $D.diff(i, 'Ymd');
            tb[s] = s
        }
        if (opt.tbl) opt.add = '<option value="' + tbl + '">' + tbl + '</option>';
        if (opt.chg) opt.evt = 'onchange="U.commInit(1)"';
        COMM.loadSelect(opt.name || 'table', tb, opt.def, opt.add, opt.evt)
    },
    replace: function(s) {
        if (s && typeof s == 'string') s = s.replace(/DKHL/g, '{').replace(/DKHR/g, '}');
        return replaceVars(s, S)
    },
    oneCid: function(cid, tit) {
        var sel = $o('select[name=cid]');
        if ($('option', sel).length > 1) return;
        sel.parent().html('<input type="hidden" value="' + cid + '" name="cid" />' + (tit || cid) + '<i>(' + cid + ')</i>')
    },
    nums: function(n, s) {
        return '<' + s + ' title="' + COMM.numbers(n) + '">' + COMM.number(n) + '</' + s + '>'
    },
    number: function(n) {
        if ($.inArray(S.langfix, ['id', 'vn']) >= 0) {
            return number_format(n, 0, ',', '.')
        } else {
            return number_format(n, 0, '.', ',')
        }
    },
    numbers: function(n) {
        if (!n) n = 0;
        if (!n || n.length < 4) return n;
        n = n.toString();
        var fh = n.charAt(0) == '-' ? '-' : '';
        if (fh) n = n.replace('-', '');
        var l = n.length - 1,
            i, r = n.charAt(l),
            s = ['万', '亿', '万亿', '亿亿'],
            si = 0;
        for (i = 1; i <= l; i++) {
            if (i % 4 == 0) {
                r = (' ' + s[si++] + ' ' || '') + r
            }
            r = n.charAt(l - i) + r
        }
        return fh + r
    },
    checkRadioPar: function(par, tag, _data) {
        var set;
        if (_data && typeof _data == 'object') {
            set = _data;
            if (!set[tag]) return set
        } else {
            if (par && par.indexOf('.') > 0) {
                try {
                    eval('par=' + par);
                    return par
                } catch (e) {
                    return Msg.err('[COMM.checkRadioPar]' + par)
                }
            }
            try {
                set = eval(par + '.radio')
            } catch (e) {
                return Msg.err('[COMM.checkRadioPar]' + par + '.radio')
            }
        }
        if (!set || !set[tag]) {
            if (tag && tag.indexOf('.') >= 0) {
                var tag2 = tag.split('.')[0];
                if (set && set[tag2]) return set[tag2]
            }
            tag = par + '.radio.' + tag;
            Msg.err('[COMM.checkRadioPar] 配置错误：【' + tag + '】');
            return tag
        } else {
            return set[tag]
        }
    },
    actLeft: function(sign, del, fn) {
        $.getScripts([PATH.data + 'act/' + S.id + '.js?' + COMM.version('actArr'), PATH.data + 'map/act.js?' + COMM.version('map.act')], function() {
            sign = sign || 'actSet';
            var s = '<ul>',
                tit;
            if (sign == 'bag' || sign == 'paypop') s += '<li><a class="app" fun="' + sign + '">' + L.all + '</a></li>';
            if (L.actmap) $.extend(VAR.actMap, L.actmap);
            if (VAR.actArr) {
                $.each(VAR.actArr, function(i, o) {
                    s += '<li><a class="app" fun="' + sign + '_' + i + '"><i>' + i + ')</i>' + (VAR.actMap[i] || '[err]' + i) + '</a></li>'
                })
            }
            if (del) s += '<li><a class="app" fun="' + sign + '_deled">' + L.deled + '</a></li>';
            s += '</ul>';
            if (typeof fn == 'function') {
                fn(s)
            } else {
                WIN[0].loadLeft(s)
            }
        })
    },
    actsLeft: function(opt) {
        var set = {
            'sign': '',
            'del': 0,
            'init': '',
            'open': 0,
            'atype': ''
        };
        if (opt) $.extend(set, opt);
        if (vars.api == 2) {
            $.getScripts([PATH.data + 'map/mbact.js?' + COMM.version('mbactMap'), PATH.data + 'map/act.js?' + COMM.version('map.act')], function() {
                var sign = set.sign,
                    s = '<ul>',
                    tit;
                if (L.actmap) $.extend(VAR.mbactMap, L.actmap);
                if (VAR.mbactMap) {
                    var one = 0;
                    var loadstr = function() {
                        var s = '',
                            c;
                        if (!VAR.mbactMap) return s;
                        $.each(VAR.mbactMap, function(i, o) {
                            s += '<li><a class="app' + (!one ? ' firstNood' : '') + '" fun="' + sign + '_' + i + '"><i>' + i + ')</i>' + (o || '[err]' + i) + '</a></li>';
                            if (!one) one = 1
                        });
                        return s
                    };
                    s += '<li><a class="openChild">==移动礼包==</a><ul>' + loadstr() + '</ul></li>'
                }
                s += '</ul>';
                if (typeof set.init == 'function') {
                    set.init(s)
                } else {
                    WIN[0].loadLeft(s)
                }
                if (typeof set.callback == 'function') set.callback();
                if (!PAR && set.open && !WIN[0].leftFirstTime) {
                    $('a.openChild', WIN[0].left).click();
                    WIN[0].leftFirstTime = 1
                }
            })
        } else {
            $.getScripts([PATH.data + 'act/' + S.id + 's.js?' + COMM.version('actsArr'), PATH.data + 'map/act.js?' + COMM.version('map.act')], function() {
                var sign = set.sign,
                    s = '<ul>',
                    tit;
                if (sign == 'bag' || sign == 'paypop') s += '<li><a class="app" fun="' + sign + '">' + L.all + '</a></li>';
                if (L.actmap) $.extend(VAR.actMap, L.actmap);
                if (VAR.actArrs) {
                    var one = 0;
                    var loadstr = function(n) {
                        var s = '',
                            c, list = VAR.applistArr[COMM.appId('act')];
                        if (!VAR.actArrs[n]) return s;
                        var tit = {};
                        $.each(list, function(i, o) {
                            tit[o.par] = o.title
                        });
                        $.each(VAR.actArrs[n], function(cid, arr) {
                            c = '';
                            $.each(arr, function(i, o) {
                                var name = VAR.actMap[o[0]] || (int(o[0]) >= 2000 ? o[1] : '[err]' + o[0]);
                                c += '<li><a class="app' + (!one ? ' firstNood' : '') + '" fun="' + sign + '_' + o[0] + '"><i>' + o[0] + ')</i>' + name + '</a></li>';
                                if (!one) one = 1
                            });
                            s += '<li><a class="openChild">' + tit[cid] + '</a><ul>' + c + '</ul></li>'
                        });
                        return s
                    };
                    s += '<li><a class="openChild">==在线活动==</a><ul>' + loadstr(1) + '</ul></li>';
                    s += '<li><a class="openChild">==过期活动==</a><ul>' + loadstr(0) + '</ul></li>'
                }
                if (set.del) s += '<li><a class="app" fun="' + sign + '_deled">' + L.deled + '</a></li>';
                s += '</ul>';
                if (typeof set.init == 'function') {
                    set.init(s)
                } else {
                    WIN[0].loadLeft(s)
                }
                if (typeof set.callback == 'function') set.callback();
                if (!PAR && set.open) {
                    WIN[0].openAll()
                }
            })
        }
    },
    appId: function(s) {
        if (APP[s]) return APP[s].id;
        return C.id[s] || 0
    },
    allow: function(node) {
        if (!MY.allow) return false;
        node = node.toString();
        if ($.inArray('*', MY.allow) != -1 || (',' + MY.sidstr + ',').indexOf(',' + node + ',') >= 0) return true;
        var i, o, str;
        for (i in MY.allow) {
            o = MY.allow[i];
            if (!o) continue;
            o = o.toString();
            if (o == node) return true;
            if (o.indexOf(node + '.') >= 0) return true;
            if (node.indexOf('.') > 0) {
                str = node.replace(/\.[^.]+$/, '')
            } else if (node.match(/\d+$/)) {
                str = node.replace(/\d+$/, '')
            } else {
                str = node
            }
            if (str + '.*' == o) return true
        }
        return false
    },
    adminIo: function(obj) {
        $('.group_' + MY.gid, LOCAL).removeClass('group');
        obj = obj ? obj : LOCAL;
        if (MY.allow && MY.allow[0] == '*') {
            $('.admin', obj).removeClass('admin');
            return
        }
        if (!VAR.allowArr) return;
        $.each(VAR.allowArr, function(i, o) {
            if (COMM.allow(o)) $('.' + o.replace('.', '_'), obj).removeClass('admin')
        })
    },
    statusCg: function(i) {
        $o('#dayObj').css('display', $.inArray(i.value, ['1', '2']) >= 0 ? '' : 'none');
        $o('#snstatusObj').css('display', $.inArray(i.value, ['3']) >= 0 ? '' : 'none');
        $o('#clearObj').css('display', i.value == 3 ? '' : 'none');
        $o('#gagObj').css('display', $.inArray(i.value, ['0', '10']) >= 0 ? '' : 'none');
        $o('#unlocktipObj').css('display', $.inArray(i.value, ['10']) >= 0 ? '' : 'none')
    },
    status: function(v, rs, par) {
        v = v == 0 ? 10 : v;
        if (v == 1 && (!rs.mver || rs.mver == '0')) v = 3;
        var tag = v == 10 ? 'b' : 'u',
            ret = '<' + tag + ' class="m0">' + (L.user.statusall[v] || v) + '</' + tag + '>';
        if (par == 'lock' && tag == 'b') ret = '';
        return ret + (rs.mver && (v == 1 || v == 2) ? '<i>(' + rs.mver + ')</i>' : '')
    },
    uHref: function(mid, hash, diy) {
        return CMS_PATH + 'user/?sid=' + (getPar('sid') || S.id) + '&server=' + vars.server + '&api=' + vars.api + (diy || '') + '&mid=' + mid + '#' + (hash || 'info')
    },
    mid: function(v, rs, par, tag, pars) {
        var href = COMM.uHref(v);
        if (par == 'href') return href;
        var name = rs && par && rs[par] ? rs[par] : v;
        if (v == 0) return pars && pars[1] ? pars[1] : '';
        return '<a href="' + href + '" target="_blank">' + name + '</a>'
    },
    handcardType: function(v, rs, par) {
        type = {
            1: 'AA',
            2: '同花AK',
            3: '同花AQ或者AJ',
            4: '非同花的AK',
            5: '对J到对K',
            6: '非同花AQ或者AJ',
            7: '对2到对10',
            8: '手牌的同花顺子',
            9: '手牌的同花',
            10: '手牌的顺子',
            11: '杂牌'
        };
        return type[v]
    },
    winType: function(v, rs, par) {
        type = {
            0: '打牌输',
            1: '平',
            2: '小赢',
            4: '打赢',
            8: 'bonus赢',
            16: 'bonus输'
        };
        return type[v]
    },
    firstwinType: function(v, rs, par) {
        type = {
            1: '杂牌',
            2: '高牌',
            3: '一对',
            4: '两对',
            5: '三条',
            6: '顺子',
            7: '同花',
            8: '葫芦',
            9: '四条',
            10: '同花顺',
            11: '皇家同花顺'
        };
        return type[v]
    },
    roundInfo: function(v, rs, par) {
        type = {
            0: '停止状态',
            1: '准备阶段',
            2: '首注阶段',
            3: '翻牌阶段',
            4: '转牌阶段',
            5: '河牌阶段',
            6: '结束阶段'
        };
        return type[v]
    },
    lockHead: function(reset) {
        $o('.lockHeadTbl').remove();
        var o = $o('tr.myTableTitle');
        if (!o[0]) return;
        if (reset || !WIN[0].scrollLock) {
            o.find('td').each(function() {
                $(this).width($(this).width());
                $(this).height($(this).height())
            });
            var cls = o.parent()[0].tagName == 'TBODY' ? o.parent().parent().attr("class") : o.parent().attr("class");
            cls += ' lockHeadTbl';
            RIGHT.prepend('<table class="' + cls + '" style="position:absolute;display:none"><tr class="myTableTitle">' + o.html() + '</tr></table>');
            WIN[0].scrollLock = $o('.lockHeadTbl')
        }
        RIGHT.scroll(function() {
            var oo = WIN[0].scrollLock;
            if (!oo) return;
            if (o.position().top <= 0) {
                oo.css('top', RIGHT.scrollTop()).show()
            } else {
                oo.hide()
            }
        })
    },
    maxlen: function(v, o) {
        if (!v) return true;
        var ml = o.attr('maxlen');
        if (!ml) return true;
        if (v.length > ml) {
            o.focus();
            var tip = o.attr('errtip') || '输入长度#0超过限制长度#1';
            return l(tip, [v.length, ml])
        }
        return true
    },
    nextDay: function(o, day, str, fn) {
        VAR.dateDiff = day;
        var t = $D.diff(day, str, o.val());
        o.val(t);
        if (typeof fn == 'function') fn()
    },
    setNumber: function(i, max) {
        var v = int(i.value, 0);
        if (max) v = Math.min(int(max, 0), v);
        i.value = v
    },
    vipCfg: function(d) {
        var r = {};
        if (d) r = d;
        if (!LL.user.vipCfg) return r;
        $.each(LL.user.vipCfg, function(i, o) {
            r[o] = L.user.vip[o] || 'vip' + o
        });
        return r
    },
    ajax: function(p, f) {
        var k = f;
        if (typeof f != 'function') f = function(ret) {
            Msg.close();
            COMM.suc(ret)
        };
        if (k === 'cfg' || k === 'online') {
            Confirm('此操作是影响线上环境，请确认？', exec)
        } else {
            exec()
        }
        function exec() {
            Msg.doing();
            if (k && typeof k == 'string') p += '&cfgpath=' + k;
            $.JSON(CGI.ajax + '?cmd=' + p, f)
        }
    },
    mousePos: function(ev) {
        if (ev.pageX || ev.pageY) return {
            x: ev.pageX,
            y: ev.pageY
        };
        return {
            x: ev.clientX + document.body.scrollLeft - document.body.clientLeft,
            y: ev.clientY + document.body.scrollTop - document.body.clientTop
        }
    },
    fmtNum: function(v) {
        if (v === 0) return v;
        v = $.trim(v.toString().toUpperCase());
        var len = v.length;
        if (!len) return '';
        var num = v.substring(0, len - 1).replace(/[^0-9.,]/g, ''),
            last = v.charAt(len - 1);
        if (isNaN(last) && $.inArray(last, ['K', 'W', 'M', 'B']) == -1) last = '';
        return num + last
    },
    autoNum: function(i) {
        var v = $(i).val();
        i.value = COMM.fmtNum(v)
    },
    autoInt: function(i, f) {
        var v = $(i).val(),
            re = f ? /[^0-9.]/g : /[^0-9]/g;
        if (v) {
            v = $.trim(v);
            var fu = v.charAt(0) === '-';
            v = v.replace(re, '');
            if (fu) v = '-' + v
        }
        i.value = v
    },
    autoChar: function(i) {
        var v = $(i).val();
        if (v) v = v.replace(/[^0-9a-zA-Z_.:|]/g, '');
        i.value = v
    },
    autoTimes: function(my, no) {
        var v = $.trim(my.value),
            re = /[^0-9,:\-]/g;
        if (no) re = /[^0-9,:]/g;
        if (v) v = v.replace(/，/g, ',').replace(re, '');
        var ck = COMM.ckTimes(v, true);
        if (ck.indexOf('错误') >= 0) return Msg.err(ck);
        my.value = ck;
        Msg.clear()
    },
    ckTimes: function(v, ret) {
        var arr = v.split(','),
            arr2, err = '';
        var fmt = function(t) {
            if (!t) return false;
            t = t.split(':');
            t[0] = int(t[0]);
            if (t[0] > 23 || t[0] < 0) {
                echo('COMM.ckTimes', '0<' + t[0] + '<23');
                return false
            }
            t[1] = int(t[1]);
            if (t[1] > 59 || t[1] < 0) {
                echo('COMM.ckTimes', '0<' + t[1] + '<59');
                return false
            }
            if (t[0] < 10) t[0] = '0' + t[0];
            if (t[1] < 10) t[1] = '0' + t[1];
            return t.join(':')
        };
        $.each(arr, function(i, o) {
            if (o && o.indexOf('-') >= 0) {
                arr2 = o.split('-');
                arr2[0] = fmt(arr2[0]);
                arr2[1] = fmt(arr2[1]);
                if (arr2.length !== 2 || !arr2[0] || !arr2[1]) {
                    err = o;
                    return false
                }
                if (arr2[1] < arr2[0]) {
                    err = o;
                    return false
                }
                arr[i] = arr2.join('-')
            } else if (o && o.indexOf('-') < 0) {
                var single = fmt(o);
                if (!single) {
                    err = o;
                    return false
                }
                arr[i] = single
            } else {
                err = o;
                return false
            }
        });
        if (err) return '输入时段格式错误：' + err;
        return ret === true ? arr.join(',') : true
    },
    applist: function(s) {
        var d = VAR.applistArr[COMM.appId(s)],
            r = {};
        if (!d) return r;
        $.each(d, function(i, o) {
            if (o.par !== '') r[o.par] = o.title
        });
        return r
    },
    chips2Char: function(v) {
        var x = LL.chips2Char.x,
            arr = LL.chips2Char.unit,
            s = '';
        v = int(v);
        if (v < x) return v;
        $.each(arr, function(i, o) {
            if (v % x === 0) {
                v = v / x;
                s = arr[i]
            }
        });
        return v + s
    },
    checkIp: function(ip) {
        if (!ip) return;
        var arr = ip.split('.');
        if (arr.length != 4) return;
        var i, n;
        for (var i = 0; i < 4; i++) {
            n = parseInt(arr[i]);
            if (isNaN(n) || n < 0 || n > 255) return
        }
        return 1
    },
    childSidSel: function(name) {
        var d = COMM.unidArr(true, true);
        return COMM.getSelect(name, d, '<option value="">==请选择站点ID==</option>')
    },
    sidGetLang: function(sid) {
        if (!VAR.langSid) return '';
        var lan = '';
        sid = int(sid);
        $.each(VAR.langSid, function(l, o) {
            if ($.inArray(sid, o) >= 0) {
                lan = l;
                return false
            }
        });
        return lan
    },
    addRow: function(i, add) {
        i = $o(i).parent();
        if (add) {
            i.after(i.clone())
        } else {
            i.remove()
        }
    },
    permissAPI: function(api) {
        $.JSON(PATH.api + 'auth.php?api=' + (api || 0))
    },
    getLang: function(v, f) {
        if (!v) return;
        var version = Math.random();
        $.getScript(vars.langpath + v + '.js?v' + version, function() {
            if (f && typeof(f) == 'function') f();
            $.getScript(vars.langpath + vars.langfix + '.js?v' + version)
        })
    },
    fmtHrGroup: function(data, def, user) {
        var $group = {},
            $radio = def || {},
            $full = {},
            aCfg = {};
        if (data) {
            $.each(data, function(i, o) {
                if (!$group[o.fid]) $group[o.fid] = [];
                if (user && user[o.id]) o.user = user[o.id];
                $group[o.fid].push(o);
                aCfg[o.id] = o
            });
            var getFull = function(id) {
                var r = [],
                    o;
                while (1) {
                    o = aCfg[id];
                    if (!o) break;
                    r.unshift(o.name);
                    id = o.fid
                }
                return r.join('/')
            };
            var setFid = function(fid, str) {
                if (!$group[fid]) return;
                $.each($group[fid], function(i, o) {
                    $full[o.id] = getFull(o.id);
                    $radio['$s' + o.id] = str + o.name + '|tit:' + $full[o.id];
                    setFid(o.id, str + '........')
                })
            };
            setFid(1, '')
        }
        return {
            'group': $group,
            'radio': $radio,
            'full': $full
        }
    },
    swf: function(src, w, h) {
        return '<embed autostart="true" loop="true" wmode="transparent" width="' + w + '" height="' + h + '" type="application/x-shockwave-flash" src="' + src + '" />'
    },
    flash: function(src, w, h) {
        return '<video  controls="controls" width="' + w + '" height="' + h + '"  src="' + src + '" /></video>'
    },
    mf2xml: function(type, lcdata, opt, cb) {
        var f = typeof U == 'object' && U ? M.confirm : Confirm;
        f('<b>确定执行数据导出？</b><br>最多支持一次导出30W条数据，若预计超出，请调整查询条件后再次执行导出。', function() {
            Msg.doing();
            $.JSONP(CGI.mf + '?action=records', {
                'lcdata': lcdata,
                'cms_mf': {
                    'type': type,
                    'opt': opt
                }
            }, function(ret) {
                Msg.close();
                COMM.suc(ret);
                if (typeof cb == 'function') cb(ret)
            })
        })
    }
};
var List = new function() {
    var I = this;
    I.radio = {
        vsid: {
            342: '需求开发',
            347: '系统反馈',
            396: 'v3活动'
        }
    };
    I.init = function(user) {
        var url = user ? location.href : SYS.refUrl('get');
        var str = '<table class="myTable left" id="ListFrom"><tr><td class="myTableLeft">当前地址：</td><td><input name="url" value="' + url + '" style="width:98%" disabled="true" /></td></tr><tr><td>List标题：</td><td><input name="title" must="请输入List标题！" style="width:98%" /></td></tr><tr><td>List内容：<br><i>此内容将被作为list内容。</i></td><td>' + TPL.editor('', '', 200, 'content', [200, 'Chv', user ? 0 : 1]) + '</textarea></td></tr><tr><td>List分类：</td><td>' + TPL.radio(347, '', 'List', 'vsid') + '</td></tr><tr><tr><td>接收人：</td><td>' + TPL.UC('438,642,1022', '', '', 'uid') + '</td></tr><tr></table><div class="myBtns"><input type="button" value="' + L.btn.submit + '" onclick="List.submit()" /></div>';
        M.text(str, 800, 500, {
            title: '快速提LIST'
        })
    };
    I.submit = function() {
        var f = new Form($('#ListFrom'));
        if (!f.check()) return;
        M.confirm('确定操作？', function() {
            var d = {
                langfix: L.config && vars.langfix && L.config[vars.langfix] ? L.config[vars.langfix] + '(' + vars.langfix + ')' : '简体(th)',
                href: location.href,
                userAgent: navigator.userAgent,
                screen: screen.width + " X " + screen.height
            };
            if (VAR.isMobile) d.userAgent += '(mb)';
            $.extend(f.data, d);
            Msg.doing();
            $.POST(CGI.ajax + '?cmd=bug', f.data, function(ret) {
                Msg.close();
                M.close();
                if (ret && ret.ok) {
                    M.alert(ret.msg, {
                        width: 400,
                        height: 160
                    })
                }
            })
        })
    }
};
var DOM = new function() {
    var _input = function(p) {
        var r = ['<input'];
        $.each(p, function(k, v) {
            if (v && typeof v == 'string') v = v.replace(/"/g, '');
            r.push(k + '="' + v + '"')
        });
        r.push('/>');
        return r.join(' ')
    };
    var I = {
        date: function(name, arr) {
            var p = {
                name: name,
                readonly: 'true'
            };
            if (arr) $.extend(p, arr);
            p.type = p.type || 'Y-m-d';
            p.onclick = 'D.init(this,\'' + p.type + '\')';
            if (!p.style) {
                if (!p.width && p.type == 'Y-m-d H:i:s') p.width = 120;
                p.style = 'width:' + (p.width || 70) + 'px'
            }
            if (!p.value && (p.diff || p.diff == 0)) p.value = $D.diff(p.diff, p.type);
            p.type = 'text';
            delete p.diff;
            delete p.width;
            return _input(p)
        },
        start_end: function(d1, d2, type, w) {
            type = type || 'Y-m-d';
            w = w || 70;
            d1 = d1 > 0 ? 0 : (d1 || 30);
            return DOM.date2('startTime', $D.diff(d1, type), 'endTime', $D.diff(d2 || 0, type), {
                width: w * 2 + 8,
                format: type
            })
        },
        date2: function(n1, v1, n2, v2, par) {
            var c = {
                width: 255,
                format: 'Y-m-d H:i:s',
                callback: ''
            };
            if (par) $.extend(c, par);
            var v = v1 && v2 ? v1 + ' ~ ' + v2 : '',
                w = c.width;
            delete c.width;
            if (w == 255 && c.format == 'Y-m-d') w = 150;
            return '<span onclick="D.init2(this,\'' + n1 + '\',\'' + n2 + '\',TPL.o(' + TPL.o(c, true) + '))"><input name="' + n1 + '_' + n2 + '" class="calendar2" readonly="true" type="text" placeholder="请选择时间" style="width:' + w + 'px" value="' + v + '" /><input name="' + n1 + '" value="' + v1 + '" type="hidden" /><input name="' + n2 + '" value="' + v2 + '" type="hidden" /></span>'
        },
        times: function(nm, val, w) {
            return '<input name="' + nm + '" value="' + val + '" onblur="COMM.autoTimes(this)" style="width:' + (w || 200) + 'px" />' + SYS.help('支持简写，如：12-14,20-22；&#13;输入焦点离开后，系统将自动格式化！')
        },
        chips: function(nm, w) {
            return '<input name="' + TPL._tag(nm) + '" value="{' + nm + '}" onkeyup="COMM.autoInt(this)" style="text-align:center;width:' + (w || 50) + 'px" />' + S._blowup
        },
        int: function(nm, w, arr) {
            var p = {
                name: nm,
                type: 'text',
                style: 'width:' + (w || 100) + 'px',
                onkeyup: 'COMM.autoInt(this)'
            };
            if (arr) $.extend(p, arr);
            return _input(p)
        }
    };
    return I
};
var Copy = new function() {
    var I = this,
        NS = 'Copy',
        $c = {},
        $opt = ['reset', 'sid', 'api', 'ids', 'copybag', 'appid'];
    I.init = function(p) {
        var c = {
            cgi: '',
            bag: 0,
            self: false,
            ids: false,
            api: false,
            width: 400,
            height: 240,
            param: ''
        };
        $.extend(c, p);
        $c = c;
        var html = ['<table class="myTable left">'];
        html.push('<tr><td width="80">目标平台：</td><td>' + TPL.select('', '', 'S.mainSite', 'sid') + '</td></tr>');
        if (c.api) html.push('<tr><td>目标API：</td><td>' + COMM.apiSelect('api') + '</td></tr>');
        if (c.ids) {
            var ids = getCheckbox('ids');
            if (!ids) return;
            html.push('<tr><td>复制数据ID：</td><td><textarea name="ids" style="width:98%" disabled="true">' + ids + '</textarea></td></tr>')
        }
        if (c.bag) html.push('<tr><td>复制礼包：</td><td><input name="copybag" value="1" type="checkbox" /></td></tr>');
        html.push('</table><div class="myBtns"><input name="appid" value="' + WIN[0].appId + '" type="hidden" /><input type="button" value="确定复制" onclick="' + NS + '.submit()" /></div>');
        SYS.window({
            width: c.width,
            height: c.height,
            html: html.join(''),
            init: function() {
                if (!c.api) return;
                $.JSON(CGI.ajax + '?cmd=apiCfg', function(ret) {
                    if (!ret) return;
                    var apiCfg = ret.data || {};
                    $o('[name=sid]').change(function() {
                        $o('[name=api]').replaceWith(COMM.apiSelect('api', apiCfg[this.value] || {}))
                    }).change()
                })
            }
        });
        WIN[0].appendTitle('数据复制');
        if (!c.self) $o('[name=sid]').find('[value=' + S.id + ']').remove()
    };
    I.submit = function() {
        var f = new Form(RIGHT);
        if (!f.check()) return;
        if ($c.param) {
            for (var i in $c.param) {
                if ($.inArray(i, $opt) != -1) {
                    Err('扩展参数【' + i + '】与系统参数重复，请联系开发人员！');
                    e = 1;
                    return false
                }
            }
            $.extend(f.data, $c.param)
        }
        var fn = function(reset) {
            Msg.doing();
            f.data.reset = reset;
            $.JSON($c.cgi, f.data, function(ret) {
                Msg.close();
                if (ret && ret.msg === 'reset') {
                    Confirm('目标平台已经存在数据，是否覆盖？', function() {
                        fn(1)
                    });
                    return
                }
                COMM.suc(ret, function() {
                    WIN[0].close()
                })
            })
        };
        Confirm('确定将数据复制到【' + L.S[f.data.sid] + '】？', function() {
            fn(0)
        })
    }
};
var Sort = new function() {
    var I = this,
        NS = 'Sort',
        TEMP = {};
    I.init = function(my) {
        var o = $o('.sortObj');
        o.toggle();
        my = my ? my : VAR.self;
        if (o.eq(0).is(':visible')) {
            $(my).val(L.btn.sort2)
        } else {
            $(my).val(L.btn.sort)
        }
    };
    I.tit = function(k, tag, tit) {
        tag = tag || 'td';
        tit = tit || L.order;
        return '<' + tag + ' width="80" class="sortObj"><input type="button" value="' + tit + '" class="app" fun="' + NS + '.exec_' + k + '" /><i class="help" title="在下面输入框中输入排序数值，再点击【' + tit + '】即可实现按输入的排序数值进行排序（顺序或倒序以实际应用的逻辑为准）。"></i></' + tag + '>'
    };
    I.tpl = function(k, tag, tit) {
        tag = tag || 'td';
        return '<' + tag + ' class="sortObj">' + (tit || '') + '<input value="{sortid|' + NS + '.tplfun_' + k + '}" name="sortid" class="sortid" title="ID:{id}" onkeyup="COMM.autoInt(this)" /></' + tag + '>'
    };
    var _reset = function() {
            $o('.sortObj').hide();
            $o('input[type=button][value="' + L.btn.sort2 + '"]').val(L.btn.sort)
        },
        $lock, _tplfun = function(v) {
            if ($lock) return;
            $lock = 1;
            _reset();
            setTimeout(function() {
                $lock = 0
            }, 200)
        };
    I.tplfun = function(v, rs, par) {
        _tplfun();
        if (!TEMP[par]) TEMP[par] = {};
        TEMP[par][rs.id] = v;
        return v
    };
    I.exec = function(table, db) {
        var ids = getValues('ids'),
            sortid = getValues('sortid');
        if (ids && sortid) {
            var temp = TEMP[table];
            if (temp) {
                ids = ids.split(',');
                sortid = sortid.split(',');
                var a1 = [],
                    a2 = [];
                $.each(ids, function(i, id) {
                    if (temp[id] === sortid[i]) {
                        echo('未改', id, sortid[i])
                    } else {
                        a1.push(id);
                        a2.push(sortid[i])
                    }
                });
                ids = a1.join(',');
                sortid = a2.join(',');
                if (!ids || !sortid) return Msg.err('排序值未做修改！')
            }
            db = db || '';
            Msg.doing();
            $.get(CGI.ajax + '?cmd=sorts&table=' + table + '&db=' + db + '&ids=' + ids + '&sortid=' + sortid, function() {
                Msg.close();
                P.ref();
                _reset();
                Msg.ok()
            })
        } else {
            Msg.err('排序必要参数错误！')
        }
    }
};
var LOG = {
    init: function(par) {
        var f = LOG._f('init');
        if (f) {
            f(par)
        } else {
            WIN[0].$LogObj = new Log(par)
        }
    },
    add: function(k, v) {
        var f = LOG._f('add');
        if (f) f(k, v)
    },
    submit: function(d, del) {
        var f = LOG._f('submit');
        if (f) f(d, del)
    },
    _f: function(k) {
        var o = WIN[0].$LogObj;
        if (typeof o == 'object' && typeof o[k] == 'function') return o[k];
        return false
    }
};
var Log = function(par) {
    var I = this;
    I.set = function(par, v) {
        if (typeof par == 'object') {
            $.each(par, function(i, o) {
                I['$' + i] = o
            })
        } else {
            I['$' + par] = v
        }
    };
    I.init = function(par) {
        I.$appId = 0;
        I.$filter = [];
        I.$key = '';
        I.$val = '';
        I.$prefix = '';
        I.set(par);
        var f = new Form(I.$obj || RIGHT);
        f.getValue();
        I.data = f.data;
        I.$appId = I.$appId || WIN[0].appFid;
        I.$key = I.$key || 'id';
        I.$val = I.$val || I.data[I.$key];
        I.$prefix = I.$prefix || ''
    };
    I.init(par);
    I.add = function(k, v) {
        if (typeof v == 'object') v = clone(v);
        I.data[k] = v
    };
    I.getkey = function(s) {
        return typeof s == 'string' ? s.replace(/\[/g, '_').replace(/\]/g, '') : s
    };
    I.diff = function(old, newdata, kfix) {
        var k, filter = I.$filter.length ? I.$filter : false;
        old = obj(old);
        newdata = obj(newdata);
        $.each(newdata, function(key, newVal) {
            k = kfix + I.getkey(key);
            if (filter && $.inArray(k, filter) != -1) return;
            I.did[k] = 1;
            if (typeof newVal == 'undefined') {
                if (old[key] && typeof old[key] == 'object') old[key] = COMM.json(old[key]);
                I.ret[k] = [old[key], '[del]'];
                I.n++
            } else if (newVal && typeof newVal == 'object') {
                I.diff(old[key], newVal, k + '_')
            } else if (old[key] != newVal) {
                if (typeof old[key] == 'undefined') {
                    if (newVal == '') return;
                    old[key] = '[add]'
                }
                I.ret[k] = [old[key], newVal];
                I.n++
            }
        });
        $.each(old, function(key, oldVal) {
            k = kfix + I.getkey(key);
            if (typeof oldVal == 'undefined' || oldVal == '' || I.did[k]) return;
            if (oldVal && typeof oldVal == 'object') oldVal = COMM.json(oldVal);
            I.ret[k] = [oldVal, '[del]'];
            I.n++
        })
    };
    I.submit = function(data, del) {
        if (!I.$appId || !I.$val) {
            console.log('Log.submit数据异常', I.$appId, I.$key, I.$val);
            var d = {};
            $.each(I, function(i, o) {
                if (typeof o == 'string' && i.indexOf('$') == 0) d[i] = o
            });
            d.data = I.data;
            d._appId = WIN[0].appFid;
            d._data = data;
            $.POST(CGI.log + '?cmd=add&error=1', d);
            return
        }
        I.ret = {};
        I.did = {};
        I.n = 0;
        if (del) {
            if (typeof del != 'object') del = [del];
            $.each(del, function(i, k) {
                delete I.data[k];
                delete data[k]
            })
        }
        I.diff(I.data, data, '');
        WIN[0].$diffData = I.ret;
        I.n && $.POST(CGI.log + '?cmd=add&appId=' + I.$appId + '&keyName=' + I.$key + '&val=' + I.$val + '&prefix=' + I.$prefix, {
            'change': I.ret
        });
        I.data = data
    }
};
var TPL = {
    _oi: 0,
    _o: {},
    _ov: {},
    o: function(v, set, i) {
        if (set === 'script' || set === true || set == 1) {
            var k, ret = function() {
                if (typeof v == 'function' && set === 'script') {
                    return '<script>TPL.o(' + k + ')</script>'
                } else {
                    return k
                }
            };
            if (i) {
                k = TPL._ov[i];
                if (k) return ret()
            }
            k = ++TPL._oi;
            TPL._o[k] = v;
            if (i) TPL._ov[i] = k;
            return ret()
        } else {
            var d = TPL._o[v];
            if (typeof d == 'function') {
                return d.apply(this, arguments)
            } else if (typeof d == 'object' && typeof d[0] == 'function') {
                d = COMM.arg2obj(d);
                return d[0].apply(this, d[1])
            } else {
                return d
            }
        }
    },
    script: function() {
        var k = TPL.o(arguments, true);
        return '<script>TPL.o(' + k + ')</script>'
    },
    coud: function(v, rs, par, tag, aPar) {
        var type = aPar && typeof aPar == 'object' ? array_values(aPar).join(',') : (par || 'user');
        tag = TPL._tag(tag);
        return '<span id="' + tag + 'Coud" class="coudView"></span><input name="' + tag + '" size="10" disabled="true" value="' + v + '" /><a onclick="Coud.check(\'' + tag + '\',\'' + type + '\')">[选取]</a><script>Coud.view(\'' + tag + '\')</script>'
    },
    mid: COMM.mid,
    UC: function(v, rs, par, tag, aPar) {
        aPar = aPar || {};
        if (aPar.callback) {
            var f = eval(aPar.callback);
            if (typeof f == 'function') {
                aPar.callback = f
            } else {
                delete aPar.callback
            }
        }
        var id = WIN[0].id + '_' + COMM.fmtId(tag),
            uc = TPL.o(function() {
                $('#uc_' + id).uCheck(tag, v, aPar, vars.cmslib)
            }, 'script');
        return '<span id="uc_' + id + '"></span>' + uc
    },
    JS: function(v) {
        if (!v || typeof v !== 'string') return v;
        var k = '[JS]';
        if (v.indexOf(k) < 0) return v;
        v = v.replace(k, '');
        try {
            return eval(v)
        } catch (e) {
            return '[' + e + ']' + v
        }
    },
    editor: function(v, rs, par, tag, pars) {
        var id = 'editor_' + tag,
            opt = {},
            upload = '',
            key = COMM.fmtId(tag);
        if (par) opt.height = par;
        if (pars && pars[1]) opt.toolbar = pars[1];
        if (pars && pars[2]) upload = TPL.upload('', '', pars[2] == 1 ? 'editorUpload' : pars[2], key + '_upload');
        TPL['editor_value_' + key] = COMM.replace(v);
        TPL['editor_opt_' + key] = opt;
        return '<div><div id="' + id + '" style="padding:5px 0"></div>' + upload + '</div><script>loadEditor("' + id + '","' + tag + '",TPL.editor_value_' + key + ',TPL.editor_opt_' + key + ');</script>'
    },
    umeditor: function(v, rs, par, tag) {
        var id = WIN[0].id + tag + '_um',
            h = par || 300;
        return '<div><script type="text/plain" id="' + id + '" style="width:99.8%;height:' + h + 'px">' + v + '</script><script type="text/javascript">UM.getEditor("' + id + '").destroy();UM.getEditor("' + id + '");</script></div>'
    },
    diff: function(v, rs, par) {
        if (par == 'pic') {
            var src, tit;
            if (v == 1) {
                tit = '测试环境与线上环境数据一致';
                src = SKIN.img + 'ok.gif'
            } else if (v == 2) {
                tit = '测试环境与线上环境数据有差异';
                src = SKIN.img + 'p1.jpg'
            } else {
                v = 0;
                tit = '对应的线上环境数据不存在';
                src = SKIN.img + 'close.gif'
            }
            return '<img diff_type="df' + v + '" src="' + src + '" title="' + tit + '" />'
        } else {
            var c = ['#ffffdd', '#ddffdd', '#ffffdd'];
            $o('img[diff_type]').each(function() {
                var df = $(this).attr('diff_type').replace('df', '');
                if (c[df]) $(this).parent().parent().css('background-color', c[df])
            })
        }
    },
    del: function(s, rs, par) {
        return s == 1 ? C.del : ' '
    },
    ip: function(ip) {
        return '<a href="http://www.ip138.com/ips.asp?ip=' + ip + '&action=2" target="_blank">' + ip + '</a>'
    },
    uid: function(s, rs, par) {
        if (s && s.indexOf(',') > 0) {
            s = s.split(',');
            var r = [];
            $.each(s, function(i, o) {
                r.push(TPL.uid2name(o, par))
            });
            return r.join(',')
        } else {
            return TPL.uid2name(s, par)
        }
    },
    uid2name: function(uid, par) {
        return VAR.adminuser[uid] || (par === 'uid' ? uid : par) || '-'
    },
    auditor: function(v, rs, par, tag) {
        var d = MY.auditor;
        if (!d) return '错误审核人，请联系开发人员';
        if (typeof d == 'string' && d) d = d.split(',');
        TPL.$auditor = {
            'radio': {}
        };
        TPL.$auditor.radio[tag] = {};
        $.each(d, function(i, o) {
            TPL.$auditor.radio[tag][o] = o + ')' + (VAR.adminuser[o] || o)
        });
        return TPL[par](v || MY.superior, rs, 'TPL.$auditor.radio.' + tag, tag)
    },
    auditors: function(v, rs, par, tag) {
        if (vars.server == 1) {
            if (VAR.pepole_3) MY['pepole_3'] = VAR.pepole_3
        }
        var d = tag == 'dealuid' ? MY.auditor : (MY['pepole_3'] ? MY['pepole_3'] : MY[tag]);
        if (!d) return '错误审核人，请联系开发人员';
        if (typeof d == 'string' && d) d = d.split(',');
        TPL['$' + tag] = {
            'radio': {}
        };
        TPL['$' + tag].radio[tag] = {};
        $.each(d, function(i, o) {
            TPL['$' + tag].radio[tag][o] = o + ')' + (VAR.adminuser[o] || o)
        });
        return TPL[par](v || MY.superior, rs, 'TPL.$' + tag + '.radio.' + tag, tag)
    },
    cid: function(s, rs, par) {
        if (par && par.indexOf('.') > 0) {
            par = eval(par);
            return par[s] || s
        }
        if (par) {
            var o = VAR.applistArr[COMM.appId(par)];
            if (o) {
                for (var i in o) {
                    if (o[i].par && o[i].par == s || o[i].id == s) return o[i].title
                }
                return s
            }
        }
        if (L.appid[s]) return L.appid[s];
        if (VAR.applist[s] && VAR.applist[s].title) return VAR.applist[s].title;
        return s
    },
    cids: function(s, rs, par) {
        par = eval(par);
        if (s === 'all') return '<b>通用</b>';
        if (s && typeof s == 'string' && s.indexOf(',') >= 0) {
            var r = [];
            s = s.split(',');
            $.each(s, function(i, o) {
                if (o === '') return;
                r.push(par[o])
            });
            return r.join('<u>/</u>')
        } else {
            return par[s] || s
        }
    },
    sid: function(v, rs, par) {
        if (v && v.toString().indexOf(',') > 0) {
            var r = [];
            v = v.split(',');
            $.each(v, function(i, o) {
                r.push(L.S[o] || o)
            });
            return r.join(par || ',')
        } else {
            return L.S[v] || v
        }
    },
    sidstr: function(v) {
        return v + '<input name="sid" /><a class="app" fun="checkpack_sid,sid">[选取]</a>'
    },
    pidTip: function(v, rs) {
        if (rs.sid && typeof rs.sid == 'string') {
            if (rs.sid === 'all') {
                v += '<i class="pidTip" title="' + L.sidall + '">A</i>'
            } else if (rs.sid.substr(0, 1) === ',') {
                rs.sid = rs.sid.replace(/^,|,$/g, '');
                var n = rs.sid.split(',');
                n = n.length;
                v += '<i class="pidTip" title="' + n + '个平台共用">' + n + '</i>'
            }
        }
        return '<p class="pr" style="color:red">' + v + '</p>'
    },
    langtype: function(v) {
        var fix = VAR.langtypeArr[v];
        if (!fix) return v;
        return L.config[fix] + '<i>(' + v + ')</i>' || v
    },
    cut: function(v, rs, len, tag, aPar) {
        v = v ? v.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '', len = len || 50;
        if ($.inArray(S.langfix, ['th', 'zh', 'kr', 'jp']) >= 0) len /= 2;
        return (v && v.length > len) ? '<span' + (aPar && aPar[1] === 'notit' ? '' : ' title="' + v + '"') + '>' + v.replace(/{/g, 'DKHL').replace(/}/g, 'DKHR').substr(0, len) + '…</span>' : v
    },
    plogsid: function(v) {
        return '<i>' + v + ')</i>' + (L.S[v] || v)
    },
    pic: function(s, rs, par, tag, aPar) {
        if (!s) return '-';
        var p = F.cfg(par) || {};
        F.setPar(p);
        var d = p.delPath || '',
            n = p.v || 30,
            path = F.imagesUrl(p.cms),
            src = path + d + s;
        if (par == 'prop') {
            src = path + d + 'big80' + s;
            return '<a href="' + src + '" target="_blank"><img view="' + src + '" src="' + src + '" height="' + n + '" onerror="F.err(this)" /></a>'
        }
        if (p.model == 'more') {
            var temp = s.split(F.andstr),
                temp2 = '';
            $.each(temp, function(i, o) {
                if (!o) return;
                temp2 += out(path + d + o)
            });
            return temp2
        } else {
            return out(src)
        }
        function out(src) {
            if (aPar && aPar[1] === 'src') return src;
            if (src.indexOf('.swf') > 0) {
                return COMM.swf(src, n, n)
            } else {
                return '<a href="' + src + '" target="_blank"><img view="' + src + '" src="' + src + '" height="1" onload="F.autoHeight(this,' + n + ')" onerror="F.err(this)" /></a>'
            }
        }
    },
    upload: function(val, rs, set, tag, parArr) {
        var opt = F.cfg(set);
        if (!opt) opt = F.cfg('img');
        var id = 0,
            _upload = opt._upload,
            _check = opt._check;
        if (opt._attach) {
            id = rs && rs[opt._attach] ? rs[opt._attach] : 0;
            opt.$dbid = id;
            _check = 'hide'
        }
        opt.$dbuid = rs && rs[opt._uid] ? rs[opt._uid] : 0;
        if (opt.$dbuid && opt.$dbuid != MY.id) {
            _upload = 'hide';
            _check = 'hide'
        }
        var readonly = opt._input === 'input' ? '' : ' disabled="true" ';
        if (opt._input === 'hide') readonly = ' style="display:none" ';
        tag = parArr && parArr[1] ? parArr[1] : TPL._tag(tag);
        var up = _upload === 'hide' ? '' : '<a onclick="F.upload(\'' + set + '\',\'' + tag + '\',this)">[' + L.upload + ']</a>&nbsp;';
        var ck = _check === 'hide' ? '' : '<a onclick="F.get(\'' + set + '\',\'' + tag + '\',this)">[' + L.filecheck + ']</a>';
        var view = opt._view === 'hide' ? '' : '<span id="' + tag + 'View" class="viewObj">' + F.getView(val, tag, opt) + '</span>';
        var attr = parArr && parArr.attr ? parArr.attr : 'size="' + (opt.inputsize || 30) + '"';
        var ret = opt._attach ? '<input name="upload_temp_val" value="' + F.setPar(clone(opt)).path + '" type="hidden" />' : '';
        ret += '<input name="' + tag + '" value="' + val + '" ' + readonly + attr + ' />' + up + ck + view;
        return ret
    },
    pid: function(val, rs, par, tag, parArr) {
        var str, tit = par === 'act' ? '活动' + L.pid : L.pid;
        if (rs && typeof rs[tag] != 'undefined' && (!parArr || parArr[1] !== 'edit')) {
            if (!VAR[par + 'Map']) return Msg.err('VAR.' + par + 'Map数据不存在！');
            str = rs[tag] + '-' + VAR[par + 'Map'][rs[tag]];
            if (MY.gid == 1) {
                str += '&nbsp;&nbsp;<u>开发者修改</u>：<input name="' + tag + '" size="5" value="' + rs[tag] + '" />'
            } else if (par === 'act' || par === 'croupier' || par === 'beauty') {
                str += '<input name="' + tag + '" value="' + rs[tag] + '" type="hidden" />'
            }
        } else {
            str = '<select name="' + tag + '" must="' + L.needselect + tit + '" style="width:150px">' + COMM.mapSel(par, '', 1, 0, val) + '</select>&nbsp;' + L.find + '：<input size="5" value="" onkeyup="COMM.mapSearch(\'' + par + '\',this)" />';
            if (par != 'limit' && SYS.allow(par + '.reg') && par != 'interpropsui') str += '&nbsp;' + L.notexist + '<a class="app" fun="regMap_' + par + '">' + L.reg + '</a>'
        }
        return '<tr><td class="myTableLeft"><t>' + tit + '：</t></td><td id="' + tag + 'Obj">' + str + '</td></tr>'
    },
    _tag: function(tag) {
        if (tag && tag.indexOf('.') > 0) {
            var s = '';
            tag = tag.split('.');
            $.each(tag, function(i, o) {
                if (i == 0) return s += o;
                s += '[' + o + ']'
            });
            tag = s
        }
        return tag
    },
    input: function(v, rs, par, tag, aPar) {
        var s = '';
        aPar = aPar || {};
        if (aPar.must) s += ' must="' + aPar.must + '"';
        if (aPar.int) s += ' onkeyup="COMM.autoInt(this)"';
        if (aPar.tc) s += ' class="tc"';
        if (aPar.hide) s += ' type="hidden"';
        if (aPar.def && !v && v !== 0) v = aPar.def;
        if (aPar.width) s += ' style="width:' + aPar.width + 'px;"';
        return '<input name="' + TPL._tag(tag) + '" value="' + v + '" size="' + (aPar.size || 5) + '" ' + s + ' />'
    },
    radio: function(val, rs, par, tag, pars, tpl) {
        console.log(val, rs, par, tag, pars, tpl);
        pars = pars || {};
        var set = COMM.checkRadioPar(par, tag, tpl ? tpl.config : ''),
            s = '',
            ck, name = '';
        if (typeof set == 'string' || !set) return set;
        $.each(set, function(i, o) {
            i = TPL.$s(i);
            var ck = val == i || i == pars['default'] ? ' checked="true"' : '';
            s += '<label class="checkbox"><input type="radio" value="' + i + '" name="' + (pars[1] && rs[pars[1]] ? 'data[' + rs[pars[1]] + '][' + tag + ']' : (pars[1] ? pars[1] : TPL._tag(tag))) + '"' + ck + ' />' + (pars.showid ? i + ' - ' : '') + o + '</label>'
        });
        return s
    },
    checkbox: function(val, rs, par, tag, pars, tpl) {
        var set = COMM.checkRadioPar(par, tag, tpl ? tpl.config : ''),
            s = '',
            ck;
        if (typeof set == 'string' || !set) return set;
        $.each(set, function(i, o) {
            i = TPL.$s(i);
            ck = (',' + val + ',').indexOf(',' + i + ',') >= 0 ? ' checked="true"' : '';
            s += '<label class="checkbox"><input type="checkbox" value="' + i + '" name="' + (pars && pars[1] ? 'data[' + rs[pars[1]] + '][' + tag + ']' : TPL._tag(tag)) + '"' + ck + ' />' + o + '</label>'
        });
        return s
    },
    radios: function(v, rs, par, tag, aPar) {
        aPar = aPar || {};
        aPar.type = 'radio';
        return TPL.checkboxs(v, rs, par, tag, aPar)
    },
    checkboxs: function(v, rs, par, tag, aPar) {
        aPar = aPar || {};
        aPar.type = aPar.type == 'radio' ? 'radio' : 'checkbox';
        aPar.width = (aPar.width || '98%').toString();
        if (aPar.width.indexOf('px') == -1 && aPar.width.indexOf('%') == -1) aPar.width += 'px';
        var cls = 'checkboxs';
        if (!TPL._checkboxs) {
            TPL._checkboxs = 1;
            var s = '<style>.' + cls + '{position:relative}';
            s += '.' + cls + '>span{width:auto;height:auto}';
            s += '.' + cls + '>span>span{display:inline-block;width:auto;height:auto;padding:2px 8px;margin:1px;border-radius:9px;background:#3a87ad;color:#fff}';
            s += '.' + cls + ' ._main{position:absolute;z-index:99;top:20px;left:0;min-width:98%;background:#fff;border:1px solid #ccc;padding:10px 0 10px 10px;display:none}';
            s += '.' + cls + ' ._so{margin-bottom:5px}';
            s += '.' + cls + ' ._con{max-height:300px;overflow:auto}';
            s += '.' + cls + ' ._con label{float:left;height:18px;line-height:18px;overflow:hidden;display:inline-block}';
            s += '</style>';
            $(document.body).append(s)
        }
        var html = function(v) {
            if (!v) return '';
            var set = COMM.checkRadioPar(par, tag),
                v = typeof v == 'string' && v ? v.split(',') : v,
                r = [];
            $.each(v, function(i, o) {
                r.push('<span>' + (set[o] || o) + '</span>')
            });
            return r.join('')
        };
        var show = function(t, li) {
            switch (t) {
                case '2':
                    var o = li.find('input:checked');
                    if (o.length) {
                        o = o.parent();
                        o.siblings().show();
                        o.hide()
                    } else {
                        li.show()
                    }
                    break;
                case '1':
                    var o = li.find('input:checked');
                    if (o.length) {
                        o = o.parent();
                        o.siblings().hide();
                        o.show()
                    } else {
                        li.hide()
                    }
                    break;
                default:
                    li.show()
            }
            ckdb(li)
        };
        var ckdb = function(li) {
            li.eq(0).parent().find('._no').remove();
            if (!li.is(':visible')) {
                li.last().after('<div class="_no" style="padding:10px;color:red;text-align:center">' + L.nodata + '</div>')
            }
        };
        var k1 = TPL.o(function(i, my) {
            var main = $(my).next();
            if (main.is(':visible')) return;
            var n = Math.max(int(aPar[1]), 1),
                li = main.find('._con label'),
                h = $(my).parent().height(),
                w = int((main.width() - 35) / n),
                st = main.find('._so input[name="_st"]'),
                on = 1;
            st.click(function() {
                main.find('._so>input:eq(0)').val('');
                show(this.value, li)
            });
            li.width(w);
            main.css('top', h).show();
            st.eq(0).click();
            main.unbind().mouseenter(function() {
                on = 1
            }).mouseleave(function() {
                on = 0
            });
            var end = function() {
                if (on) return;
                $(document.body).unbind('click', end);
                var v = getCheckBox(TPL._tag(tag)),
                    o = $(my).parents('.' + cls + ':eq(0)');
                o.find('>span').html(html(v));
                return main.hide()
            };
            $(document.body).click(end);
            if (aPar.type == 'radio') li.click(function() {
                on = 0;
                end()
            });
            setTimeout(function() {
                on = 0
            }, 100);
            var tm;
            TPL.checkboxso = function(my) {
                if (my === 0) {
                    on = 0;
                    return end()
                }
                if (tm) clearTimeout(tm);
                tm = setTimeout(function() {
                    var wd = my.value;
                    st.eq(0).attr('checked', true);
                    if (wd == '') {
                        li.show()
                    } else {
                        wd = wd.toUpperCase();
                        li.each(function(i, tg) {
                            var node = $(tg),
                                txt = node.text(),
                                val = node.find('input').val();
                            if (val && val.toUpperCase().indexOf(wd) >= 0 || txt && txt.toUpperCase().indexOf(wd) >= 0) {
                                node.show()
                            } else {
                                node.hide()
                            }
                        })
                    }
                    ckdb(li)
                }, 100)
            }
        }, true, par + '/' + tag + '/' + aPar);
        TPL.checkboxstp = ['全部', '选中', '未选中'];
        var em = aPar.tag || 'div';
        var r = '<' + em + ' class="' + cls + '">';
        r += '<span>' + html(v) + '</span><a onclick="TPL.o(' + k1 + ',this)">[选取]</a>';
        r += '<div class="_main" style="width:' + aPar.width + '">';
        r += '<div class="_so">';
        if (aPar.search != 'hide') r += '<input placeholder="输入关键字进行搜索" onkeyup="TPL.checkboxso(this)" style="width:120px" />';
        if (aPar.type != 'radio') r += '<button onclick="TPL.checkboxso(0)" style="width:auto;padding:0 3px;margin:0 3px 0 0">确定选取</button>';
        if (aPar.showtype != 'hide') r += '显示：' + TPL.radio(0, '', 'TPL.checkboxstp', '_st');
        r += '</div>';
        r += '<div class="_con">' + TPL[aPar.type](v, rs, par, tag) + '</div>';
        r += '</div>';
        r += '</' + em + '>';
        return r
    },
    $s: function(i) {
        return i && typeof i == 'string' && i.indexOf('$s') === 0 ? i.replace('$s', '') : i
    },
    _selects: 1,
    selectsInit: function() {
        return TPL.selects('', '', 'C.x')
    },
    selects: function(val, rs, par, tag, pars) {
        pars = pars || {};
        pars.type = pars.type || 'radio';
        var id = 'selects_' + TPL._selects++,
            r = ['<style>'],
            _t, _tm = 0,
            _clear;
        r.push('#' + id + '{border:1px solid #ccc;height:auto;margin:0;padding:0;position:relative;cursor:pointer;display:inline-block}');
        r.push('#' + id + '>p{background:url(' + SKIN.sys + 'leftopen.gif) right bottom no-repeat;padding:0 9px 0 3px;word-break:keep-all}');
        r.push('#' + id + '>div{display:none;padding:5px;position:absolute;z-index:999;width:' + (pars.width || 100) + 'px;border:1px solid #ccc;background:#fff;text-align:left}');
        r.push('#' + id + '>div>div>label{display:block}');
        if (pars.css) r.push(pars.css.replace(/\$id/g, id));
        r.push('</style>');
        r.push('<span id="' + id + '">');
        r.push('<p></p>');
        r.push('<div>');
        if (pars.search) r.push('<input type="text" placeholder="快速搜索" style="width:98%;margin-bottom:5px" />');
        r.push('<div style="max-height:' + (pars.height || 300) + 'px;overflow:hidden;overflow-y:auto">' + TPL[pars.type](val, rs, par, tag, {
                showid: pars.showid
            }) + '</div>');
        r.push('</div></span>');
        r.push(TPL.script(function(id) {
            _clear = function() {
                if (_t) {
                    clearTimeout(_t);
                    _t = 0
                }
            };
            $('#' + id).mouseleave(function() {
                _clear();
                var my = $(this);
                var end = function() {
                    my.find('div').hide();
                    if (pars.showval) return my.find('p').html(pars.def || pars.showval);
                    var t = [];
                    my.find('input:checked').each(function(i, o) {
                        t.push($(o).parent().text())
                    });
                    my.find('p').html(t.join((pars.join || '<br>')) || pars.def || '-请选择-')
                };
                if (!_tm) return end();
                _t = setTimeout(end, _tm)
            }).mouseenter(function() {
                _clear();
                $(this).find('div').css(pars.pos || 'left', -1).show()
            }).mouseleave();
            if (pars.type === 'radio') {
                $('#' + id).find('input[type=radio]').click(function() {
                    $('#' + id).mouseleave()
                })
            }
            if (!pars.search) return;
            $('#' + id).find('input[type=text]').focus(function() {
                _tm = 3000
            }).blur(function() {
                _tm = 0
            }).keyup(function() {
                var k = this.value,
                    lab = $(this).parent().find('label');
                if (k == '') {
                    lab.show()
                } else {
                    lab.each(function(i, o) {
                        var v = $(o).find('input').val(),
                            t = $(o).text();
                        if (k == v || k == t || v.toString().indexOf(k) != -1 || t.toString().indexOf(k) != -1) {
                            $(o).show()
                        } else {
                            $(o).hide()
                        }
                    })
                }
            })
        }, id));
        return r.join('')
    },
    select: function(val, rs, par, tag, pars, tpl) {
        var set = COMM.checkRadioPar(par, tag, tpl ? tpl.config : ''),
            name = pars && pars[1] && pars[1] !== 'search' ? 'data[' + rs[pars[1]] + '][' + tag + ']' : TPL._tag(tag),
            opt = {
                'name': name,
                'def': val,
                'data': set
            };
        if (pars && pars.attr) opt.attr = pars.attr;
        var s = COMM.getSelect(opt);
        if (pars && pars[1] === 'search') {
            var i = TPL.o({
                set: set,
                name: name
            }, true);
            s = '<input onkeyup="TPL.selectSearch(this,TPL.o(' + i + '))" size="5" placeholder="' + L.btn.search + '" />' + s
        }
        return s
    },
    selectSearch: function(my, d) {
        var obj = $(my).parent().find('[name="' + d.name + '"]'),
            v = my.value,
            sel, k, html;
        obj.find('option').remove();
        if (v) v = v.toUpperCase();
        $.each(d.set, function(i, o) {
            k = i.toString();
            html = o.toString().toUpperCase();
            if (v == '' || k == v || html == v || k.indexOf(v) >= 0 || html.indexOf(v) >= 0) {
                var r = COMM.optionTitle(o);
                if (k && k.indexOf('$s') === 0) i = k.replace('$s', '');
                obj.append('<option value="' + i + '"' + (sel ? '' : ' selected="true"') + r.tit + '>' + r.v + '</option>');
                sel = 1
            }
        });
        if (!sel) obj.append('<option value="">-nothing-</option>');
        if (v == '') obj.find('option[value="' + obj.attr('defval') + '"]').attr('selected', true);
        obj.change()
    },
    timestr: function(fix, t1, t2) {
        var n1 = fix ? fix + '[starttime]' : 'starttime',
            n2 = fix ? fix + '[endtime]' : 'endtime';
        return '<input onclick="D.init(this)" name="' + n1 + '" value="' + (t1 || '') + '" readonly="true" placeholder="请选取时间" />-&nbsp;<input onclick="D.init(this)" name="' + n2 + '" value="' + (t2 || '') + '" readonly="true" placeholder="请选取时间" />'
    },
    times: function(val, rs, par) {
        if (par) {
            rs.starttime = rs.starttime ? $D.date(par, rs.starttime) : rs.starttime;
            rs.endtime = rs.endtime ? $D.date(par, rs.endtime) : rs.endtime
        }
        return TPL.timestr('', rs.starttime, rs.endtime)
    },
    time: function(v, rs, par) {
        if (par) {
            rs.starttime = rs.starttime ? $D.date(par, rs.starttime) : rs.starttime;
            rs.endtime = rs.endtime ? $D.date(par, rs.endtime) : rs.endtime
        }
        return '<i title="' + L.time1 + '">' + (rs.starttime || '') + '</i><br /><i title="' + L.time2 + '">' + (rs.endtime || '') + '</i>'
    },
    ttype: function(v) {
        return VAR.ttypeArr[v] || v
    },
    ttypeSelect: function(v, rs, par) {
        par = par || '桌子类型';
        return TPL.catalog(v, rs, 'VAR.ttypeArr', 'ttype', ['VAR.ttypeArr', '=请选择' + par + '=', par])
    },
    catalog: function(cid, rs, par, tag, pArr) {
        var sel, tit = L.catalog,
            def;
        def = tag == 'ttype' ? '-1' : '';
        if (par.indexOf('.') > 0) {
            tit = pArr[2] || L.activitename;
            sel = COMM.getSelect({
                'name': tag,
                'data': eval(par),
                'add': '<option value="' + def + '">' + (pArr[1] && pArr[1].length > 5 ? pArr[1] : L.mustactive) + '</option>',
                'attr': ' must="' + (pArr[2] ? l(L.must, [pArr[2]]) : L.mustactive) + '"',
                'def': cid,
                'showId': pArr[1]
            })
        } else {
            sel = COMM.cmsSelect({
                'fid': COMM.appId(par),
                'name': tag,
                'model': par,
                'attr': pArr[1] && cid != '' ? 'disabled="true"' : '',
                'def': cid
            })
        }
        var s = pArr.colspan ? ' colspan="' + pArr.colspan + '"' : '';
        return '<tr id="catalogobj_' + par + '"><td class="myTableLeft"><t>' + tit + '：</t></td><td' + s + '>' + sel + '</td></tr>'
    },
    catalogs: function(cid, rs, par, tag, pArr) {
        var ck, data = eval(par),
            ret = '<input type="checkbox" name="' + tag + '" value="all"' + (cid === 'all' ? 'checked="true"' : '') + ' />通用&nbsp;';
        $.each(data, function(i, o) {
            ck = cid && (cid == i || cid.indexOf(',' + i + ',') >= 0) ? 'checked="true"' : '';
            ret += '<input type="checkbox" name="' + tag + '" value="' + i + '"' + ck + ' />' + o + '&nbsp;'
        });
        var s = pArr.colspan ? ' colspan="' + pArr.colspan + '"' : '';
        return '<tr id="catalogobj_' + par + '"><td class="myTableLeft"><t>' + L.catalog + '：</t></td><td' + s + '>' + ret + '</td></tr>'
    },
    cases: function(s, rs, par, tag, parArr, tpl) {
        var set = COMM.checkRadioPar(par, tag, tpl ? tpl.config : '');
        if (typeof set == 'string' || !set) return set;
        var fmt = function(v) {
            if (typeof v == 'undefined') {
                if (parArr && parArr[1]) {
                    v = parArr[1]
                } else if (typeof set['$def'] != 'undefined') {
                    v = set['$def']
                } else {
                    v = ''
                }
            }
            return v
        };
        if (s || s == 0) {
            if (s.indexOf(',') > 0) {
                var r = [],
                    v;
                $.each(s.split(','), function(i, o) {
                    v = fmt(set[o]);
                    if (v !== '') r.push(v)
                });
                return r.join('、')
            } else {
                return '<span class="case' + s + '">' + fmt(set[s]) + '</span>'
            }
        } else {
            return fmt(set[s])
        }
    },
    date: function(t, rs, par) {
        if (t <= 0) return '';
        return $D.date(par, t)
    },
    dateLocal: function(t, rs, par) {
        if (t <= 0) return '';
        return $D.date(par, t, 1)
    },
    chips: function(n, s) {
        return '<span title="' + (typeof(s) == 'string' ? s : '') + COMM.numbers(n) + '">' + COMM.number(n) + '</span>'
    },
    def: function(v, rs, p) {
        return v != '' ? v : p
    },
    color: function(v, rs, par, tag) {
        if (v && v != '0') {
            if (v.indexOf('#') == -1) v = '#' + v;
            if (par) return ' style="color:' + v + '"';
            v = ' value="' + v + '" style="border:1px solid #999;padding:1px;background:' + v + '"'
        } else {
            v = '';
            if (par) return ''
        }
        var n = TPL.o('[name="' + tag + '"]', true);
        return '<input type="button" value="' + L.checkcolor + '" onclick="Color.init(this,TPL.o(' + n + '))" /><input name="' + tag + '" size="6" title="' + L.checkcolor + '" onclick="Color.init(this)"' + v + ' />'
    },
    dateGroup: function(d, rs) {
        d = $D.date('Y-m-d', d);
        if (rs.index == 0) {
            VAR.dateGroup = d;
            return ''
        }
        if (VAR.dateGroup && VAR.dateGroup != d) {
            VAR.dateGroup = d;
            return ' style="background:#efefef"'
        } else if (!VAR.dateGroup) {
            VAR.dateGroup = d
        }
        return ''
    },
    bag: function(id, rs, par, tag, aPar) {
        if (id > 0 || id && id.toString().indexOf('b') == 0) {
            var s = '<input name="' + tag + '" size="5" value="' + id + '" />',
                aid = aPar && aPar.aid ? aPar.aid : 0;
            if (par === 'view') s = '<b>' + id + '</b>';
            s += '&nbsp;<a onclick="SYS.bagView(\'' + id + '\',event,\'' + aid + '\')">[查看]</a>&nbsp;';
            return s + '<a onclick="SYS.bag(\'' + id + '\',0,0,0,\'' + aid + '\')">[编辑]</a>'
        }
        if (par === 'view') return id;
        if (aPar && aPar.fun) par = aPar.fun;
        return '<span><input name="' + tag + '" size="5" value="" /><a onclick="SYS.bag(0,\'' + par + '\',\'' + tag + '\',this)">[添加]</a></span>'
    },
    downList: function(type) {
        Msg.doing();
        var f = new Form($('#downList'));
        if (!f.check()) return;
        var day = f.data && f.data.day ? f.data.day : 1;
        var daytype = f.data && f.data.daytype ? f.data.daytype : '-';
        var downtype = f.data && f.data.downtype ? f.data.downtype : '';
        var name = {
            'OrderList': '订单',
            'ChipsDetail': '金币明细',
            'Plog': '牌局',
            'Monitor': '大客户监控',
            'IpList': '登陸排行',
            'Levels': '头衔管理',
            'NLock': '禁封查询',
            'mforder': 'mf订单',
            'Newreg': '每日新注册',
            'mailtaskback': '召回用户',
            'mailtasksend': '(邮件/消息)已发送用户',
            'Phone': '手机号收集统计'
        };
        var daylist = {
            '+': '前',
            '-': '内'
        };
        type = type ? type : '';
        var dir = '';
        var cmsxls = ['Levels'];
        if ($.inArray(type, cmsxls) != -1) dir = 'cms';
        var url = dir == 'cms' ? PATH.app + 'downList/' : S.cmsapi;
        var fun = function() {
            downtype = downtype ? downtype : type;
            var par = {
                url: url + 'downList.php?cmd=get&day=' + day + '&daytype=' + daytype + '&downtype=' + downtype,
                callback: function(rs) {
                    Msg.close();
                    rs.downtype = rs && rs.downtype ? rs.downtype : downtype;
                    rs.day = rs.day ? rs.day : 1;
                    var fileurl = dir == 'cms' ? 'http://' + location.host + CMS_PATH : S.cmsapi.replace('cmsapi/', '');
                    var html = '<form id="downList" style="padding:10px">' + COMM.getSelect('downtype', name, '', '', rs.downtype) + '查询<input name="day" size="5" value="' + rs.day + '" />天' + COMM.getSelect('daytype', daylist, '', '', rs.daytype) + '<input onclick="TPL.downList(\'' + type + '\')" type="button" value="查询" /> 共:' + rs.num + '条记录</form><div id="list" style="padding:5px 10px">';
                    $.each(rs.loop, function(i, o) {
                        html += '<a href="' + fileurl + 'data/excel/' + o.file + '"><span style="padding-left:10px"><img src="' + SKIN.img + 'down.jpg"></span><span style="padding-left:10px">' + o.file + '</span></a><span style="padding-left:10px">日期：' + o.date + '</span><br />'
                    });
                    if (rs.num == 0 && name[rs.downtype]) html += '<span class="case1">【' + name[rs.downtype] + '】' + rs.day + '天' + daylist[rs.daytype] + '暂无导出记录！</span>';
                    html += '</div>';
                    RIGHT.html(html)
                }
            };
            if (dir != 'cms') par['jsonp'] = true;
            RIGHT.loadData(par)
        };
        if (downtype) {
            fun()
        } else {
            SYS.window({
                title: '我的导出记录',
                width: '50%',
                height: '50%',
                init: fun
            })
        }
    },
    mfdownList: function(type) {
        Msg.doing();
        var f = new Form($('#downList'));
        if (!f.check()) return;
        var day = f.data && f.data.day ? f.data.day : 1;
        var downtype = f.data && f.data.downtype ? f.data.downtype : '';
        var name = {
            'logcenter_mf.brush_v2': '反刷分',
            'OrderList': '订单',
            'ChipsDetail': '金币明细',
            'Plog': '牌局',
            'Monitor': '大客户监控',
            'IpList': '登陸排行',
            'Levels': '头衔管理',
            'NLock': '禁封查询',
            'mforder': 'mf订单',
            'Newreg': '每日新注册',
            'mailtaskback': '召回用户',
            'mailtasksend': '(邮件/消息)已发送用户',
            'Phone': '手机号收集统计'
        };
        type = type ? type : '';
        var tm2 = $D.time(),
            tm1 = tm2 - day * 86400;
        var fun = function() {
            downtype = downtype ? downtype : type;
            if (downtype && !name[downtype]) {
                Msg.close();
                return Msg.err('类别出错！')
            }
            var par = {
                'sql': 'select * from logcenter_mf.export_log where sid=' + S.id + ' and _uid = ' + MY.id + (downtype ? ' and tname=\'' + downtype + '\'' : '') + ' and UNIX_TIMESTAMP(_tm) >= ' + tm1 + ' and UNIX_TIMESTAMP(_tm) <=' + tm2 + ' order by _tm desc',
                t: 'logcenter_mf.brush_v2'
            };
            var parm = {
                url: CGI.mflist + '?action=records',
                lcdata: par,
                callback: function(rs) {
                    Msg.close();
                    var num = rs.loop.length;
                    var fileurl = CGI.mf + 'brush2/' + rs.filepath;
                    var html = '<form id="downList" style="padding:10px">' + COMM.getSelect('downtype', name, '', '', downtype) + '查询<input name="day" size="5" value="' + day + '" />天内<input onclick="TPL.mfdownList(\'' + type + '\')" type="button" value="查询" /> 共:' + num + '条记录</form><div id="list" style="padding:5px 10px">';
                    $.each(rs.loop, function(i, o) {
                        html += '<a href="' + CGI.mf + 'brush2/' + o.filepath + '"><span style="padding-left:10px"><img src="' + SKIN.img + 'down.jpg"></span><span style="padding-left:10px">' + o.filepath + '</span></a><span style="padding-left:10px">日期：' + o._tm + '</span><br />'
                    });
                    if (num == 0 && name[downtype]) html += '<span class="case1">【' + name[downtype] + '】查询' + day + '天内' + '暂无导出记录！</span>';
                    html += '</div>';
                    RIGHT.html(html)
                }
            };
            RIGHT.loadData(parm)
        };
        if (downtype) {
            fun()
        } else {
            SYS.window({
                title: '我的导出记录',
                width: '50%',
                height: '50%',
                init: fun
            })
        }
    },
    downInput: function(v) {
        SYS.window({
            title: '导出提示',
            width: '500',
            height: '300',
            init: function() {
                var html = '<table class="myTable left m5 versions"><tr><td>\n<span>时间段：<input name="starttime" onclick="D.init(this)" value="' + $D.date('Y-m-d') + '">-<input name="endtime" onclick="D.init(this)" value="' + $D.date('Y-m-d') + '"></span><input type="button" value="导出" onclick="TPL.getDown(\'' + v + '\')"></td></tr>\n</table>';
                RIGHT.html(html)
            }
        })
    },
    downTips: function(file) {
        if (!file) return;
        Msg.doing();
        SYS.window({
            title: '导出提示',
            width: '500',
            height: '100',
            init: function() {
                Msg.close();
                var html = '<table class="myTable left m5 versions"><tr><td style="text-align: center;"><b>RTX没提示时可<a href="' + file + '" target="_blank">点击下载导出文件</a></b><u>（如点击显示404，请稍等…）</u></td></tr></table>';
                RIGHT.html(html)
            }
        })
    },
    downto: function() {
        Msg.doing();
        SYS.window({
            title: '导出引导',
            width: '500',
            height: '100',
            init: function() {
                Msg.close();
                var html = '<table class="myTable left m5 versions"><tr><td style="text-align: center;"><b><a href="http://mf.oa.com/HBServlet/log/order.jsp" target="_blank" style="font-size:22px"><img src="' + SKIN.winBtn + 'next.gif' + '"> 点击进入数据导出系统</a></b></td></tr></table>';
                RIGHT.html(html)
            }
        })
    },
    getDown: function(v, w) {
        var channel = '主键ID,日期,平台,升级等级,好友赠送,好友发福利(消耗),安全設置獎勵,响应邀请,完成新手任务,幸运红黑牌(获得),幸运转盘,成功邀请,抢押牌,排行榜赠送(获得),新手小游戏(获得),' + '新手引导v2,新手训练营,新手训练营,晋级赛发放,有奖问答,每日一课(获得),每日活跃度任务获得,淘汰赛发放,淘金赛奖,游客绑定赠送,猜手牌,玩偶升级,用乐透包,用救济卡,' + '破产挽救,破产支付,礼物回收,粉丝群奖励礼物,老广告用户回归奖,老虎机积分,老虎机赢得,荷官场通赔奖励,计时奖励,足球競猜获得,连续登录抽奖,锦标赛获得游戏币,' + '防流失获得,高低牌(获得),成为会员,购买珍珠道具,购买翡翠道具,购游戏币,钻石生效,积分抽奖(获得),竞技赛,粉丝链接,超级老虎机(获得),限时宝箱,刮刮乐扣钱,猜手牌(减少),' + '幸运红黑牌(消耗),老虎机投注,购买乐透,足球競猜消费,高低牌(消费),互动道具(消费),购买礼物,赠送好友,使用荷官(消费),播放魔法,淘金赛报名(消费),淘汰赛消费(消费),晋级赛消耗(消费),' + '给荷官小费(消费),锦标赛报名(消费),好友发福利（获得）,四叶草赠(获得),幸运筹码(获得),每日登入(获得),粉丝奖励(获得),首次进入(获得),猜手牌(好友抢中自己增加),管理员赠(获得),' + '荷官场（红利赢）,荷官场（玩牌赢钱）,平台(0全部1移动),生成时间';
        var coinsGktitle = '主键ID,日期,平台,7天内未被封的活跃用户的货币总量,14天内未被封的活跃用户的货币总量,30天内未被封的活跃用户的货币总量,7天内未被封、非付费的活跃用户的货币总量,' + '14天内未被封、非付费的活跃用户的货币总量,30天内未被封、非付费的活跃用户的货币总量,7天内未被封、付费的活跃用户的货币总量,14天内未被封、付费的活跃用户的货币总量,' + '30天内未被封、付费的活跃用户的货币总量,8天以上未活跃用户的货币总量,15天以上未活跃用户的货币总量,30天以上未活跃用户的货币总量,8天以上未活跃、非付费用户的货币总量,' + '15天以上未活跃、非付费用户的货币总量,30天以上未活跃、非付费用户的货币总量,8天以上未活跃、付费用户的货币总量,15天以上未活跃、付费用户的货币总量,30天以上未活跃、付费用户的货币总量,' + '被封用户货币总量,记录生成时间';
        var stealchipv2 = '主键ID,平台,用户ID,用户头像,unid,用户名,性别(0男1女2保密),好友数,等级,语言,邮箱,注册IP,注册IP所属国家,最后登录IP,最后登录IP所属国家,最大持有游戏币数量,当前持有游戏币数量,当前持有免费游戏币数量,台费,当前牌局总数,注册时间,最后登录时间,消费总金额,是否粉丝,完成新手任务次数,历史赢牌局数,历史输牌局数,移动好友赠送筹码次数,移动好友赠送筹码数量,移动每日任务领取游戏币量,四叶草领取次数,幸运筹码领取次数,帮好友开彩蛋领取次数,状态(状态0需要发profile、1禁用、9需要更新资料、10正常),记录生成时间';
        var emWarningSql = "tm,gt_30,(le_30+eq_1),consume_coins,provide_coins,provide_coins-consume_coins,total_user,day_new_user,day_active_user,month_active_user,ROUND(provide_coins/consume_coins,2),ROUND(day_new_user/day_active_user,2),ROUND(day_active_user/month_active_user,2)";
        var vmoneytopSql = '_uid,mnick,total,pay,s_250000,c_250000,s_200000,c_200000,s_100000,c_100000,s_50000,c_50000,s_20000,c_20000,s_10000,c_10000,s_5000,c_5000,s_2500,c_2500,s_2000,c_2000,s_1000,c_1000,s_500,c_500,s_250,c_250,s_200,c_200,s_100,c_100';
        var vmoneytopTitle = '用户mid,昵称,台费总数,当天储值,25W台费,25W局数,20W台费,20W局数,10W台费,10W局数,5W台费,5W局数,2W台费,2W局数,1W台费,1W局数,5K台费,5K局数,2.5K台费,2.5K局数,2K台费,2K局数,1K台费,1K局数,500台费,500局数,250台费,250局数,200台费,200局数,100台费,100局数';
        var chMonitorTitle = '用户id,几线渠道商,所属渠道商下线,上周by卡充值卡量,上周充卡量与上上周环比,上月by卡充值卡量,上月充卡量与上上月环比,by卡充值卡量(总次数),by卡价值游戏币量,当前持有游戏币,免费游戏币总量,(上月)赢牌游戏币量,(上月)2人牌局数（赢牌）,(上月)2人牌局赢取游戏币总量,(上月)输牌游戏币量,(上月)2人牌局数（输牌）,(上月)2人牌局输牌游戏币总量,未登录天数,处理次数,备注';
        var chMonitorSql = '_uid,level,higher,last_week_order1,round((last_week_order1-last_week_order0)/last_week_order0),last_month_order1,round((last_month_order1-last_month_order0)/last_month_order0),order_num,order_coins,mmoney,mfree,win_coins0,win_games,win_coins1,lost_coins0,lost_games,lost_coins1,round((UNIX_TIMESTAMP(_tm)-UNIX_TIMESTAMP(mactivetime))/86400),deal_num,remark';
        var tablecfg = {
            stealchipv2: ['logcenter_mf.brush_v2', 'sql', 'id,_plat,_uid,mhasicon,unid,mnick,gender,mfcount,mlevel,lang,email,regip,regip_name,loginip,loginip_name,maxOwnChips,mmoney,mfree,vmoney,mpcount,FROM_UNIXTIME(mtime) as mtime,FROM_UNIXTIME(logintime) as logintime,mpay,mprivilege,mtaskcount,winCount,loseCount,count_374,num_374,num_248,count_2,count_32,count_89,mstatus,FROM_UNIXTIME(_tm) as _tm', stealchipv2],
            coiner: ['logcenter_mf.whitelist_log', 'sql', '*'],
            mforder: ['user_order_back', 'log'],
            texasEmSys00: ['logcenter_mf.d_unpay_3day_2mpc', 'sql', '*,round(2mpc/num,2),round(win/num)', '主键ID,日期,平台,二人牌局用户数量,2人牌局当天玩牌数,二人牌局游戏币变化量,当前金币量,二人牌局输,二人牌局赢,记录生成时间,人均2人玩牌数,人均二人牌局游戏币变化量'],
            texasEmSys10: ['logcenter_mf.d_pay_except_bycard', 'sql', '*', '主键ID,日期,平台,用户ID,充值金额（美元）,当前金币量,记录生成时间'],
            texasEmSys11: ['logcenter_mf.d_office_3day_2mpc', 'sql', '*,round(win/num)', '主键ID,日期,平台,二人牌局用户数量,玩二人牌局数,二人牌局游戏币变化量,bycard2000点（张数）,当前持币量,记录生成时间,人均二人牌局游戏币变化量'],
            texasEmSys20: ['logcenter_mf.d_official_business', 'sql', '*', '主键ID,日期,平台,用户ID,bycard2000点（历史张数）,2人牌局数,赢钱,当前金币量,cur_bycards,记录生成时间',
                {
                    0: ' and bycards >500 ',
                    1: ' and bycards >=100 and bycards <=500 ',
                    2: ' and bycards >=10 and bycards <=99 '
                }],
            texasEmSys30: ['logcenter_mf.d_black_business', 'sql', 'tm,_uid,mmoney', '日期,用户ID,当前持币量',
                {
                    0: ' and mmoney >10000000 ',
                    1: ' and mmoney >1000000 and mmoney <10000000 ',
                    2: ' and mmoney >=10000 and mmoney <=1000000 '
                }],
            channelGk0: ['logcenter_mf.d_normal_coins', 'sql', '*', channel,
                {
                    0: ' and type=0 ',
                    1: ' and type=1 ',
                    2: ' and type=2 '
                }],
            channelGk1: ['logcenter_mf.d_black_coins', 'sql', '*', '主键ID,日期,平台,四叶草赠,幸运筹码,每日登录(获得),粉丝奖励,首次进入,平台(0全部1移动),生成时间',
                {
                    0: ' and type=0 ',
                    1: ' and type=1 ',
                    2: ' and type=2 '
                }],
            coinsGk: ['logcenter_mf.d_total_money ', 'sql', '*', coinsGktitle],
            blindNoteGk: ['logcenter_mf.d_blindmin_vmoney ', 'sql', '*', '主键ID,日期,平台,超大额场,大额场,中额场,小额场,平台(0全部1移动),生成时间'],
            blackbusiness: ['logcenter_mf.d_black_business ', 'sql', "tm,_uid,case when mmoney>10000 and mmoney<1000000 then '3' when mmoney>=1000000 and mmoney<=10000000 then '2' else '1' END mstatus,mmoney", '日期,用户ID,黑币商类型,当前持币量'],
            emWarning: ['logcenter_mf.d_total_money ', 'sql', emWarningSql, '日期,流通货币量,沉淀货币量,日游戏币消耗总数,日游戏币发放总数,日游戏币结余,累增用户,日新增用户,日活跃用户,月活跃用户,日发放/日消耗,日新增/日活跃,日活跃/月活跃'],
            vmoneytop: ['logcenter_mf.vmoney_top ', 'sql', vmoneytopSql, vmoneytopTitle],
            chMonitor: ['logcenter_mf.channels_info ', 'sql', chMonitorSql, chMonitorTitle],
        };
        var notimetable = ['coiner', 'chMonitor'];
        var par = {},
            sql = '',
            t = '',
            tm1, tm2, downurl = '',
            where = '';
        if ($.inArray(v, notimetable) == -1) {
            var starttime = $o('[name=starttime]').val(),
                endtime = $o('[name=endtime]').val(),
                dayNum = $o('[name=dayNum]').val();
            if (!starttime) return Msg.err('请选取时间段！');
            tm1 = d2t(starttime);
            if (!endtime) {
                tm2 = tm1;
                dayNum = dayNum ? dayNum : 0;
                tm1 = tm1 - 86400 * dayNum
            } else {
                tm2 = d2t(endtime)
            }
            if (tm1 == tm2) tm2 = tm2 + 86400
        }
        if (tablecfg[v] && tablecfg[v][0] && tablecfg[v][1] && tablecfg[v][2] && tablecfg[v][1] == 'sql') {
            if (v && tablecfg[v][4] && tablecfg[v][4][w]) where = tablecfg[v][4][w];
            if ($.inArray(v, notimetable) != -1) {
                if (v == 'coiner' || v == 'chMonitor') {
                    par = {
                        'sql': 'select ' + tablecfg[v][2] + ' from ' + tablecfg[v][0] + ' where sid=' + S.id + where,
                        uid: MY.id,
                        sid: S.id,
                        t: tablecfg[v][0]
                    }
                } else {
                    par = {
                        'sql': 'select ' + tablecfg[v][2] + ' from ' + tablecfg[v][0] + ' where _plat=' + S._plat + where,
                        uid: MY.id,
                        sid: S.id,
                        t: tablecfg[v][0]
                    }
                }
            } else {
                if (v == 'vmoneytop') {
                    par = {
                        'sql': 'select ' + tablecfg[v][2] + ' from ' + tablecfg[v][0] + ' where sid=' + S.id + ' and tm between ' + starttime + ' and ' + endtime,
                        't': tablecfg[v][0],
                        'uid': MY.id
                    }
                } else {
                    where = v == 'stealchipv2' ? ' and UNIX_TIMESTAMP(_tm) >= ' + tm1 + ' and UNIX_TIMESTAMP(_tm) <=' + tm2 : ' and UNIX_TIMESTAMP(tm) >= ' + tm1 + ' and UNIX_TIMESTAMP(tm) <=' + tm2;
                    par = {
                        'sql': 'select ' + tablecfg[v][2] + ' from ' + tablecfg[v][0] + ' where _plat=' + S._plat + where,
                        uid: MY.id,
                        sid: S.id,
                        t: tablecfg[v][0]
                    }
                }
            }
            if (tablecfg[v][3]) par['title'] = tablecfg[v][3];
            downurl = 'mfsql'
        } else if (tablecfg[v] && tablecfg[v][0] && tablecfg[v][1] && tablecfg[v][1] == 'log') {
            par = {
                'startTime': tm1,
                'endTime': tm2,
                't': tablecfg[v][0]
            };
            downurl = 'mflog'
        } else {
            return Msg.err('参数出错！')
        }
        Msg.doing();
        $.cmsapi(CGI[downurl] + '?action=records', par, function(ret) {
            Msg.close();
            if (!ret || !ret.ok) {
                Msg.err('暂无数据!');
                return
            }
            TPL.downTips(ret.msg)
        })
    },
    audittips: function() {},
    auditcom: function(d) {
        var par = d.split('|'),
            descr = '',
            disabled = '';
        if (!par || !par[0] || !par[1] || !par[2]) return Msg.err('参数出错！');
        var ids = '',
            add = '';
        if (par[3]) {
            ids = par[3]
        } else {
            ids = getCheckBox('ids') ? getCheckBox('ids') : getCheckBox('"id[]"')
        }
        if (!ids) return Msg.err('请选择操作选项！');
        if (par[2] == 14) {
            var api = $('#mobileGoodsCondition select[name="api"]').val();
            add = '<input type="hidden" name="api" value="' + api + '">'
        } else if (par[2] == 15) {
            var api = $('#mobileGoodsCategory select[name="api"]').val(),
                condition = $('#mobileGoodsCategory select[name="condition"]').val();
            add = '<input type="hidden" name="api" value="' + api + '">';
            add += '<input type="hidden" name="condition" value="' + condition + '">'
        } else if (par[2] == 16) {
            var api = $('#mobileGoods select[name="api"]').val(),
                condition = $('#mobileGoods select[name="condition"]').val(),
                category = $('#mobileGoods select[name="category"]').val();
            add = '<input type="hidden" name="id" value="' + ids + '">';
            add += '<input type="hidden" name="api" value="' + api + '">';
            add += '<input type="hidden" name="condition" value="' + condition + '">';
            add += '<input type="hidden" name="category" value="' + category + '">'
        } else if (par[2] == 17) {
            var api = $('#mobileGoodsRepository select[name="api"]').val();
            add = '<input type="hidden" name="api" value="' + api + '">'
        } else if (par[2] == 18) {
            var type = $('#typeObj select[name="type"]').val();
            add = '<input type="hidden" name="type" value="' + type + '">'
        } else if (par[2] == 19) {
            var api = $('#apiObj select[name="api"]').val();
            add = '<input type="hidden" name="api" value="' + api + '">'
        } else if (par[2] == 20) {
            var api = $('#promotionsGoods select[name="api"]').val();
            add = '<input type="hidden" name="api" value="' + api + '">'
        } else if (par[2] == 22) {
            var aIds = ids.split(','),
                tmp = [],
                aTmp, oTmp;
            disabled = 'disabled="disabled"';
            $.each(aIds, function(i, o) {
                tmp.push(o + ':' + $('.name' + o).html())
            });
            descr = tmp.join().replace(/<i>/g, '').replace(/<\/i>/g, '');
            if (!par[4]) return Msg.err('参数出错！');
            aTmp = par[4].split('_');
            $.each(aTmp, function(i, o) {
                oTmp = o.split(':');
                add += '<input type="hidden" name="' + oTmp[0] + '" value="' + oTmp[1].replace(/[\r|\n|，]/g, ',') + '">'
            })
        }
        Msg.doing();
        SYS.window({
            title: '审核申请说明',
            width: '500',
            height: '200',
            init: function() {
                Msg.close();
                var html = '<table class="myTable left"><tbody><tr class=""><td class="myTableLeft">申请说明：</td><td><textarea class="w6" name="descr" must="请输入申请说明！" ' + (disabled || '') + '>' + (descr || '') + '</textarea></td></tr></tbody></table>' + '<div class="myBtns"><input type="button" value="提交审核" onclick="TPL.auditdo();">' + '<input type="hidden" name="cmd" value="' + par[0] + '">' + '<input type="hidden" name="levelend" value="' + par[1] + '">' + '<input type="hidden" name="typeid" value="' + par[2] + '">' + '<input type="hidden" name="ids" value="' + ids + '">' + add + '</div>';
                RIGHT.html(html)
            }
        })
    },
    auditdo: function(t) {
        var f = new Form(RIGHT);
        if (!f.check()) return;
        Confirm('确定提交审核？', function() {
            var data = {
                cmd: '[' + f.data.cmd + ']',
                levelend: f.data.levelend,
                typeid: f.data.typeid,
                descr: {
                    data: f.data.ids,
                    descr: f.data.descr
                }
            };
            if ($.inArray(int(f.data.typeid), [14, 17, 19, 20]) != -1) {
                data['descr']['api'] = f.data.api;
                if (f.data.typeid == 20) data['descr']['key'] = 'promotions'
            } else if (f.data.typeid == 15) {
                data['descr']['api'] = f.data.api;
                data['descr']['condition'] = f.data.condition
            } else if (f.data.typeid == 16) {
                data['descr']['api'] = f.data.api;
                data['descr']['condition'] = f.data.condition;
                data['descr']['category'] = f.data.category
            } else if (f.data.typeid == 18) {
                data['descr']['type'] = f.data.type
            } else if (f.data.typeid == 22) {
                data['descr']['reciveperson'] = f.data.reciveperson;
                data['descr']['aid'] = f.data.aid
            }
            Msg.doing();
            $.JSON(PATH.app + 'audit/audit.php?cmd=com', {
                data: data
            }, function(ret) {
                Msg.close();
                COMM.suc(ret, function() {
                    WIN[0].close();
                    P.ref()
                })
            })
        })
    },
    sendConfirm: function(con, fun) {
        if (!con) return Msg.err('参数出错!');
        Confirm('你确定要' + con + '吗？', function() {
            Confirm('真的要' + con + '？', function() {
                var name = '';
                while (name == "" || name != L.S[S.id]) {
                    if (name == null) {
                        return Msg.err('您已取消操作')
                    }
                    name = prompt('请输入"' + L.S[S.id] + '"', '')
                }
                if (typeof fun == 'function') fun()
            })
        })
    },
    isLock: function(v) {
        if (v == 1) {
            return "是"
        } else {
            return "否"
        }
    },
    headpic: function(v, rs, par) {
        return SYS.headpic(v, par || 30, 1)
    },
    json2zh: function(v) {
        try {
            v = v.replace(/DKHL/g, '{').replace(/DKHR/g, '}');
            var s = new Function("return" + v)();
            return htmlspecialchars($.toJSON(s), true)
        } catch (e) {
            return v
        }
    }
};
var Chv = new function() {
    var NS = 'Chv',
        I = {
            live: function() {
                $('.chv').live('click', function() {
                    I.init($(this))
                })
            },
            init: function(obj) {
                if (I.lock || SO.lock) return;
                I.lock = 1;
                I.obj = obj;
                I.$old = obj.html();
                if (obj.attr('pre') && I.$old) {
                    I.$old = I.$old.replace(/<pre>/g, '').replace(/<\/pre>/g, '')
                }
                var minw = int(I.obj.attr('w'), 80),
                    minh = int(I.obj.attr('h'), 26),
                    w = Math.max((obj.outerWidth() - obj.width()) / 2 + obj.width(), minw),
                    h = Math.max(obj.height(), minh),
                    pos = obj.offset(),
                    val = I.exec('init', I.$old);
                if (pos.top < 0) pos.top = 0;
                if (h > VAR.wh) h = VAR.wh - pos.top;
                var left = pos.left + 1,
                    sw = screen.width;
                if (sw < left + w) left -= left + w - sw;
                I.filter = int(obj.attr('filter'));
                I.name = 'chv_val';
                if (obj.attr('editor')) {
                    I.type = 'editor';
                    I.html(w, h, left, pos.top, '<div></div>');
                    loadEditor($('#iObj div')[0], I.name, val, {
                        width: w,
                        height: h,
                        toolbar: NS
                    })
                } else if (obj.attr('div')) {
                    I.type = 'div';
                    var style = 'height:' + h + 'px;background:#fff;padding:3px;border:1px solid #ccc';
                    I.html(w, h, left, pos.top, '<div name="' + I.name + '" contenteditable="true" style="' + style + '">' + val + '</div>');
                    $('#iObj div').focus()
                } else {
                    I.type = 'textarea';
                    var auto = obj.attr('auto');
                    auto = auto != '-1' ? ' onblur="' + NS + '.autoClose(' + Math.max(int(auto), 500) + ')" onfocus="' + NS + '.focus()"' : '';
                    if (obj[0].getAttribute('setkey') === 'lan_ar') {
                        I.html(w, h, left, pos.top, '<textarea name="' + I.name + '" ' + auto + ' style="direction: rtl;">' + val + '</textarea>')
                    } else {
                        I.html(w, h, left, pos.top, '<textarea name="' + I.name + '" ' + auto + '>' + val + '</textarea>')
                    }
                    $('#iObj textarea').focus()
                }
            },
            exec: function(k, v, fn) {
                var f = I.obj.attr(k);
                if (!f) return v;
                try {
                    f = eval(f);
                    if (typeof f == 'function') {
                        v = f(v);
                        if (k == 'fun') return true
                    }
                } catch (e) {}
                if (typeof fn == 'function') fn(v);
                return v
            },
            html: function(w, h, left, top, html) {
                var s = '<div id="iObj" style="width:' + (w - 2) + 'px;height:' + (h - 4) + 'px;left:' + left + 'px;top:' + top + 'px">' + html + '<div style="position:absolute;top:-' + Math.min(top, 22) + 'px;right:0px;text-align:right"><input type="button" value="' + L.btn.submit + '" style="padding:2px 5px" onclick="' + NS + '.submit()" /><input type="button" value="X" style="padding:2px 5px" onclick="' + NS + '.close()" /></div></div>';
                JQ.body.append(s)
            },
            close: function(s) {
                if (I._t) clearTimeout(I._t);
                $('#iObj').remove();
                if (!s) I.lock = 0
            },
            focus: function() {
                if (I._t) clearTimeout(I._t)
            },
            autoClose: function(t) {
                I._t = setTimeout(I.close, t)
            },
            out: function(v) {
                I.obj.html(I.obj.attr('pre') ? '<pre>' + v + '</pre>' : v)
            },
            getVal: function() {
                var v = '';
                switch (I.type) {
                    case 'editor':
                        v = getEditor(I.name);
                        break;
                    case 'div':
                        v = $('#iObj div[name="' + I.name + '"]').html();
                        break;
                    default:
                        v = $('#iObj textarea[name="' + I.name + '"]').val()
                }
                return v
            },
            submit: function() {
                var obj = I.obj,
                    p = {},
                    val = I.getVal();
                val = I.exec('callback', val);
                if (I.$old == val || val && val.replace(/<br[^>]*>/g, '<br>') == I.$old) {
                    I.close();
                    return
                }
                I.out(val);
                if (I.exec('fun', val) === true) return;
                I.close(1);
                p.pack = obj.attr('pack');
                if (p.pack) {
                    p.parent = obj.attr('parent');
                    p.sign = obj.attr('sign');
                    p.setKey = obj.attr('setKey');
                    p.val = val;
                    if (!p.parent || !p.sign) {
                        Msg.err(L.errpar);
                        I.lock = 0;
                        return false
                    }
                    $.POST(CGI.diyLang + '?cmd=translate', p, function(ret) {
                        COMM.suc(ret, function() {
                            var v = COMM.version('LL', 1);
                            $.getScripts(['data/L/' + vars.langfix + '.js?' + v, 'data/L/' + S.langfix + '.data.js?' + v])
                        });
                        I.lock = 0
                    });
                    return
                }
                p.table = obj.attr('table');
                p.setKey = obj.attr('setKey');
                p.value = obj.attr('value');
                if (!p.table || !p.setKey || !p.value) {
                    Msg.err(L.errpar);
                    I.lock = 0;
                    return false
                }
                p.key = obj.attr('key') || 'id';
                p.appId = WIN[0].appId;
                p.oldVal = I.$old;
                p.setValue = val;
                var t = obj.attr('time');
                if (t) p.time = t.split('_')[0];
                $.POST(CGI.ajax + '?cmd=updateDb&filter=' + I.filter, p, function(ret) {
                    I.callback(ret);
                    if (t) $o('#' + t).html(ret[p.time])
                })
            },
            callback: function(ret) {
                I.close();
                COMM.suc(ret);
                if (!ret || !ret.ok || typeof ret.val == 'undefined') return;
                I.exec('callback', ret.val, function(v) {
                    I.out(v)
                })
            }
        };
    return I
};
var SO = {
    callback: '',
    live: function() {
        if (VAR.translate == 1) return;
        $('.search').live('click', function(e) {
            var p = getPosition(this),
                x = e.clientX,
                y = e.clientY;
            if (p.left <= x && x <= p.left + $(this).outerWidth() && p.top <= y && y <= p.top + $(this).outerHeight()) {
                SO.init($(this))
            }
        })
    },
    init: function(obj) {
        if (SO.lock) return;
        SO.lock = 1;
        SO.key = obj.attr('key');
        SO.cfg = obj.attr('cfg');
        SO.cfg = SO.cfg ? eval(SO.cfg) : '';
        if (!SO.key) {
            Msg.err('搜索键配置错误');
            SO.lock = 0;
            return
        }
        SO.like = obj.attr('like') || 0;
        if (obj.attr('tip')) Msg.ok(obj.attr('tip'));
        WIN[0].searchPar[SO.key] = WIN[0].searchPar[SO.key + '_true'] || '';
        var w = (obj.outerWidth() - obj.width()) / 2 + obj.width(),
            h = Math.max(obj.height(), 26),
            pos = obj.offset();
        JQ.body.append('<div id="iObj" style="width:' + (w - 2) + 'px;height:' + (h - 4) + 'px;left:' + (pos.left + 1) + 'px;top:' + (pos.top + 1) + 'px"><textarea class="isEnter" onblur="SO.submit(-1)">' + WIN[0].searchPar[SO.key] + '</textarea><br /><input type="button" value="搜" title="执行搜索" onclick="SO.submit(2)" /><input type="button" value="升" title="按升序排列(从小到大)" onclick="SO.submit(0)" /><input type="button" value="降" title="按降序排列(从大到小)" onclick="SO.submit(1)" /></div>');
        SO.obj = obj;
        SO.iObj = $('#iObj');
        $('textarea', SO.iObj).focus().select()
    },
    close: function() {
        SO.iObj.remove();
        SO.lock = 0
    },
    submit: function(t) {
        if (t == -1) {
            setTimeout(SO.close, 200);
            return
        }
        var e = 0,
            order = ['ASC', 'DESC'];
        if (order[t]) {
            WIN[0].searchPar['s_order'] = order[t];
            WIN[0].searchPar['s_key'] = SO.key;
            e = 1
        }
        var val = $.trim($('textarea', SO.iObj).val()),
            _true = val;
        if (SO.cfg) {
            $.each(SO.cfg, function(i, o) {
                if (val === o) {
                    val = i.toString();
                    return false
                }
            });
            $.each(SO.cfg, function(i, o) {
                if (o && o.indexOf(val) >= 0) {
                    val = i.toString();
                    return false
                }
            })
        }
        if (!e && WIN[0].searchPar[SO.key] == val) {
            SO.lock = 0;
            return
        }
        WIN[0].searchPar[SO.key + '_true'] = _true;
        if (val) {
            var s, s1 = val.charAt(0),
                s2 = s1 + val.charAt(1);
            if ($.inArray(s2, ['>=', '<=', '<>', '!=']) != -1) {
                s = s2;
                val = val.substring(2)
            } else if ($.inArray(s1, ['>', '<']) != -1) {
                s = s1;
                val = val.substring(1)
            }
            if (s) {
                WIN[0].searchPar[SO.key + '_sign'] = s
            } else {
                delete WIN[0].searchPar[SO.key + '_sign']
            }
        }
        if (val && val.indexOf('@') > 0) {
            var arr = val.split('@');
            if ($.inArray(arr[1], ['>', '>=', '<', '<=', '<>', '!=']) != -1) {
                val = arr[0]
            }
        }
        WIN[0].searchPar[SO.key] = val;
        if (typeof WIN[0].searchFun == 'function') WIN[0].searchFun();
        if (val) {
            SO.obj.addClass('searchOn')
        } else {
            SO.obj.removeClass('searchOn')
        }
        SO.close()
    }
};
var Attr = {
    init: function(attr) {
        if (!attr || !attr.data) return echo('参数错误！');
        var sign = attr.sign || WIN[0].sign,
            key = attr.key,
            s = '<div class="leftAttr">' + attr.title + '</div>',
            on;
        var val = Attr.get(sign, key);
        if (attr.callback) Attr['callback_' + sign + '_' + key] = attr.callback;
        $.each(attr.data, function(v, tit) {
            v = v.toString().replace('c', '');
            on = val == v ? 'attr' : '';
            s += '<div id="' + sign + '_' + key + '_' + v + '" class="leftAttr leftAttrs ' + on + '"><a onclick="Attr.click(this,\'' + sign + '\',\'' + key + '\',\'' + v + '\')">' + tit + '</a></div>'
        });
        WIN[0].left.append(s)
    },
    get: function(sign, key) {
        if (!Attr['data_' + sign]) Attr['data_' + sign] = {};
        return Attr['data_' + sign][key] || ''
    },
    set: function(sign, key, v) {
        Attr.get(sign, key);
        Attr['data_' + sign][key] = v;
        try {
            return eval(sign + '.$' + key + '=v')
        } catch (e) {
            return false
        }
    },
    click: function(my, sign, key, val) {
        var old = Attr.get(sign, key);
        $('#' + sign + '_' + key + '_' + old).removeClass('attr');
        Attr.set(sign, key, val);
        $(my).parent().addClass('attr');
        var f = Attr['callback_' + sign + '_' + key];
        if (f && typeof f == 'function') f()
    },
    param: function(sign) {
        sign = sign || WIN[0].sign;
        var d = Attr['data_' + sign];
        if (d) return $.param(d);
        return ''
    }
};
var Color = {
    opt: ['', '#000000', '#993300', '#333300', '#003300', '#003366', '-', '#000080', '#333399', '#333333', '#800000', '#FF6600', '#808000', '-', '#008000', '#008080', '#0000FF', '#666699', '#666666', '#FF0000', '-', '#FF9900', '#99CC00', '#339966', '#33CCCC', '#3366FF', '#800080', '-', '#999999', '#FF00FF', '#FFCC00', '#FFFF00', '#00FF00', '#00FFFF', '-', '#00CCFF', '#993366', '#CCCCCC', '#FF99CC', '#FFCC99', '#FFFF99', '-', '#CCFFCC', '#CCFFFF', '#99CCFF', '#CC99FF', '#EFEFEF', '#FFFFFF', '-'],
    init: function(self, sel) {
        var opt = clone(Color.opt);
        if (Color.diy && typeof Color.diy == 'object') {
            $.each(Color.diy, function(i, o) {
                opt.push(o)
            })
        }
        Color.end();
        Color.obj = sel ? $o(sel) : $(self);
        var obj = Color.obj,
            s = '<span id="colorSelectObj"><h1><b style="background-color:' + Color.def(obj.val()) + '"></b>' + Color.def(obj.val(), 1) + '</h1><p>';
        $.each(opt, function(i, o) {
            s += o == '-' ? '<br />' : '<a color="' + o + '" class="colorSelectOne" onclick="Color.check(\'' + o + '\')" style="background-color:' + Color.def(o) + ';"></a>'
        });
        s += '</p><div class="clear"></div></span>';
        $(document.body).append(s);
        var o = $('#colorSelectObj'),
            pos = $(self).offset();
        pos.top += $(self).outerHeight();
        o.css(pos).mouseleave(Color.end);
        $('.colorSelectOne', o).mouseenter(function() {
            c = $(this).attr('color');
            $('h1', o).html('<b></b>' + Color.def(c, 1));
            $('h1 b', o).css('background-color', Color.def(c))
        })
    },
    check: function(c) {
        Color.obj.css('background-color', c).val(c);
        Color.end()
    },
    end: function() {
        $('#colorSelectObj').remove()
    },
    def: function(c, t) {
        t = t ? '默认' : '#ffffff';
        return c ? c : t
    }
};
$.fn.closeRight = function() {
    $(this).each(function(i, o) {
        o.oncontextmenu = function() {
            return false
        };
        o.ondragstart = function() {
            return false
        };
        o.onselectstart = function() {
            return false
        }
    });
    return $(this)
};
$.fn.openRight = function() {
    $(this).each(function(i, o) {
        o.oncontextmenu = function() {
            return true
        };
        o.ondragstart = function() {
            return true
        };
        o.onselectstart = function() {
            return true
        }
    });
    return $(this)
};
$.ajaxSetup({
    error: function(a, b, e) {
        a = obj(a);
        var c = '#' + b + '：' + a.status + ' ' + a.statusText + ' ' + e;
        Msg.close();
        Msg.err(c, {
            time: 99999
        });
        if (console && typeof console.log == 'function') console.log(a, b, e)
    }
});
$.fn.loadUrlData = function(url, set) {
    var I = $(this);
    I.loads(url, function() {
        I.loadData(set)
    })
};
$.fn.loadData = function(set) {
    var opt = {
        on: 0,
        jsonp: 0,
        loadJs: '',
        script: 1,
        url: '',
        par: '',
        data: null,
        zipkey: 0,
        success: null,
        callback: null,
        funBase: '',
        loading: 1,
        config: '',
        page: 1,
        size: 0,
        tpl: '',
        mf: '',
        lcdata: '',
        funPage: ''
    };
    if (set) $.extend(opt, set);
    var I = $(this),
        tpl, W = WIN[0] || {},
        p, page = 1,
        size = 10;

    function _init() {
        if (opt.loadJs) {
            if (typeof opt.loadJs != 'object') opt.loadJs = [opt.loadJs];
            $.getScripts(opt.loadJs, function() {
                _load()
            })
        } else {
            _load()
        }
    }
    function _load() {
        if (opt.mf) {
            opt.url = opt.on && C.dev ? 'http://mf.oa.com/Servlet?action=records' : CGI.mf + '?action=records';
            opt.lcdata = opt.mf;
            delete opt.mf
        } else if (opt.cmsmf) {
            opt.url = opt.on || !C.dev ? CGI.cmsmf : 'http://vm.boyaa.com/cms_mf/';
            opt.lcdata = opt.cmsmf;
            delete opt.cmsmf
        } else {
            if (opt.on && C.dev) opt.url = opt.url.replace(S.cmsapi, S.cmsapion)
        }
        if (opt.funPage) {
            p = COMM.page({
                size: opt.size,
                page: opt.page,
                callback: opt.funPage
            });
            page = p.$page;
            size = p.$size
        }
        _tpl();
        if (opt.loading) Msg.loading();
        if (opt.url) {
            var par = {
                'page': page,
                'pagesize': size
            };
            if (opt.par) {
                var _par = typeof opt.par == 'function' ? opt.par() : opt.par;
                if (_par) $.extend(par, _par)
            }
            if (opt.zipkey || opt.lcdata) par.by_zip = 1;
            if (opt.lcdata) par.lcdata = opt.lcdata;
            _search(par);
            if (opt.before) tpl.before();
            (opt.jsonp || opt.lcdata ? $.JSONP : $.JSON)(opt.url, par, function(ret) {
                if (ret.loopKey && ret.loop) {
                    $.each(ret.loop, function(i, o) {
                        var temp = {};
                        $.each(ret.loopKey, function(n, k) {
                            temp[k] = o[n]
                        });
                        ret.loop[i] = temp
                    });
                    delete ret.loopKey
                }
                _exec(ret)
            })
        } else {
            _exec(opt.data ? opt.data : set)
        }
    }
    function _tpl() {
        W.tplk = 'tplk_' + W.action + '_' + W.signs + '_' + I.selector.replace(/\s/g, '');
        if (!W[W.tplk]) W[W.tplk] = new Tpl();
        tpl = W[W.tplk];
        tpl.obj = I;
        tpl.script = opt.script;
        tpl.data = {};
        if (opt.tpl === true) {
            tpl.tpl = I.html()
        } else {
            if (opt.tpl) {
                tpl.tpl = opt.tpl
            } else if (!tpl.tpl) {
                tpl.tpl = I.html()
            }
        }
        tpl.tpl = tpl.tpl.toString();
        tpl.test = opt.test
    };

    function _search(par) {
        if (W.searchPar) {
            var searchPar = {};
            $.each(W.searchPar, function(i, o) {
                if (i.indexOf(',') > 0) {
                    i = i.split(',');
                    $.each(i, function(ii, n) {
                        searchPar[n] = o
                    })
                } else {
                    searchPar[i] = o
                }
            });
            $.extend(par, searchPar)
        }
        W.searchFun = opt.funPage
    }
    function _exec(data) {
        data = data || {};
        if (opt.lcdata && data && !data.ok && data.msg) Err(data.msg);
        if (opt.success && typeof opt.success == 'function') {
            data.num = _num(data);
            data = opt.success(data, tpl, _exec2);
            if (data === false) {
                if (opt.loading) Msg.close();
                return
            }
            if (!data) echo('[_exec]无返回值')
        }
        _exec2(data)
    }
    function _exec2(data) {
        data.num = _num(data);
        VAR.tempData = data;
        tpl.funBase = opt.funBase;
        tpl.config = opt.config;
        tpl.data = data;
        tpl.data.nodata = data.num === 0;
        if (tpl.data.nodata) {
            if (tpl.tpl.indexOf('{C.noData}') > 0) {
                tpl.tpl = tpl.tpl.replace('{C.noData}', C.noData)
            } else if (tpl.tpl.indexOf('{nodata}') < 0) {
                tpl.tpl += '{nodata}' + C.noData + '{/nodata}'
            }
        }
        tpl.display();
        if (typeof W.searchStatus == 'function') W.searchStatus();
        if (W.sign !== 'lock') $('#appLockImg').remove();
        if (data.appLock) {
            var s = '本应用当前处于锁定状态，所有改动仅生效于no3！&#13;' + data.appLock.locktime + ' by ' + VAR.adminuser[data.appLock.uid];
            $('#normalRight').prepend('<img id="appLockImg" src="' + SKIN.img + 'appLock.png" class="app" fun="lock" style="position:absolute;z-index:9998;top:72px;left:' + VAR.ww / 2 + 'px" title="' + s + '" />')
        }
        if (p) {
            p.set('all', data.num);
            $o('.myPage').page(opt.lcdata, p.id, opt.size)
        }
        Msg.close();
        $o('td>input[name=ids]').parent().click(function(e) {
            if ($(e.target).attr('type') === 'checkbox') return;
            var o = $(this).find('input');
            o.attr('checked', !o.attr('checked'))
        });
        if (typeof opt.callback == 'function') opt.callback(data);
        if (data) editLock.init(data);
        COMM.adminIo();
        tableHide.init();
        $o('.calendar2').each(function(i, o) {
            if (o.value == ' ~ ') o.value = ''
        });
        if (VAR.isMobile) {
            var k = 'target=blank';
            $o('[target="_blank"]').each(function(i, o) {
                var u = $(o).attr('href');
                if (u.indexOf(k) < 0) {
                    u += (u.indexOf('?') > 0 ? '&' : '?') + k;
                    $(o).attr('href', u)
                }
            })
        }
    }
    function _num(data) {
        var n = 0;
        if (opt.lcdata) {
            if (data.maxPage) {
                n = size * data.maxPage
            } else {
                n = data.loop && typeof data.loop === 'object' && data.loop.length ? (Math.max(page, 5) + 5) * size : 0
            }
        } else {
            if (data.num == 'undefined') {
                n = 1
            } else {
                n = data.num
            }
        }
        return n
    }
    _init()
};
var tableHide = new function() {
    var I = this,
        NS = 'tableHide',
        _key, _display = function(n, ed) {
            $o(_key || 'tr').each(function() {
                var o = $(this).find('td:eq(' + n + ')');
                if (ed) {
                    o.show()
                } else {
                    o.hide()
                }
            })
        };
    I.init = function() {
        var li = $o('.' + NS);
        if (!li[0]) return;
        I.radio = {};
        _key = '';
        li.each(function(i, o) {
            if (!_key && $(o).attr(NS)) _key = '.' + $(o).attr(NS);
            var n = $(o).index();
            _display(n, 0);
            I.radio[n] = $(o).text()
        });
        var cknm = WIN[0].sign + '_' + NS,
            defval = cookie(cknm),
            i = TPL.script(function() {
                if (defval) {
                    $.each(defval.split(','), function(i, n) {
                        _display(n, 1)
                    })
                }
                $o('input[name="' + NS + '"]').click(function() {
                    _display(this.value, this.checked);
                    var v = getCheckBox(NS);
                    cookie(cknm, v, {
                        time: 86400
                    })
                })
            });
        if ($o('.' + NS + 'Sel')[0]) $o('.' + NS + 'Sel').remove();
        var o = $o('#' + NS + 'Obj');
        if (!o[0]) o = li.siblings().not('.' + NS).last();
        var par = {
                type: 'checkbox',
                css: '#$id{border:0px}',
                showval: '更多',
                pos: 'right'
            },
            s = '<span class="' + NS + 'Sel" style="float:right">' + TPL.selects(defval, '', NS + '.radio', NS, par) + i + '</span>';
        o.append(s)
    }
};
$.fn.shanDong = function(n, color) {
    n = n || 5;
    var o = $(this),
        i = 0,
        t = setInterval(function() {
            o.fadeOut(200).fadeIn(200);
            if (i == 0 && color) o.css('color', color);
            if (++i > n) {
                clearInterval(t);
                if (color) setTimeout(function() {
                    o.css('color', '')
                }, 400)
            }
        }, 400)
};
$.fn.hchar = function(p) {
    var my = this;
    $.getScript(PATH.hchar + 'highcharts.js', function() {
        $.getScript(PATH.hchar + 'modules/exporting.js', function() {
            $.each(p, function(i, o) {
                $o(i, my).highcharts(o);
                $o(i, my).find('tspan').last().hide()
            })
        })
    })
};
$.fn.page = function(lc, id, size) {
    var lan = L.page;
    var tpl = new Tpl($(this));
    id = id || 0;
    tpl.data.p = P.getObj(lc, id);
    var total = size > 0 ? l(lan.size, ['<b>' + size + '</b>']) : lan.tit + '{p.change}';
    tpl.tpl = total + '&nbsp;&nbsp;' + (lc ? '' : l(lan.info, ['{p.all}', '{p.count}'])) + '<a href="javascript:{p.first}">' + lan.first + '</a><a href="javascript:{p.back}">' + lan.back + '</a><!--{p.body}<a href="javascript:{url}"{css}>{page}</a>{/p.body}--><a href="javascript:{p.next}">' + lan.next + '</a>' + (lc ? '' : '<a href="javascript:{p.last}">' + lan.last) + '</a>' + lan.go + '<input value="{p.on}" onkeyup="COMM.autoInt(this)" style="width:30px;text-align:center" /><input type="button" value="GO" onclick="P.pageto(this,' + id + ')" style="padding:1px" />';
    tpl.display();
    $('a[href="javascript:"]', $(this)).addClass('nopage')
};
$.fn.loadImg = function(f) {
    var I = $(this);
    var w = int(I.attr('width') || I.width());
    var h = int(I.attr('height') || I.height());
    w = w < 32 ? 0 : w;
    h = h < 32 ? 0 : h;
    var s = I.attr("lazysrc");
    if (!s) return;
    f = f ? f : function(hh) {
        if (hh < h) I.css("margin-top", (h - hh) / 2)
    };
    I.setImg(w, h, s, f)
};
$.fn.date = function(str, delay) {
    delay = delay ? delay : 1000;
    var I = $(this);
    I.html($D.date(str));
    var loop = setInterval(function() {
        I.html($D.date(str))
    }, delay);
    this.clear = function() {
        clearInterval(loop)
    };
    return this
};
$.getScripts = function(a, f) {
    var js = [],
        temp = [];
    $.each(a, function(k, v) {
        if (!v) return;
        if (v.indexOf('.js') > 0 && v.indexOf('.php') == -1) {
            js.push(v.replace(PATH.data, '').split('?')[0])
        } else {
            temp.push(v)
        }
    });
    if (js.length > 1) {
        temp.push(PATH.api + '?cmd=getScripts&js=' + js.join(','))
    } else {
        temp = a
    }
    var n = temp.length;
    $.each(temp, function(i, o) {
        $.getScript(o, function() {
            if (--n == 0 && typeof f == 'function') f()
        })
    })
};
$.gets = function(url, fn) {
    $.ajax({
        type: "GET",
        url: PATH.app + url + (url.indexOf('?') > 0 ? '&' : '?') + vars.versions,
        success: function(s) {
            if (typeof fn != 'function') return;
            s = replaceVars(s);
            fn(s)
        }
    })
};
$.fn.loads = function(url, fn, self) {
    var tpl_php = vars.tpl_php || url.indexOf('.tpl.php') > 0,
        sign = WIN[0].sign || '',
        ver = function(s) {
            if (tpl_php) return PATH.tpl + '?s=' + sign + '&u=' + encodeURIComponent(s) + '&by_sid=' + S.id;
            return s + (s.indexOf('?') > 0 ? '&' : '?') + vars.versions
        };
    if (url && url.indexOf('/') === 0) {
        url = ver(url)
    } else {
        var s = url ? url.split('/')[0] : '';
        if (!self && s && APP[s] && APP[s].comm) {
            url = PATH.app + '?s=' + sign + '&t=h&f=' + url + '&by_sid=' + S.id
        } else {
            url = ver(url);
            if (!tpl_php) url = PATH.app + url
        }
    }
    var I = this;
    $.ajax({
        type: 'GET',
        url: url,
        success: function(s) {
            s = replaceVars(s);
            I.html(s);
            if (typeof fn == 'function') fn(s)
        }
    })
};
$.POST = function(l, d, f, t) {
    l = $.cmsAjax(l);
    if (!t) t = 'json';
    $.post(l, d, f, t)
};
$.JSON = function(l, d, f) {
    if (typeof(d) == 'function') {
        f = d;
        d = null
    }
    d = obj(d);
    l = $.cmsAjax(l);
    $.ajax({
        type: 'GET',
        url: l,
        data: d,
        dataType: 'json',
        success: function(ret) {
            COMM.jsonCb(ret, f)
        }
    })
};
$.cmsapi = function(l, d, f, t) {
    if (!l) {
        Msg.err('$.cmsapi地址错误');
        return
    }
    if (typeof t == 'undefined') t = 'json';
    var fn = function(ret) {
        $.sendToExec(ret);
        if (typeof f == 'function') f(ret)
    };
    l = PATH.api + 'post.php?_cmsapi_url=' + encode(l.replace(S.cmsapi, ''));
    $.POST(l, d, fn, t)
};
$.JSONP = function(l, d, f) {
    if (typeof(d) == 'function') {
        f = d;
        d = null
    }
    d = d ? clone(d) : {};
    if (d.lcdata) {
        var p = {
            _u: encodeURIComponent(l),
            _d: d
        };
        $.ajax({
            type: 'GET',
            url: $.cmsAjax(PATH.api + 'jsonp.php', p),
            dataType: 'json',
            success: function(ret) {
                COMM.jsonCb(ret, f);
                $.sendToExec(ret)
            }
        })
    } else {
        var p = VAR.cmsKey;
        if (!p || !p.by_time || !p.by_key) {
            alert(L.errpar);
            return
        }
        var ajax = function() {
            d = $.cmsapiAjax(d, p, l);
            $.ajax({
                type: 'GET',
                url: l,
                data: d,
                dataType: 'jsonp',
                success: function(ret) {
                    COMM.jsonCb(ret, f);
                    $.sendToExec(ret)
                }
            })
        };
        if ($D.time() - p.by_time > 170) {
            $.JSON(CGI.login + '?cmd=sign', function(ret) {
                p = VAR.cmsKey = ret;
                ajax()
            })
        } else {
            ajax()
        }
    }
};
$.cmsapiAjax = function(d, p, url) {
    d = obj(d);
    p = p ? clone(p) : VAR.cmsKey;
    if (!d.lcdata) {
        p.by_uid = MY.id;
        p.PHPSESSID = S.PHPSESSID
    }
    $.extend(d, p);
    if (d.lcdata) {
        delete d.lcdata
    } else {
        VAR.cmsKey = p
    }
    if (!url || url.indexOf('by_cfgon') == -1) d.by_cfgon = VAR.by_cfgon || 0;
    d = $.cmsAjax('', d);
    return d
};
$.cmsAjax = function(url, par) {
    var d = {
        'by_sid': getPar('sid') || S.id || '',
        'by_api': vars.api,
        'by_appid': int(WIN[0].appId),
        'by_server': vars.server
    };
    editLock.setPar(d);
    var diyuid = getPar('diyuid');
    if (diyuid) d.diyuid = diyuid;
    if (par && typeof par == 'object') $.extend(d, par);
    if (url && typeof url == 'string') {
        url += (url.indexOf('?') > 0 ? '&' : '?') + $.param(d);
        return url
    }
    return d
};
$.sendToExec = function(ret) {
    if (ret && ret.sendTo && ret.sendTo.file) {
        Msg.close();
        Msg.doing('文件【' + ret.sendTo.file + '】发布中...');
        $.JSON(CGI.ajax + '?cmd=sendTo', {
            sendTo: ret.sendTo
        }, function(r) {
            Msg.close();
            COMM.suc(r)
        })
    }
};
var F = {
    init: function(key, opt, notip) {
        if (typeof key == 'object') {
            $.each(key, function(k, v) {
                F.init(k, v, opt)
            })
        } else {
            var k = '_' + key;
            if (typeof F[k] == 'undefined' || notip === 'reset') {
                F[k] = opt
            } else {
                if (!notip) Msg.err('配置F._' + key + '已经存在！')
            }
        }
    },
    cfg: function(key) {
        var k = '_' + key;
        if (F[k] && typeof F[k] == 'object') return F[k];
        if (typeof F[key] == 'object') return F[key];
        return false
    },
    diyapp: {
        'cms': true,
        'path': 'files/',
        'delPath': 'files/',
        'model': 'one',
        'vh': 50,
        'v': 50
    },
    img: {
        'path': '{langfix}/',
        'model': 'one',
        'vh': 50,
        'v': 30
    },
    banner: {
        'path': '{langfix}/',
        'model': 'one',
        'size': 60,
        'vh': 50,
        'v': 30
    },
    news: {
        'path': 'news/',
        'model': 'one',
        'type': '*.gif;*.jpg;*.png;*.swf',
        'size': 2048,
        'vh': 50,
        'v': 30
    },
    notice: {
        'path': 'notice/{langfix}/',
        'model': 'one',
        'type': '*.gif;*.jpg;*.png',
        'size': 2048,
        'vh': 50,
        'v': 30
    },
    swf: {
        'path': '../swf/',
        'model': 'more',
        'type': '*.swf',
        'checkType': 'swf',
        'nameformat': '',
        'samename': 2,
        'vw': 100,
        'vh': 100,
        'v': 30
    },
    webbg: {
        'path': 'background/',
        'delPath': 'background/',
        'model': 'one',
        'vw': 100,
        'vh': 100,
        'v': 30
    },
    act: {
        '_input': 'input',
        'path': 'act/{aid}/',
        'delPath': 'act/{aid}/',
        'model': 'one',
        'type': '*.gif;*.jpg;*.png;*.swf',
        'checkType': 'gif,jpg,png,swf',
        'nameformat': '',
        'samename': 2,
        'vw': 50,
        'vh': 50,
        'v': 30
    },
    mailtpl: {
        'path': '{langfix}/',
        'pathformat': 'mailtpl/',
        'model': 'one',
        'vh': 50,
        'v': 30
    },
    bag: {
        '_input': 'input',
        '_upload': 'hide',
        'path': 'bag/',
        'delPath': 'bag/',
        'model': 'one',
        'type': '*.gif;*.jpg;*.png;*.swf',
        'checkType': 'gif,jpg,png,swf',
        'nameformat': '',
        'samename': 2,
        'vh': 50,
        'v': 30
    },
    admin: {
        'cms': true,
        'path': 'admin/',
        'model': 'one',
        'vh': 32,
        'v': 32
    },
    editorUpload: {
        'cms': true,
        'path': 'editorUpload/{date|Ym}/',
        'model': 'one',
        'size': 1024 * 3,
        'vh': 32,
        'v': 32,
        '_view': 'hide',
        '_input': 'hide',
        'editor': true
    },
    as2js: {
        'cms': true,
        'path': 'as2js/',
        'delPath': 'as2js/',
        'model': 'one',
        'nameformat': 'md5',
        'size': 10240,
        'v': 100
    },
    special: {
        'cms': true,
        'path': 'special/',
        'model': 'one',
        'v': 30
    },
    activite: {
        'path': 'activite/',
        'delPath': 'activite/',
        'pathformat': '{langfix}/',
        'model': 'one',
        'vw': 50,
        'vh': 50,
        'v': 40
    },
    gift: {
        'path': 'gifts/',
        'delPath': 'gifts/',
        'model': 'one',
        'nameformat': '',
        'samename': 2,
        'vw': 50,
        'vh': 50,
        'v': 40
    },
    giftexcel: {
        'cms': true,
        'path': 'excel/import/',
        'delPath': 'excel/import/',
        'type': '*.xls',
        'checkType': 'xls',
        'model': 'one',
        'nameformat': '',
        'vw': 50,
        'vh': 32,
        'v': 32
    },
    giftpic: {
        'path': 'gifts/{langfix}/',
        'model': 'one',
        'nameformat': '',
        'samename': 2,
        'vw': 50,
        'vh': 50,
        'v': 40
    },
    promotion: {
        'path': 'promotion/',
        'delPath': 'promotion/',
        'pathformat': '{langfix}/',
        'model': 'one',
        'vw': 50,
        'vh': 50,
        'v': 40
    },
    feed: {
        '_input': 'input',
        'path': 'feed/',
        'pathformat': '{langfix}/',
        'model': 'one',
        'vh': 50
    },
    msg: {
        '_input': 'input',
        'path': 'message/',
        'model': 'one',
        'inputsize': 15,
        'vh': 50
    },
    collects: {
        'path': 'collects/',
        'delPath': 'collects/',
        'nameformat': '',
        'pathformat': '{langfix}/',
        'model': 'one',
        'vh': 50
    },
    prop: {
        '_input': 'input',
        'path': 'tools/{langfix}/',
        'delPath': 'tools/{langfix}/',
        'model': 'one',
        'vh': 50,
        'v': 35
    },
    proppic: {
        'path': 'prop/{langfix}/',
        'model': 'one',
        'nameformat': '',
        'samename': 2,
        'vw': 50,
        'vh': 50,
        'v': 40
    },
    interactivezip: {
        '_input': 'input',
        'path': 'interactive/zip/',
        'delPath': 'interactive/zip/',
        'model': 'one',
        'type': '*.zip',
        'checkType': 'zip',
        'vh': 50,
        'v': 35
    },
    interactivepic: {
        '_input': 'input',
        'path': 'interactive/icon/',
        'delPath': 'interactive/icon/',
        'model': 'one',
        'vh': 50,
        'v': 35
    },
    sports: {
        'path': 'sports/',
        'delPath': 'sports/',
        'nameformat': '',
        'pathformat': '{langfix}/',
        'model': 'one',
        'vw': 50,
        'vh': 50,
        'v': 40
    },
    bagimport: {
        'cms': true,
        'path': 'bag/',
        'type': '*.xls',
        'checkType': 'xls',
        'model': 'one',
        'nameformat': 'md5',
        'vh': 32,
        'v': 32
    },
    daytask: {
        'path': 'daytask/',
        'pathformat': '{langfix}/',
        'model': 'one',
        'vw': 50,
        'vh': 50,
        'v': 40
    },
    swfSource: {
        '_input': 'input',
        'path': 'loadCfg/{langfix}/',
        'delPath': 'loadCfg/{langfix}/',
        'type': '*.swf',
        'nameformat': '',
        'model': 'one',
        'samename': 2,
        'vh': 50,
        'v': 35
    },
    iSend: {
        'cms': true,
        'sendTo': 'demo,no4,on',
        'path': 'cfg/mailtask/',
        'type': '*.txt',
        'checkType': 'txt',
        'model': 'one',
        'nameformat': '',
        'vw': 50,
        'vh': 32,
        'v': 32
    },
    paypop: {
        'path': 'pay/{langfix}/',
        'delPath': 'pay/{langfix}/',
        'type': '*.swf;*.png;*.jpeg;*.jpg;*.gif;',
        'nameformat': '',
        'model': 'one',
        'size': 60,
        'vh': 50,
        'v': 30
    },
    levels: {
        'cms': true,
        'path': 'excel/import/',
        'delPath': 'excel/import/',
        'type': '*.xls',
        'checkType': 'xls',
        'model': 'one',
        'nameformat': '',
        'vw': 50,
        'vh': 32,
        'v': 32
    },
    phone_splashs: {
        'path': 'phone_splashs/',
        'model': 'one',
        'size': 1000,
        'vh': 50,
        'v': 30
    },
    phoneAct: {
        'path': 'phoneAct/',
        'model': 'more',
        'nameformat': '',
        'samename': 2,
        'size': 1000,
        'vh': 50,
        'v': 30
    },
    andstr: ',',
    setPar: function(o) {
        if (typeof o != 'object') return {};
        if (!o.$dbid) o.$dbid = MY.id + '_upload_temp';
        if (o.path) {
            o.path = o.path.replace('{langfix}', S.langfix).replace('{sid}', S.id).replace('{_attach}', o.$dbid);
            if (o.path.indexOf('{date|') > 0) {
                var r = o.path.match(/\{date\|(.*)?\}/);
                if (r && r[0] && r[1]) o.path = o.path.replace(r[0], $D.date(r[1]))
            }
        }
        if (o.delPath) o.delPath = o.delPath.replace('{langfix}', S.langfix).replace('{sid}', S.id).replace('{_attach}', o.$dbid);
        if (o.pathformat) o.pathformat = o.pathformat.replace('{langfix}', S.langfix).replace('{sid}', S.id).replace('{_attach}', o.$dbid);
        return o
    },
    $: function(s, my) {
        var base = RIGHT;
        if (my && typeof my == 'object') base = $(my).parent();
        return $(s, base)
    },
    upload: function(set, name, my) {
        var opt = {};
        if (typeof set == 'object') {
            opt = set;
            set = opt._index
        } else {
            set = set ? set : 'img';
            opt = F.cfg(set);
            if (!set) {
                Err(L.errpar);
                return
            }
        }
        opt = clone(opt);
        if (!opt.cms && (vars.sysname === 'cms' || vars.sysname === 'ddzcms' || vars.sysname === 'kf' || vars.sysname === 'kop')) {
            opt.url = CGI.upload;
            opt.path = 'images/' + opt.path;
            if (vars.sysname === 'kf') {
                opt.sendFrom = 'kf-cdn'
            } else {
                opt.sendFrom = 'cms'
            }
            opt.sendTo = 'cdn'
        } else {
            opt.url = opt.cms ? CGI.upload : S.cdnCgi + 'upload.php';
            opt.url = $.cmsAjax(opt.url)
        }
        F.viewObj = name ? F.$('[id="' + name + 'View"]', my) : null;
        upload.obj = name ? F.$('[name="' + name + '"]', my) : null;
        upload.par = opt;
        upload.par.name = name;
        upload.par.callback = opt.callback || upload.callback;
        upload.par.PHPSESSID = S.PHPSESSID;
        if (opt.path) upload.par.path = opt.path;
        if (typeof F['fun_' + set] == 'function') F['fun_' + set](upload.par);
        F.setPar(upload.par);
        SYS.appStr('upload')
    },
    get: function(set, name, my) {
        var opt = {};
        if (typeof set == 'object') {
            opt = set;
            set = opt._index
        } else {
            set = set ? set : 'img';
            opt = F.cfg(set);
            if (!opt) return Msg.err(L.errpar + ' ' + set)
        }
        opt.baseUrl = F.imagesUrl(opt.cms);
        opt.url = opt.cms ? CGI.webftp : S.cdnCgi + 'webftp.php';
        webftp.obj = F.$('[name="' + name + '"]', my);
        webftp.par = clone(opt);
        webftp.par.name = name;
        webftp.par.listType = MY.webftp_type || 'img';
        webftp.par.left = MY.webftp_left;
        webftp.par.pageSize = MY.webftp_pagesize;
        webftp.par.defpath = opt.path;
        if (webftp.obj.val() && webftp.obj.val().indexOf('http') == -1) webftp.par.path = webftp.obj.val();
        webftp.par.defVal = webftp.par.path;
        if (webftp.par.path && webftp.par.path.indexOf(F.andstr)) webftp.par.path = webftp.par.path.split(F.andstr)[0];
        if (webftp.par.path && webftp.par.delPath) webftp.par.path = webftp.par.delPath + webftp.par.path.replace(webftp.par.delPath, '');
        webftp.par.callback = opt.callback || webftp.callback;
        F.setPar(webftp.par);
        SYS.appStr('webftp')
    },
    setView: function(name, c, base) {
        c = c ? c : {};
        var obj = $('[name="' + name + '"]', base || RIGHT),
            v = obj.val();
        if (c.editor) {
            var k = 'editor_' + c.name.replace('_upload', '');
            UEDITOR_CONFIG[k].execCommand('insertHtml', F.getView(v, name, c, true))
        } else {
            var view = $('[id="' + name + 'View"]', base);
            if (!view[0]) return;
            view.html(F.getView(v, name, c))
        }
    },
    imagesUrl: function(cms) {
        return cms ? PATH.upload : (C.dev ? 'http://vm.boyaa.com/cms/api/devcdn.php?' : C.cdn + 'images/')
    },
    getView: function(v, name, opt, editor) {
        v = typeof v === 'string' && v ? v.split(F.andstr) : v;
        if (!opt || !v) return '';
        var c = F.setPar(clone(opt)),
            delCgi = typeof c.delCgi == 'function' ? c.delCgi(c) : '',
            add = c.delPath || '',
            path = F.imagesUrl(c.cms),
            vw = c.vw || 500,
            vh = c.vh || 80,
            r = [];
        $.each(v, function(i, o) {
            var src = o.indexOf('http') == 0 ? o : path + add + o,
                fix = F.fix(o),
                del = opt.$dbuid && opt.$dbuid != MY.id || c._del === 'hide' || editor ? '' : '<a title="' + L.btn.del + '" onclick="F.del(\'' + o + '\',\'' + name + '\',this,\'' + delCgi + '\')"></a>';
            if (fix && $.inArray(fix, ['mp4']) >= 0) {
                r.push('<b>' + COMM.flash(src, vw, vh) + del + '</b>')
            } else if (fix == 'swf') {
                if (editor) {
                    r.push(COMM.swf(src, vw, vh))
                } else {
                    r.push('<b>' + COMM.swf(src, vw, vh) + del + '</b>')
                }
            } else {
                if (fix && $.inArray(fix, ['gif', 'png', 'jpg', 'jpeg']) >= 0) {
                    if (editor) {
                        r.push('<img src="' + src + '" />')
                    } else {
                        if (c.samename == 2) src += (src.indexOf('?') >= 0 ? '&' : '?') + $D.time();
                        r.push('<b><img src="' + SKIN.img + 'load.gif" onload="F.imgloaded(this,\'' + src + '\',' + vw + ',' + vh + ')" onclick="window.open(\'' + src + '\')" title="' + o + '" />' + del + '</b>')
                    }
                } else {
                    if (editor) {
                        r.push('<img src="' + SKIN.img + 'filepic/' + (fix || 'unknown') + '.gif" />' + o)
                    } else {
                        r.push('<b><img src="' + SKIN.img + 'filepic/' + (fix || 'unknown') + '.gif" onclick="window.open(\'' + src + '\')" title="' + o + '" />' + del + o + '&nbsp;&nbsp;</b>')
                    }
                }
            }
        });
        return r.join('')
    },
    append: function(obj, v, s) {
        v = obj.val() + s + v;
        if (!v) return;
        v = v.split(s);
        var temp = [],
            ret = [];
        for (var i in v) {
            temp[v[i]] = 1
        }
        for (i in temp) {
            if (i) ret.push(i)
        }
        obj.val(ret.join(s))
    },
    fix: function(src) {
        if (!src || typeof src != 'string') return '';
        var s = src.split('.');
        s = s[s.length - 1];
        s = s.split('?')[0];
        s = s.split('&')[0];
        return s.toLowerCase()
    },
    imgloaded: function(my, src, w, h) {
        var s = F.fix(src);
        if (s && $.inArray(s, ['gif', 'jpg', 'jpeg', 'png', 'bmp']) == -1) {
            my.src = SKIN.img + 'filepic/' + s + '.gif'
        } else {
            $(my).setImg(w, h, src)
        }
        my.onload = null
    },
    err: function(i) {
        i.src = SKIN.img + '404.gif'
    },
    autoHeight: function(i, h) {
        var img = new Image();
        img.src = i.src;
        if (img.height <= h) {
            i.height = img.height
        } else {
            i.height = h
        }
    },
    del: function(v, name, I, delCgi) {
        var fn = function() {
            var o = $('[name="' + name + '"]', $(I).parents('.viewObj:eq(0)').parent());
            if (!o[0]) return;
            v = (F.andstr + o.val() + F.andstr).replace(F.andstr + v + F.andstr, F.andstr);
            v = v.replace(new RegExp('^' + F.andstr + '|' + F.andstr + '$', 'g'), '');
            o.val(v);
            $(I).parent().remove()
        };
        if (delCgi) {
            Confirm('确定删除附件“' + v + '”？', function() {
                $.POST(delCgi.replace('{file}', v), function(ret) {
                    COMM.suc(ret, fn)
                })
            })
        } else {
            fn()
        }
    },
    delPath: function(s, c) {
        return s && c && c.delPath ? s.replace(c.delPath, '') : s
    }
};
var upload = {
    init: function() {},
    callback: function(ret, c) {
        WIN[0].close();
        if (!ret) {
            Err(L.returnErr);
            return
        }
        var s1 = [],
            s2 = [];
        $.each(ret, function(i, o) {
            s1.push(F.delPath(o.name, c));
            if (upload.small) s2.push(F.delPath(o.small || o.name, c))
        });
        if (c.model == 'more') {
            F.append(upload.obj, s1.join(F.andstr), F.andstr);
            if (upload.small) F.append(upload.small, s2.join(F.andstr), F.andstr)
        } else {
            upload.obj.val(s1[0]);
            if (upload.small) upload.small.val(s2[0])
        }
        c.upload = true;
        F.setView(c.name, c, upload.obj.parent());
        if (upload.small) F.setView(c.small, {
            'upload': true
        })
    }
};
var webftp = {
    init: function() {},
    callback: function(ret, c) {
        WIN[0].close();
        if (c.err) alert(c.err);
        var s = [];
        $.each(ret, function(i, o) {
            s.push(F.delPath(o.path, c))
        });
        s = s.join(F.andstr);
        if (c.model == 'more') {
            F.append(webftp.obj, s, F.andstr)
        } else {
            webftp.obj.val(s)
        }
        F.setView(c.name, c, webftp.obj.parent())
    }
};
var RM = {
    init: function() {
        VAR.rmSendTo = '';
        C.rm = ',' + C.rm + ',';
        JQ.body.click(function() {
            JQ.rightMenu.hide();
            JQ.checkFormMes.html('')
        }).closeRight();
        document.body.oncontextmenu = function(e) {
            if (VAR.lock) return false;
            e = e || window.event;
            JQ.rightMenu.hide();
            var id = getIdDom(e).id;
            id = id.split('_window')[0];
            var arr = id.split('_');
            eval('var re=/' + arr[0] + '_/');
            var par = arr[1] ? id.replace(re, '') : '';
            if (C.rm.indexOf(',' + arr[0] + ',') < 0) return false;
            try {
                eval('RM.' + arr[0] + '("' + par + '",e)')
            } catch (e) {
                alert('(function RM.init) ' + e)
            }
            var x = e.clientX;
            var y = e.clientY;
            var h = JQ.rightMenu.height();
            if (y + h >= VAR.wh) y = y - h;
            JQ.rightMenu.show().css({
                top: y,
                left: x
            });
            return false
        }
    },
    sendToTable: function(fun) {
        RM.sendTo(fun, TABLE, 0, SYS.loadDeskTop, C.desktop)
    },
    sendToFast: function(fun) {
        RM.sendTo(fun, FAST, 1, SYS.loadFast)
    },
    sendToStart: function(fun) {
        RM.sendTo(fun, START, 2, function() {
            VAR.loadStart = false
        })
    },
    sendTo: function(fun, obj, pos, callback, notSame) {
        var arr = fun.split('='),
            o = {};
        if (arr[0] && arr[0].indexOf('.') > 0) {
            var temp = arr[0].split('.');
            o.package = temp[0];
            o.sign = temp[1]
        } else {
            o.sign = arr[0]
        }
        if (notSame) {
            for (var i in notSame) {
                if (o.sign == notSame[i].sign) {
                    Err('桌面已存在此应用：' + notSame[i].sign);
                    return
                }
            }
        }
        o.title = getSpace(arr[1]);
        obj.push(o);
        callback();
        $.get(CGI.ajax + '?cmd=shortcut&pos=' + pos + '&title=' + o.title + '&sign=' + o.sign)
    },
    del: function(id) {
        SYS.delDeskTop(id);
        SYS.loadDeskTop()
    },
    desktop: function(id) {
        JQ.rightMenu.html('<a class="app" fun="SYS.loadDeskTop">刷新(<u>R</u>)</a><a class="app" fun="SYS.refPage">重新载入(<u>L</u>)</a>')
    },
    desktopPic: function(id) {
        var del = '',
            i;
        for (i in C.desktop) {
            if (id == C.desktop[i].sign) {
                del = '';
                break
            } else {
                del = '<p class="line"></p><a class="app" fun="RM.del_' + id + '">删除(<u>D</u>)</a>'
            }
        }
        JQ.rightMenu.html('<a class="app" fun="' + id + '">打开(<u>O</u>)</a>' + del)
    },
    window: function(id) {
        var Win = WIN['window_' + id];
        if (!Win) return false;
        Win.show();
        var app1, app2;
        if (Win.full) {
            app1 = 'app ';
            app2 = ''
        } else {
            app1 = '';
            app2 = 'app '
        }
        if (!Win.opt.max) app2 = '';
        JQ.rightMenu.html('<a class="' + app1 + '" fun="SYS.setWin_reSize"><b></b>还原(<u>R</u>)</a><a class="app toolMin" fun="SYS.setWin_Min"><b></b>最小化(<u>N</u>)</a><a class="' + app2 + ' toolMax" fun="SYS.setWin_Max"><b></b>最大化(<u>X</u>)</a><p class="line"></p><a class="app toolClose" fun="SYS.setWin_close"><b></b>关闭(<u>C</u>)</a>')
    },
    sendToMenu: function(e, tag) {
        return;
        var dom = getAppDom(e),
            app = SYS.Exe($(dom)),
            str;
        if (app) {
            if (tag) dom = $(tag, dom)[0];
            str = setSpace(dom.innerHTML);
            VAR.rmSendTo = '<p class="line"></p><a class="app" fun="RM.sendToTable_' + app.signs + '=' + str + '">桌面快捷方式(<u>T</u>)</a><a class="app" fun="RM.sendToStart_' + fun + '=' + str + '">发送到开始菜单(<u>S</u>)</a>'
        } else {
            VAR.rmSendTo = ''
        }
    },
    left: function(id, e) {
        RM.sendToMenu(e);
        JQ.rightMenu.html('<a class="app" fun="SYS.setWin_openAll">全部展开(<u>E</u>)</a><a class="app" fun="SYS.setWin_foldAll">全部折叠(<u>Z</u>)</a>' + VAR.rmSendTo)
    },
    myAppList: function(id, e) {
        RM.sendToMenu(e, 'u');
        JQ.rightMenu.html('<a class="app" fun="' + id + '">打开(<u>O</u>)</a>' + VAR.rmSendTo)
    }
};
var Msg = new function() {
    var NS = 'Msg',
        I = {
            service: function(s, par) {
                var opt = {
                    left: 1,
                    top: 1,
                    notBg: 1
                };
                if (par) $.extend(opt, par);
                if (opt.closeBtn) s += '<p class="pa" style="height:12px;top:11px;right:4px;cursor:pointer" onclick="M.close()"><img src="' + SKIN.img + 'close.gif" /></p>';
                M.show('<div style="background:url(' + SKIN.sys + 'pop.png);width:292px;height:95px" class="pr"><p style="padding:15px 0 0 20px">' + s + '</p></div>', opt)
            },
            love: function(str, opt) {
                I.show(str ? str : L.ok, opt, 'Love')
            },
            ok: function(str, opt) {
                I.show(str ? str : L.ok, opt, 'Suc')
            },
            err: function(str, opt) {
                str = str ? str.toString() : 'L.errpar';
                (str.indexOf('L.') == 0) && (str = eval(str));
                I.show(str ? str : L.err, opt, 'Fal')
            },
            show: function(str, opt, cls) {
                if (I.t) I.t.clear();
                cls = cls || 'Def';
                var ac = 1;
                if (opt && opt.keep) {
                    ac = 0;
                    str = '<a onclick="' + NS + '.clear()" style="float:right;font-size:18px">×</a>' + str
                }
                if (opt && opt.lock) VAR.msgLock = 1;
                JQ.checkFormMes.html('<div class="checkForm' + cls + '" style="display:none">' + str + '</div>');
                var css = {
                    'left': opt && opt.left ? opt.left : I.l()
                };
                if (opt && opt.height) css.height = opt.height;
                $('.checkForm' + cls, JQ.checkFormMes).css(css).show();
                ac && I.clear(opt && opt.time ? opt.time : 3000)
            },
            l: function() {
                var w = $('div', JQ.checkFormMes).width();
                return (VAR.ww - w) / 2
            },
            clear: function(t) {
                I.t = new Delay(function() {
                    $('div', JQ.checkFormMes).fadeOut(500, function() {
                        JQ.checkFormMes.html('');
                        VAR.msgLock = false
                    })
                }, t)
            },
            loading: function() {
                I.doing(L.loading)
            },
            doing: function(s, opt) {
                s = s ? s : L.doing;
                M.doing(s)
            },
            close: function() {
                M.loadend()
            },
            formErr: function(F, name, mes) {
                F.now = $o('[name=' + name + ']');
                F.err(mes);
                F.now.focus();
                I.close()
            }
        };
    return I
};
var MES = new function() {
    var NS = 'MES',
        I = {
            obj: {
                mail: "",
                warning: "",
                mes: "",
                tip: ""
            },
            interval: "",
            mail: function(s) {
                I.app("mail", s, "新邮件")
            },
            warning: function(s) {
                I.app("warning", s, "警告")
            },
            mes: function(s) {
                I.app("mes", s, "新消息")
            },
            tip: function(s) {
                I.app("tip", s, "系统提示")
            },
            app: function(str, s, t) {
                if (!JQ.myTips) return;
                $('#mes_' + str, JQ.myTip).remove();
                if (!I.me) {
                    I.me = true;
                    JQ.myTips.mouseenter(function() {
                        I.Delay.clear()
                    })
                }
                JQ.myTip.append(getPng(str, 'a', '', 'id="mes_' + str + '" class="app" fun="' + NS + '.view_' + str + '" title="' + t + '"'));
                I.obj[str] += s + "<br />";
                clearInterval(I.interval);

                function loop() {
                    JQ.myTip.fadeOut(300).fadeIn(300);
                    if ($("a", JQ.myTip).length < 1) {
                        clearInterval(I.interval);
                        I.init()
                    }
                }
                I.interval = setInterval(loop, 1000);
                JQ.myTips.html(I.closeBtn(str) + s).slideDown();
                if (I.Delay) I.Delay.clear();
                I.Delay = new Delay(function() {
                    JQ.myTips.slideUp()
                }, 3000)
            },
            closeBtn: function(s) {
                return '<a class="app ' + NS + '_close" fun="' + NS + '.close_' + s + '" title="' + L.close + '"></a>'
            },
            view: function(s) {
                if (!I.obj[s]) return;
                I.Delay.clear();
                JQ.myTips.html(I.closeBtn(s) + I.obj[s]).slideDown();
                I.Delay = new Delay(function() {
                    I.close(s)
                }, 3000)
            },
            close: function(s) {
                JQ.myTips.slideUp();
                $("#mes_" + s, JQ.myTip).remove();
                I.obj[s] = ""
            },
            initObj: null,
            init: function() {
                return;
                I.initObj = setInterval(function() {
                    $.get(PATH.data + 'mes/' + MY.id + '.html', function(data) {
                        if (!data) return;
                        data = eval(data);
                        $(data).each(function(i, o) {
                            eval(NS + "." + o.id + "('" + o.content + "')")
                        });
                        clearInterval(I.initObj)
                    })
                }, 1000)
            }
        };
    return I
};
var normalClass = function(opt, def) {
    var I = this;
    I.opt = {
        'sign': '',
        'signs': '',
        'action': '',
        'init': '',
        'par': '',
        'partype': '',
        'title': '',
        'left': '',
        'right': '',
        'html': '',
        'closeFun': '',
        'andstr': '&nbsp;>&nbsp;',
        'diyBtn': []
    };
    I.init = function() {
        I.model = 'normal';
        I.topid = opt.topid;
        I.appId = opt.id;
        I.appFid = opt.fid;
        if (def) $.extend(I.opt, def);
        if (opt) $.extend(I.opt, opt);
        I.sign = I.opt.sign;
        I.signs = I.opt.signs;
        I.id = 'normal_' + I.sign;
        I.searchPar = {};
        I.funStr = VAR.funStr;
        I.from = opt.from;
        I.fromId = opt.fromId;
        I.title = I.opt.title;
        var s = '<div class="normalObj ' + I.id + ' lefts"></div>';
        JQ.normalLeft.append(s);
        s = '<div class="normalObj ' + I.id + '"><div class="guid"><b>' + L.yourpos + '</b><span>' + I.title + '</span></div><div class="contents">' + I.opt.html + '</div></div>';
        JQ.normalRight.append(s);
        I.cssname = '.' + I.id;
        I.win = $(I.cssname);
        I.left = I.win.eq(0);
        I.right = $('.contents', I.win.eq(1));
        I.head = $('.guid span', I.win.eq(1));
        I.action = I.opt.action;
        I.par = I.opt.par;
        I.setPAR();
        I.show();
        I.updateLeft();
        I.update('first');
        I.win.mousedown(function() {
            if (LOCAL != I.win) I.show()
        });
        SYS.setSize();
        WIN[I.id] = I;
        VAR.num++
    };
    I.updateLeft = function() {
        try {
            eval(I.sign + '.leftInit()')
        } catch (e) {
            COMM.applistLeft()
        }
    };
    I.loadLeft = function(s) {
        I.left.html(s);
        I.setTree();
        I.setTitleAndOn()
    };
    var $menuon;
    I.setLeftPos = function() {
        if (!$menuon) return;
        Delay(function() {
            var o = $menuon.offset();
            if (o) {
                var h = o.top + I.left.scrollTop() - C.hL;
                I.left.scrollTop(h)
            }
        }, 100)
    };
    I.url = function() {
        var u = I.opt.right;
        if (vars.tpl_php || u && u.indexOf('tpl.php') > 0) {
            if (I.par !== '') u += '?_par=' + I.par;
            if (I.action !== '') u += '?_action=' + I.action
        }
        return u
    };
    I.update = function(first) {
        I.setPAR();
        if (!I.opt.right) {
            WIN[0] = I;
            LOCAL = I.win;
            RIGHT = I.right;
            setTimeout(I.appInit, 50);
            return
        }
        I.right.loads(I.url(), function() {
            if (!first) I.setTitleAndOn();
            SYS.adminIo();
            I.appInit(first)
        })
    };
    I.appInit = function(first) {
        RIGHT.prepend('<div class="diyBtn"></div>');
        I.diyBtn();
        try {
            eval(I.sign + '.lock=1')
        } catch (e) {}
        if (I.opt.init == 'null') return;
        if (typeof I.opt.init == 'function') {
            I.opt.init(I)
        } else if (I.opt.init) {
            eval(I.opt.init + '()')
        } else {
            try {
                eval(I.sign + '.init()')
            } catch (e) {
                if (!I.opt.diy) M.err('[normalClass - 初始化事件错误]<br />请认真检查' + I.sign + '.init()方法是否有语法错误；<br>' + e, {
                    width: 500
                })
            }
        }
    };
    I.diyBtn = function(s, id) {
        I.winBtn = $('.diyBtn', I.win);
        if (s) {
            $('#appendBtn', I.winBtn).remove();
            I.winBtn.show().css('position', 'absolute').append('<span id="appendBtn">' + s + '</span>');
            return
        }
        s = '';
        var hide = [];
        if (I.opt.diyBtn) {
            $(I.opt.diyBtn).each(function(i, o) {
                if (o.fun == 'help') {
                    s += '<i class="help"' + (o.title && o.title != o.key ? ' title="' + o.title + '"' : ' key="' + o.key + '"') + '></i>'
                } else if (o.fun && (!o.key || APP[I.sign] && APP[I.sign].allow || SYS.allow(I.sign + '.' + o.key))) {
                    if (o.hide) {
                        hide.push(o)
                    } else {
                        s += '<input class="app" fun="' + o.fun + '" value="' + o.title + '" type="button" />'
                    }
                }
            })
        }
        if (hide.length) s += SYS.moreApp(hide);
        if (s) {
            if (RIGHT.find('.myPage').length >= 2 || RIGHT.find('.myPageTit').length == 1) {
                I.winBtn.css('position', 'absolute')
            } else {
                I.winBtn.css('position', '')
            }
            if (vars.api == 1 || vars.api == 2) {
                s = '<input type="button" value="日志" class="app" fun="log_' + WIN[0].appId + ',' + WIN[0].title + '" />' + s
            }
            I.winBtn.html(s).show()
        } else {
            I.winBtn.hide()
        }
    };
    I.show = function(n) {
        $('.normalObj').hide();
        I.win.show();
        if (WIN[0] && WIN[0].opt) {
            if (typeof WIN[0].opt.blur == 'function') WIN[0].opt.blur();
            try {
                eval(WIN[0].sign + '.blur()')
            } catch (e) {}
            editLock.out(WIN[0])
        }
        WIN[0] = I;
        LOCAL = I.win;
        RIGHT = I.right;
        VAR.funStr = I.funStr;
        VAR.lastNorApp = I.id;
        I.setPAR();
        if (!n) SYS.setHash(I.opt);
        $('a.on', JQ.normalMenu).removeClass('on');
        $('a.topid' + I.topid, JQ.normalMenu).addClass('on');
        $('[fun="' + I.funStr + '"],[fun="' + I.signs + '"]', JQ.normalMenu).addClass('on');
        if (I.fromId === I.id) return;
        setTimeout(function() {
            VAR.enterSubmit = '';
            try {
                eval('VAR.enterSubmit=' + I.sign + '.submit')
            } catch (e) {}
            if (typeof I.opt.focus == 'function') I.opt.focus();
            try {
                eval(I.sign + '.focus()')
            } catch (e) {}
        }, 100)
    };
    I.Ref = function() {
        I.updateLeft();
        I.update('first')
    };
    I.setWIN = function() {
        var i, temp = [];
        for (i in WIN) {
            if (WIN[i]) temp[i] = WIN[i]
        }
        WIN = temp
    };
    I.close = function() {
        if (I.opt.fadeOut) {
            I.win.fadeOut(I.opt.fadeOut, function() {
                I.closes()
            })
        } else {
            I.closes()
        }
    };
    I.closes = function() {
        I.win.remove();
        I.exec('close');
        if (typeof(I.opt.closeFun) == 'function') I.opt.closeFun(I);
        WIN[0] = null;
        WIN[I.id] = null;
        VAR.num--;
        I.setWIN();
        VAR.lock = false
    };
    I.on = function(k, fn) {
        Fun.add(I.id + '_' + k, fn)
    };
    I.exec = function(k) {
        Fun.exec(I.id + '_' + k, I);
        if (k == 'close') Fun.del(I.id + '_', true)
    };
    I.setTitleAndOn = function() {
        $('a.on', I.left).removeClass('on');
        var on = $('[fun="' + I.funStr + '"]', I.left);
        if (on[0]) {
            I.foldAll();
            on.last().addClass('on');
            on.prev().css('background-image', 'url(' + SKIN.sys + 'leftopen.gif)');
            I.setGuid();
            var father = true,
                p = on;
            p = p.parent();
            while (father) {
                p = p.parent().parent();
                father = p[0] && p[0].tagName == 'LI' ? p : false;
                if (!father) break;
                $('ul:first', father).show();
                $('b:first', father).css('background-image', 'url(' + SKIN.sys + 'leftopen.gif)')
            }
            on.next().next().show()
        }
        $menuon = on
    };
    I.setGuid = function() {
        var s = {},
            l = $('a.on', I.left),
            ret = [];
        $('a.on', JQ.normalMenu).each(function(i, o) {
            s['<a class="app" fun="' + $(o).attr('fun') + '">' + $(o).html() + '</a>'] = 1
        });
        if (l[0]) s['<a class="app" fun="' + l.attr('fun') + '">' + l.html() + '</a>'] = 1;
        $.each(s, function(i, o) {
            ret.push(i)
        });
        s = ret.join(I.opt.andstr);
        I.head.html(s)
    };
    I.setTree = function() {
        var o = $('li', I.left);
        o.each(function() {
            if ($('ul', this)[0]) $('a:first', this).before('<b></b>').after('<div class="clear"></div>').addClass('haschild')
        });
        $('b,a.openChild', I.left).click(function() {
            var p = $(this).parent(),
                o = $('ul:first', p);
            if (o.is(':visible')) {
                o.hide();
                $('b:first', p).css('background-image', 'url(' + SKIN.sys + 'leftclose.gif)')
            } else {
                o.show();
                $('b:first', p).css('background-image', 'url(' + SKIN.sys + 'leftopen.gif)')
            }
        })
    };
    I.openAll = function() {
        $('ul', I.left).show();
        $('b', I.left).css('background-image', 'url(' + SKIN.sys + 'leftopen.gif)')
    };
    I.foldAll = function() {
        $('ul ul', I.left).hide();
        $('b', I.left).css('background-image', 'url(' + SKIN.sys + 'leftclose.gif)')
    };
    I.setTitle = function(str, re) {
        var tit = I.opt.title;
        tit = re || !tit ? str : tit + ' ' + I.opt.andstr + ' ' + str;
        I.head.html(tit)
    };
    I.appendTitle = function(str) {
        if (str && I.head.html().indexOf(str) < 0) I.head.append(' ' + I.opt.andstr + ' ' + str)
    };
    I.init()
};
var windowClass = function(opt, def) {
    var I = this;
    I.opt = {
        'sign': '',
        'signs': '',
        'action': '',
        'init': '',
        'menu': false,
        'par': '',
        'partype': '',
        'title': '',
        'pic': '',
        'fullScreen': true,
        'lock': false,
        'lockSize': false,
        'width': 900,
        'height': 600,
        'minWidth': 350,
        'minHeight': 200,
        'fwidth': '100%',
        'fheight': '100%',
        'X': 0,
        'Y': 0,
        'time': 0,
        'step': 1000,
        'fadeOut': 0,
        'left': '',
        'right': '',
        'html': '',
        'url': '',
        'confirmFun': '',
        'okFun': '',
        'cancelFun': '',
        'closeFun': '',
        'leftWidth': 180,
        'leftMax': 500,
        'leftMin': 80,
        'leftDisplay': '',
        'winBtn': false,
        'head': true,
        'toolbar': true,
        'max': true,
        'min': true,
        'keepOpen': false,
        'andstr': ' - ',
        'overflow': '',
        'diyBtn': []
    };
    I.init = function() {
        I.model = 'window';
        I.topid = opt.topid;
        I.appId = opt.id;
        I.appFid = opt.fid;
        if (def) $.extend(I.opt, def);
        if (opt) $.extend(I.opt, opt);
        I.sign = I.opt.sign;
        I.signs = I.opt.signs;
        I.id = 'window_' + I.sign;
        I.par = I.opt.par;
        I.searchPar = {};
        I.funStr = VAR.funStr;
        I.from = opt.from;
        I.fromId = opt.fromId;
        I.lid = 'left_' + I.sign;
        I.rid = 'right_' + I.sign;
        I.width = Math.min(VAR.ww, I.opt.width.toString().indexOf('%') > 0 ? VAR.ww * int(I.opt.width.replace('%', '')) / 100 : int(I.opt.width));
        I.height = Math.min(VAR.wh, I.opt.height.toString().indexOf('%') > 0 ? VAR.wh * int(I.opt.height.replace('%', '')) / 100 : int(I.opt.height));
        I.height -= C.hTit;
        I.okFun = I.opt.okFun;
        I.cancelFun = I.opt.cancelFun;
        I.confirmFun = I.opt.confirmFun;
        I.title = getPng(I.opt.pic, 'b') + '<span>' + I.opt.title + '</span>';
        I.X = I.opt.X ? I.opt.X : (VAR.ww - I.width) / 2;
        I.Y = I.opt.Y ? I.opt.Y + C.hTit : (VAR.wh - C.hTit - I.height) / 2 + C.hTit;
        I.Y = I.Y > C.hTit ? I.Y : C.hTit;
        I.leftDisplay = I.opt.leftDisplay;
        I.opt.winBtn = I.opt.diyBtn.length;
        if (I.opt.lock) {
            I.opt.min = false;
            I.opt.max = false;
            I.opt.toolbar = false
        }
        if (I.opt.width == 1 && I.opt.height == 1) {
            I.setPAR();
            SYS.adminIo();
            I.appInit();
            return
        }
        var s = '<div class="windows" id="c' + I.id + '"><div class="winHead"><div class="winTitle noSelect dbl" fun="SYS.setWin_MaxCh">' + I.title + '<i></i></div><div class="winTitleBtn"><a class="app winMin" fun="SYS.setWin_Min"></a><a class="app reSize" fun="SYS.setWin_MaxCh"></a><a class="winClose app" fun="SYS.setWin_close"></a></div><p class="titleCircle"></p><b class="titleCircle"></b></div>';
        I.opt.menu = false;
        if (I.opt.winBtn) s += '<div class="winBtn noSelect"></div>';
        if (I.opt.url) {
            I.opt.html = '<iframe frameborder="0" src="' + I.opt.url + '" scrolling="no" width="' + I.opt.fwidth + '" height="' + I.opt.fheight + '"></iframe>'
        }
        s += '<table class="winBody"><tr><td class="winLefts noSelect"><div id="' + I.lid + '" class="winContent winLeft" style="width:' + I.opt.leftWidth + 'px"></div></td><td class="winLine noSelect dbl" fun="SYS.setWin_leftShow"></td><td class="winRights"><div id="' + I.rid + '" class="winContent winRight">' + I.opt.html + '</div></td></tr></table><div class="change noSelect"></div></div>';
        if (I.opt.css) {
            s += '<style>' + I.opt.css.replace(/\{id\}/g, 'c' + I.id) + '</style>'
        }
        JQ.desktop.append(s);
        if (I.opt.toolbar) JQ.myTools.append('<a class="app" fun="SYS.switch' + I.id + '" id="' + I.id + '" title="' + I.opt.title + '"><p class="winTitle">' + I.title + '</p></a>');
        I.cssname = '#c' + I.id;
        I.win = $(I.cssname);
        I.head = $('.winHead', I.win);
        I.winBtn = $('.winBtn', I.win);
        I.content = $('.winContent', I.win);
        I.lefts = $('.winLefts', I.win);
        I.left = $('.winLeft', I.win);
        I.line = $('.winLine', I.win);
        I.right = $('.winRight', I.win);
        I.bar = $('#' + I.id);
        I.change = $('.change', I.win);
        I._MaxCh = $('a[fun="SYS.setWin_MaxCh"]', I.head);
        I.min = $('a[fun="SYS.setWin_Min"]', I.head);
        I.action = I.opt.action;
        if (!I.opt.max || vars.model == 'normal') I._MaxCh.remove();
        if (!I.opt.min || vars.model == 'normal') I.min.remove();
        if (!I.opt.head) I.head.hide();
        if (I.opt.url || I.opt.overflow == 'hidden') I.content.css('overflow', 'hidden');
        if (I.opt.menu) $('.winMenu', I.win).menu('haschild', 'Hover');
        I.set_hCon();
        I.setFullScreen();
        I.setLeft();
        I.setPAR();
        I.win.show();
        I.show();
        I.updateLeft();
        I.update(true);
        I.setLine();
        I.move();
        I.winEvent();
        I.setToolBar()
    };
    I.winEvent = function() {
        VAR.lock = I.opt.lock;
        if (I.opt.lock) {
            I.win.mouseenter(function() {
                VAR.lock = false
            });
            I.win.mouseleave(function() {
                VAR.lock = true
            })
        }
        I.win.mousedown(function() {
            if (LOCAL != I.win && !VAR.lock) {
                I.show()
            }
        });
        if (I.opt.lockSize) {
            I.change.hide()
        } else {
            I.changeSize()
        }
        I.right.mouseenter(function() {
            JQ.body[0].onselectstart = function() {
                return true
            }
        });
        I.right.mouseleave(function() {
            JQ.body[0].onselectstart = function() {
                return false
            }
        });
        WIN[I.id] = I;
        VAR.num++
    };
    I.set_hCon = function() {
        if (I.opt.winBtn && I.opt.menu) {
            I._hCon = C.hMenu + C.hBtn + 2
        } else if (!I.opt.winBtn && I.opt.menu) {
            I._hCon = C.hMenu + 2
        } else if (I.opt.winBtn && !I.opt.menu) {
            I._hCon = C.hBtn + 2
        } else {
            I._hCon = 2
        }
    };
    I.setLeft = function() {
        if (I.leftDisplay == 'none') {
            I.lefts.hide();
            I.line.hide()
        }
        if (I.leftDisplay == 'forbid' || !I.opt.left && (I.opt.lockSize || !I.opt.fullScreen)) {
            I.lefts.remove();
            I.line.remove();
            if (I.opt.winBtn) $('[fun="SYS.setWin_leftShow"]', I.winBtn).hide()
        }
    };
    I.setFullScreen = function() {
        if (I.opt.fullScreen) {
            I.full = true;
            I.hCon = VAR.wh - C.hTool - C.hTit;
            I.win.css({
                'width': VAR.ww,
                'height': I.hCon,
                'top': C.hTit,
                'border': 0
            })
        } else {
            I.full = false;
            I.hCon = I.height;
            I.win.css({
                'width': I.width,
                'height': I.hCon,
                'left': I.X,
                'top': I.Y,
                'border': C.border
            });
            if (I.opt.max) I._MaxCh.removeClass('reSize').addClass('Max')
        }
        I.content.height(I.hCon - I._hCon)
    };
    I.setToolBar = function() {
        VAR.tn = parseInt((VAR.ww - 250) / 160);
        if (VAR.num > VAR.tn) {
            JQ.myTools[0].className = 'minBar';
            VAR.mtn = parseInt((VAR.ww - 380) / 36);
            if (VAR.num == VAR.mtn) {
                MES.warning('<li>警告：系统窗口已经达到上限，若再新开窗口系统将自动关闭打开的第一个窗口！<br />' + $D.date('Y-m-d H:i:s') + '</li>')
            }
            if (VAR.num > VAR.mtn) {
                for (var i in WIN) {
                    if (i != 0 && WIN[i] && typeof(WIN[i].close) == 'function') {
                        MES.tip('<li>系统自动关闭窗口【' + WIN[i].opt.title + '】<br />' + $D.date('Y-m-d H:i:s') + '</li>');
                        WIN[i].close();
                        break
                    }
                }
            }
        } else {
            JQ.myTools[0].className = ''
        }
    };
    I.updateLeft = function() {
        try {
            eval(I.sign + '.leftInit()')
        } catch (e) {}
    };
    I.loadLeft = function(s) {
        I.left.html(s);
        I.setTree();
        I.setTitleAndOn()
    };
    I.setLeftPos = function() {};
    I.url = function() {
        return I.opt.right
    };
    I.update = function(types) {
        I.setPAR();
        if (!I.opt.right) {
            WIN[0] = I;
            LOCAL = I.win;
            RIGHT = I.right;
            setTimeout(I.appInit, 50);
            return
        }
        I.right.loads(I.url(), function() {
            if (!types) I.setTitleAndOn();
            SYS.adminIo();
            I.appInit()
        })
    };
    I.appInit = function() {
        I.diyBtn();
        try {
            eval(I.sign + '.lock=1')
        } catch (e) {}
        if (I.opt.init == 'null') return;
        if (typeof I.opt.init == 'function') {
            I.opt.init(I)
        } else if (I.opt.init) {
            eval(I.opt.init + '()')
        } else {
            try {
                eval(I.sign + '.init()')
            } catch (e) {
                if (!I.opt.diy) M.err('[windowClass - 初始化事件错误]<br />请认真检查' + I.sign + '.init()方法是否有语法错误；<br>' + e, {
                    width: 500
                })
            }
        }
    };
    I.diyBtn = function(s, id) {
        if (!I.opt.winBtn || s || id) return;
        var s = '<a class="app winRef" fun="SYS.setWin_Ref"><img src="' + SKIN.winBtn + 'ref.gif" />刷新</a><a class="app winLeftShow" fun="SYS.setWin_leftShow"><img src="' + SKIN.winBtn + 'leftIo.gif" />侧边栏</a>';
        if (I.opt.diyBtn) {
            var hide = [];
            $(I.opt.diyBtn).each(function(i, o) {
                if (o.fun == 'help') {
                    s += '<i class="help"' + (o.title && o.title != o.key ? ' title="' + o.title + '"' : ' key="' + o.key + '"') + '></i>'
                } else if (o.fun && (!o.key || APP[I.sign] && APP[I.sign].allow || SYS.allow(I.sign + '.' + o.key))) {
                    if (o.hide) {
                        hide.push(o)
                    } else {
                        s += '<a class="app" fun="' + o.fun + '"><img src="' + SKIN.winBtn + (o.pic || 'def.gif') + '" />' + o.title + '</a>'
                    }
                }
            });
            if (hide.length) s += SYS.moreApp(hide)
        }
        I.winBtn.html(s)
    };
    I.show = function(n) {
        if (!I.opt.lock) {
            $('.windows').removeClass('focus');
            $('a', JQ.myTools).removeClass('on');
            I.bar.addClass('on')
        }
        I.win.css({
            'z-index': VAR.zIndex,
            'display': 'block'
        });
        I.zIndex = VAR.zIndex;
        I.exec('show');
        VAR.zIndex++;
        I.win.addClass('focus');
        if (WIN[0] && WIN[0].opt) {
            if (typeof WIN[0].opt.blur == 'function') WIN[0].opt.blur();
            try {
                eval(WIN[0].sign + '.blur()')
            } catch (e) {}
        }
        WIN[0] = I;
        LOCAL = I.win;
        RIGHT = I.right;
        I.setPAR();
        if (!n) SYS.setHash(I.opt);
        setTimeout(function() {
            VAR.enterSubmit = '';
            try {
                eval('VAR.enterSubmit=' + I.sign + '.submit')
            } catch (e) {}
            if (typeof I.opt.focus == 'function') I.opt.focus();
            try {
                eval(I.sign + '.focus()')
            } catch (e) {}
        }, 100)
    };
    I.Max = function() {
        if (!I.opt.max) return;
        I.full = true;
        I.win.css({
            'width': VAR.ww,
            'height': VAR.wh - C.hTool - C.hTit,
            'left': 0,
            'top': C.hTit,
            'border': 0
        });
        I.content.height(VAR.wh - C.hTool - C.hTit - I._hCon);
        I._MaxCh.removeClass('Max').addClass('reSize')
    };
    I.reSize = function() {
        I.full = false;
        I.win.css({
            'width': I.width,
            'height': I.height,
            'left': I.X,
            'top': I.Y,
            'border': C.border
        });
        I.content.height(I.height - I._hCon);
        if (I.opt.max) I._MaxCh.removeClass('reSize').addClass('Max')
    };
    I.Min = function(all) {
        $('a', JQ.myTools).removeClass('on');
        I.win.css('display', 'none');
        WIN[0] = null;
        if (!all) I.showLast()
    };
    I.showLast = function() {
        var z = 0,
            w = [],
            id;
        $('.windows:visible[id!=c' + I.id + ']').each(function(i, o) {
            id = o.id.replace('c', '');
            if (!WIN[id]) return false;
            w[WIN[id].zIndex] = id;
            z = WIN[id].zIndex > z ? WIN[id].zIndex : z
        });
        if (w[z] && WIN[w[z]]) {
            VAR.funStr = WIN[w[z]].funStr;
            WIN[w[z]].show()
        } else {
            if (vars.model == 'window') {
                SYS.setHash('')
            } else if (WIN[VAR.lastNorApp]) {
                VAR.funStr = WIN[VAR.lastNorApp].funStr;
                WIN[VAR.lastNorApp].show()
            }
        }
    };
    I.display = function() {
        if (I.bar.hasClass('on')) {
            I.Min()
        } else {
            I.show()
        }
    };
    I.MaxCh = function() {
        if (!I.opt.max) return;
        if (I.full) {
            I.reSize()
        } else {
            I.Max()
        }
        I.chgSize()
    };
    I.chgSize = function() {
        if (typeof I.chgWinSize == 'function') {
            setTimeout(function() {
                I.chgWinSize(I)
            }, 10)
        }
    };
    I.Ref = function() {
        I.updateLeft();
        I.update(true)
    };
    I.setWIN = function() {
        var i, temp = [];
        for (i in WIN) {
            if (WIN[i]) temp[i] = WIN[i]
        }
        WIN = temp
    };
    I.close = function(showlast) {
        if (I.opt.fadeOut) {
            I.win.fadeOut(I.opt.fadeOut, function() {
                I.closes(showlast)
            })
        } else {
            I.closes(showlast)
        }
    };
    I.closes = function(showlast) {
        I.win.remove();
        I.bar.remove();
        I.exec('close');
        if (typeof(I.opt.closeFun) == 'function') I.opt.closeFun(I);
        WIN[0] = null;
        WIN[I.id] = null;
        VAR.num--;
        I.setToolBar();
        I.setWIN();
        if (showlast !== false) I.showLast();
        if (I.ctime) clearInterval(I.ctime);
        VAR.lock = false
    };
    I.on = function(k, fn, i) {
        Fun.add(I.id + '_' + k, fn, i)
    };
    I.exec = function(k) {
        Fun.exec(I.id + '_' + k, I);
        if (k == 'close') Fun.del(I.id + '_', true)
    };
    I.move = function() {
        $('.winTitle', I.head).mousedown(function(e) {
            if (I.full) return;
            var old = I.win.offset();
            JQ.body.append('<div id="divLine" class="noSelect" style="display:none;cursor:move;width:' + (I.win.width() + 1) + 'px;height:' + (I.win.height() + 1 + C.hTit) + 'px;left:' + (old.left - 1) + 'px;top:' + (old.top - 1 - C.hTit) + 'px;"></div>');
            var obj = $('#divLine');
            var x = e.clientX - old.left;
            var y = e.clientY - old.top;
            var t, l, med = false;
            JQ.body.mousemove(function(e) {
                if (!med) obj.show();
                med = true;
                t = e.clientY - y < 0 ? 0 : e.clientY - y - 1 - C.hTit;
                l = e.clientX - x - 1;
                obj.css({
                    'top': t,
                    'left': l
                })
            }).mouseup(function(e) {
                JQ.body.unbind('mousemove').unbind('mouseup').removeClass('moveIng').openRight();
                if (t && l) {
                    I.win.css({
                        'top': t + C.hTit + 1,
                        'left': l + 1
                    });
                    I.X = e.clientX - x;
                    I.Y = e.clientY - y
                }
                obj.remove();
                I.exec('move')
            }).addClass('moveIng').closeRight()
        })
    };
    I.changeSize = function() {
        I.change.mousedown(function(e) {
            if (I.full) return;
            I.win.append('<div id="divLine" style="width:' + (I.win.width()) + 'px;height:' + (I.win.height() + C.hTit) + 'px;left:-2px;top:-' + (C.hTit + 1) + 'px;"></div>');
            var obj = $('#divLine', I.win);
            var w = I.win.width();
            var h = I.win.height();
            var x = e.clientX;
            var y = e.clientY;
            var ws, hs;
            JQ.body.mousemove(function(e) {
                ws = w + e.clientX - x;
                hs = h + e.clientY - y;
                ws = ws < I.opt.minWidth ? I.opt.minWidth : ws;
                hs = hs < I.opt.minHeight ? I.opt.minHeight : hs;
                obj.css({
                    'width': ws,
                    'height': hs + C.hTit - 1
                })
            }).mouseup(function(e) {
                JQ.body.unbind('mousemove').unbind('mouseup').removeClass('cursor_nwresize');
                if (ws && hs) {
                    I.win.css({
                        'width': ws,
                        'height': hs
                    });
                    I.content.css('height', hs - I._hCon);
                    I.width = ws;
                    I.height = hs
                }
                obj.remove();
                I.chgSize()
            }).addClass('cursor_nwresize')
        })
    };
    I.setLine = function() {
        I.line.mousedown(function(e) {
            I.win.append('<div id="divLine" style="border-left:0;border-top:0;border-bottom:0;width:' + (I.left.width() + 4) + 'px;height:' + I.left.height() + 'px;top:' + I._hCon + 'px;"></div>');
            var obj = $('#divLine', I.win);
            var pos = I.win.offset(),
                w;
            JQ.body.mousemove(function(e) {
                w = e.clientX - pos.left - 1;
                w = w > I.opt.leftMax ? I.opt.leftMax : w;
                w = w < I.opt.leftMin ? I.opt.leftMin : w;
                obj.css('width', w)
            }).mouseup(function() {
                JQ.body.unbind('mousemove').unbind('mouseup').removeClass('cursor_wresize');
                if (w) I.left.css('width', w - 4);
                obj.remove()
            }).addClass('cursor_wresize')
        })
    };
    I.setTitleAndOn = function() {
        $('a.on', I.left).removeClass('on');
        var on = $('[fun="' + (I.funStr.indexOf('articleForm') >= 0 ? I.funStr.split(',')[0] : I.funStr) + '"]', I.left);
        if (on[0]) {
            I.foldAll();
            var title = on.text();
            on.addClass('on');
            on.prev().css('background-image', 'url(' + SKIN.sys + 'leftopen.gif)');
            $('span', I.head).html(I.opt.title + I.getFullTitle(title, on));
            if (!I.par) title = I.opt.title;
            $('span', I.bar).text(title);
            var father = true,
                p = on;
            p = p.parent();
            while (father) {
                p = p.parent().parent();
                father = p[0] && p[0].tagName == 'LI' ? p : false;
                if (!father) break;
                $('ul:first', father).show();
                $('b:first', father).css('background-image', 'url(' + SKIN.sys + 'leftopen.gif)')
            }
            on.next().next().show()
        }
    };
    I.getFullTitle = function(title, on) {
        var c = I.opt.andstr;
        if (!I.par) return c + title;
        var str = '',
            father = true;
        while (father) {
            on = on.parent().parent().parent();
            father = on[0] && on[0].tagName == 'LI' ? on : false;
            if (!father) break;
            on = $('a.haschild:first', father);
            str = c + on.text() + str
        }
        return str ? str + c + title : c + title
    };
    I.setGuid = function() {};
    I.leftShow = function() {
        if (I.leftDisplay != 'none') {
            I.leftDisplay = 'none';
            I.left.hide();
            I.line.hide()
        } else {
            I.leftDisplay = '';
            I.left.show();
            I.line.show()
        }
    };
    I.setTree = function() {
        I.left.prepend('<div class="winLeftTitle"><a class="app" fun="SYS.setWin_leftShow"></a>' + I.title + '</div>');
        var o = $('li', I.left),
            p;
        o.each(function() {
            if ($('ul', I)[0]) $('a:first', I).before('<b></b>').after('<div class="clear"></div>').addClass('haschild')
        });
        $('b,a.openChild', I.left).click(function() {
            p = $(this).parent();
            o = $('ul:first', p);
            if (o.is(':visible')) {
                o.hide();
                $('b:first', p).css('background-image', 'url(' + SKIN.sys + 'leftclose.gif)')
            } else {
                o.show();
                $('b:first', p).css('background-image', 'url(' + SKIN.sys + 'leftopen.gif)')
            }
        })
    };
    I.openAll = function() {
        $('ul', I.left).show();
        $('b', I.left).css('background-image', 'url(' + SKIN.sys + 'leftopen.gif)')
    };
    I.foldAll = function() {
        $('ul ul', I.left).hide();
        $('b', I.left).css('background-image', 'url(' + SKIN.sys + 'leftclose.gif)')
    };
    I.setTitle = function(str, re) {
        var tit = I.opt.title;
        tit = re || !tit ? str : tit + ' ' + I.opt.andstr + ' ' + str;
        $('span', I.head).html(tit);
        $('span', I.bar).text(tit)
    };
    I.appendTitle = function(str) {
        var tit = $('span', I.head);
        if (str && tit.html().indexOf(str) < 0) tit.append(' ' + I.opt.andstr + ' ' + str)
    };
    if (I.opt.time) {
        var ctime = $('.winTitle i', I.win);
        ctime.attr('title', '关闭倒计时');
        var n = I.opt.time,
            step = I.opt.step;
        ctime.html(' ' + (n / step) + ' ');
        I.ctime = setInterval(function() {
            n = n - step;
            if (n <= 0) I.close();
            ctime.html(' ' + (n / step) + ' ')
        }, step)
    }
    I.init()
};
normalClass.prototype.setPAR = windowClass.prototype.setPAR = function() {
    var I = this,
        par = I.par;
    PARS = I.opt.pars;
    if (!par) {
        PAR = par;
        return
    }
    var setPar = function(v, i) {
        if (I.opt.partype !== 'string' && v && v.indexOf(':') > 0) {
            v = v.split(':');
            PAR[v[0]] = v[1]
        } else if (typeof i == 'undefined') {
            PAR = v
        } else {
            PAR[i] = v
        }
    };
    if (par.indexOf(',') >= 0) {
        PAR = {};
        par = par.split(',');
        $.each(par, function(i, v) {
            setPar(v, i)
        })
    } else {
        setPar(par)
    }
};
normalClass.prototype.searchStatus = windowClass.prototype.searchStatus = function(my, k) {
    var I = this;
    if (my) {
        delete I.searchPar[k];
        delete I.searchPar[k + '_true'];
        delete I.searchPar[k + '_sign'];
        $(my).remove();
        P.ref()
    } else {
        $('.search', I.right).each(function(i, o) {
            if (I.searchPar[$(o).attr('key')]) $(o).addClass('searchOn')
        });
        var s = '',
            obj, sign;
        if (I.searchPar) {
            $.each(I.searchPar, function(i, o) {
                if (o !== '' && i && i.indexOf('_true') < 0 && i.indexOf('_sign') < 0 && i !== 's_order' && i !== 's_key') {
                    if (!obj) obj = $o('[key="' + i + '"]').parents('table:eq(0)');
                    sign = I.searchPar[i + '_sign'] ? '' : '=';
                    s += '<a title="程序逻辑关键词：' + o + '" onclick="WIN[0].searchStatus(this,\'' + i + '\')">[' + $o('[key="' + i + '"]').text() + sign + '<u>' + htmlspecialchars(I.searchPar[i + '_true']) + '</u>]</a>'
                }
            })
        }
        if (!s) {
            $o('.searchTip').remove();
            $o('.searchOn').removeClass('searchOn');
            return
        }
        s = '<div class="searchTip"><b>搜索关键词(点击移除)：</b>' + s + '</div>';
        var o = $o('#searchObj');
        if (!o[0]) o = obj;
        if (o) {
            $o('.searchTip').remove();
            o.before(s)
        }
    }
};
var diyForm = {
    cgi: '',
    fid: 0,
    cid: 0,
    value: {},
    cut: C.dataCut,
    title: '',
    callback: function() {},
    init: function(defData) {
        diyForm.lock = 1;
        if (PAR) {
            RIGHT.loadData({
                url: diyForm.cgi + '?cmd=edit&id=' + PAR,
                callback: function(rs) {
                    if (!rs) return;
                    WIN[0].appendTitle(rs.title);
                    COMM.setCmsSelect('#cidObj', diyForm.fid, 'cid', rs.cid, diyForm.model);
                    COMM.oneCid(diyForm.fid, diyForm.title);
                    $o('[name=formset]').val($o('#tplFormset').val());
                    $o('[name=tpl]').val($o('#tplTemp').val());
                    diyForm.loadForm();
                    diyForm.callback(rs);
                    diyForm.lock = 0;
                    LOG.init({
                        'appId': diyForm.fid
                    })
                }
            })
        } else {
            WIN[0].appendTitle(L.btn.add);
            RIGHT.loadData({
                data: defData,
                callback: function() {
                    COMM.setCmsSelect('#cidObj', diyForm.fid, 'cid', diyForm.cid, diyForm.model);
                    COMM.oneCid(diyForm.fid, diyForm.title);
                    $o('[name=formset]').val($o('#tplFormset').val());
                    $o('[name=tpl]').val($o('#tplTemp').val());
                    diyForm.loadForm();
                    diyForm.callback();
                    diyForm.lock = 0
                }
            })
        }
    },
    submit: function(v) {
        var f = new Form(RIGHT);
        if (!f.check(diyForm.lock)) return;
        diyForm.setTplData();
        if (!diyForm.setContent()) return;
        f.getValue();
        Msg.doing();
        if (f.data.content) f.data.content = replaceVars(f.data.content, S);
        $.POST(diyForm.cgi + '?cmd=update&savetotpl=' + (v || ''), f.data, function(ret) {
            Msg.close();
            COMM.suc(ret, function() {
                COMM.version('specialtpl', 1);
                LOG.submit(f.data, ['formset', 'tpl', 'data', 'content']);
                WIN[0].close();
                P.ref()
            })
        })
    },
    loadForm: function() {
        $o('#formHtml').html('');
        var tpl = $o('textarea[name=formset]').val(),
            re = new RegExp('{[^}]*}', 'gi'),
            arr = tpl.match(re);
        if (!arr) return;
        diyForm.getV();
        $.each(arr, function(i, o) {
            o = o.replace(/{|}/g, '');
            o = o.split(',');
            if (o.length >= 3) diyForm.loadFormOne(o)
        });
        $o('.EDITOR').each(function() {
            loadEditor(this.parentNode, this.name, this.value, {
                height: $(this).attr('height'),
                toolbar: $(this).attr('toolbar')
            });
            $(this).remove()
        });
        $o('[fun="COMM.count"]').addClass('kup')
    },
    loadFormOne: function(arr) {
        if ($o('[name=' + C.spStr + arr[1] + ']')[0]) return;
        var s = '<tr>',
            tit;
        try {
            tit = eval(arr[0]);
            if (typeof tit != 'string') tit = arr[0]
        } catch (e) {
            tit = arr[0]
        }
        s += '<td class="myTableLeft">' + tit + '：</td><td>' + diyForm.loadFormTag(arr) + '</td>';
        s += '</tr>';
        $o('#formHtml').append(s)
    },
    loadFormTag: function(arr) {
        var s = '',
            v = diyForm.value[arr[1]],
            p = arr[3] || 'class="w2"';
        v = v ? v : '';
        switch (arr[2]) {
            case 'textarea':
                s = '<textarea name="' + C.spStr + arr[1] + '" ' + p + ' fun="COMM.count">' + v + '</textarea>';
                break;
            case 'upload':
                s = TPL.upload(v, '', arr[3] || 'img', C.spStr + arr[1]);
                break;
            case 'swf':
                s = TPL.upload(v, '', arr[3] || 'swf', C.spStr + arr[1]);
                break;
            case 'editor':
                s = '<div><textarea class="w2 EDITOR" name="' + C.spStr + arr[1] + '" height="' + (arr[3] ? arr[3] : 200) + '" toolbar="' + (arr[4] ? arr[4] : 'Small') + '">' + v + '</textarea></div>';
                break;
            default:
                s = '<input name="' + C.spStr + arr[1] + '" value="' + v + '" ' + p + ' fun="COMM.count" />'
        }
        return s
    },
    getV: function() {
        diyForm.value = clone(S);
        var data = $o('textarea[name=data]').val(),
            arr;
        if (!data) return '';
        data = data.split(diyForm.cut);
        $.each(data, function(i, o) {
            arr = o.split('=');
            diyForm.value[arr[0]] = o.replace(new RegExp('^' + arr[0] + '=', ''), '')
        })
    },
    setTplData: function() {
        var f = new Form($o('#formHtml')),
            s = '';
        f.getValue();
        $.each(f.data, function(i, o) {
            s += i.replace(C.spStr, '') + '=' + o + diyForm.cut
        });
        $o('[name=data]').val(s)
    },
    setContent: function() {
        var tpl = $o('textarea[name=tpl]').val(),
            data = $o('textarea[name=data]').val();
        if (tpl && data) {
            var n;
            arr = tpl.match(/\{\$([^}]*)\}/g);
            if (!arr) {
                Msg.err('模板配置错误：没有找到模板标签！');
                return false
            }
            diyForm.getV();
            $.each(arr, function(i, o) {
                n = o.replace(/{|}|\$/g, '');
                n = diyForm.value[n];
                if (n) tpl = tpl.replace(o, n)
            })
        }
        $o('[name=content]').val(tpl);
        return true
    }
};
var editLock = new function() {
    var I = this,
        NS = 'editLock',
        $fix = '_' + NS,
        $id = $fix + 'Id',
        $uid = $fix + 'Uid',
        $tip = $fix + 'Tip',
        $lockid, $tm = {};
    var _log = function() {};
    var _del = function(r) {
        if (!r || !r[$id]) return;
        var id = r[$id];
        delete r[$id];
        _log('删除...', id);
        $tm[id] = setTimeout(function() {
            _log('删除run', id);
            $.JSON(CGI.ajax + '?cmd=' + NS + '&lockid=' + id, function(ret) {
                _log('删除end', id)
            });
            delete $tm[id]
        }, 1000)
    };
    I.init = function(r) {
        if (!r || !r[$id]) return;
        var id = r[$id];
        $lockid = id;
        if (r[$fix]) return;
        if ($tm[id]) {
            clearTimeout($tm[id]);
            delete $tm[id];
            _log('删除stop', id)
        }
        WIN[0][$id] = id;
        _log('注册', id);
        WIN[0].on('close', function() {
            _del(r)
        }, $id)
    };
    I.out = function(r) {
        if (!r || !r[$id]) return;
        _del(r)
    };
    I.setPar = function(d) {
        if (WIN[0] && WIN[0][$id]) d[$id] = WIN[0][$id]
    };
    I.tips = function(ret) {
        if (!ret) return;
        if (!ret[$fix]) return;
        setTimeout(function() {
            if (ret[$tip]) Msg.ok('催促成功！');
            $('#' + NS + '_' + $lockid).remove();
            RIGHT.append('<div id="' + NS + '_' + $lockid + '" onclick="' + NS + '.tip()" style="cursor:pointer;' + (WIN[0].sign == 'ac3form' ? 'left:75%;' : '') + '" class="appLock" title="【点击锁定者头像可以RTX催促对方尽快处理。】&#13;若锁定用户处于“已离开”状态，那么请您重新进入当前页面让编辑功能生效；&#13;' + ret[$fix].replace(/<br>/g, '&#13;') + '"><p>' + SYS.headpic(ret[$uid]) + '</p><i>' + TPL.uid(ret[$uid]) + '</i></div>');
            $o('input[type!=radio]').attr('disabled', true)
        }, 500)
    };
    I.tip = function() {
        Msg.doing('锁定催促中...');
        $.JSON(CGI.ajax + '?cmd=' + NS + 'Tip&lockid=' + $lockid, function(ret) {
            Msg.close()
        })
    };
    I.end = function(k) {
        $('#' + NS + '_' + $lockid).find('i').html('<span style="color:red">已离开</span>')
    }
};
var BYSocket = function(p) {
    if (typeof JSON != 'object') $.getScript('http://pklx117.17c.cn/jsmin/json2.js');
    var c = {
        'ip': '',
        'port': '',
        'data': '',
        'delay': 0,
        'heartbeat': 300
    };
    $.extend(c, p);
    var u = '/' + '/' + c.ip;
    if (c.port) u += ':' + c.port;
    var I = io(u);
    I.cmd = function(k, d, f) {
        if (typeof d == 'function') {
            f = d;
            d = null
        }
        if (typeof f == 'function') {
            I._callbacks[k] = [];
            I.on(k, f)
        }
        I.emit(k, d)
    };
    I.eval = function(s) {
        I.emit('eval', s);
        return s
    };
    I.on('eval', function(d) {
        echo(d)
    });
    I.js = function(js, to, notck) {
        if (!notck) {
            try {
                eval(js)
            } catch (e) {
                return echo('推送代码存在错误', e)
            }
        }
        I.emit('js', js, to);
        return js
    };
    I.on('js', function(d) {
        try {
            eval(d)
        } catch (e) {
            return echo('推送代码存在错误', d, e)
        }
    });
    I.on('reconnect', function(d) {
        if (c.delay) {
            setTimeout(I.init, c.delay)
        } else {
            I.init()
        }
    });
    I.init = function() {
        I.emit('login', c.data);
        if (!c.heartbeat) return;
        setInterval(function() {
            I.emit('heartbeat', 1)
        }, 1000 * c.heartbeat);
        c.heartbeat = 0
    };
    return I
};
(function($) {
    var escapeable = /["\\\x00-\x1f\x7f-\x9f]/g,
        meta = {
            '\b': '\\b',
            '\t': '\\t',
            '\n': '\\n',
            '\f': '\\f',
            '\r': '\\r',
            '"': '\\"',
            '\\': '\\\\'
        };
    $.toJSON = typeof JSON === 'object' && JSON.stringify ? JSON.stringify : function(o) {
        if (o === null) {
            return 'null'
        }
        var type = typeof o;
        if (type === 'undefined') {
            return undefined
        }
        if (type === 'number' || type === 'boolean') {
            return '' + o
        }
        if (type === 'string') {
            return $.quoteString(o)
        }
        if (type === 'object') {
            if (typeof o.toJSON === 'function') {
                return $.toJSON(o.toJSON())
            }
            if (o.constructor === Date) {
                var month = o.getUTCMonth() + 1,
                    day = o.getUTCDate(),
                    year = o.getUTCFullYear(),
                    hours = o.getUTCHours(),
                    minutes = o.getUTCMinutes(),
                    seconds = o.getUTCSeconds(),
                    milli = o.getUTCMilliseconds();
                if (month < 10) {
                    month = '0' + month
                }
                if (day < 10) {
                    day = '0' + day
                }
                if (hours < 10) {
                    hours = '0' + hours
                }
                if (minutes < 10) {
                    minutes = '0' + minutes
                }
                if (seconds < 10) {
                    seconds = '0' + seconds
                }
                if (milli < 100) {
                    milli = '0' + milli
                }
                if (milli < 10) {
                    milli = '0' + milli
                }
                return '"' + year + '-' + month + '-' + day + 'T' + hours + ':' + minutes + ':' + seconds + '.' + milli + 'Z"'
            }
            if (o.constructor === Array) {
                var ret = [];
                for (var i = 0; i < o.length; i++) {
                    ret.push($.toJSON(o[i]) || 'null')
                }
                return '[' + ret.join(',') + ']'
            }
            var name, val, pairs = [];
            for (var k in o) {
                type = typeof k;
                if (type === 'number') {
                    name = '"' + k + '"'
                } else if (type === 'string') {
                    name = $.quoteString(k)
                } else {
                    continue
                }
                type = typeof o[k];
                if (type === 'function' || type === 'undefined') {
                    continue
                }
                val = $.toJSON(o[k]);
                pairs.push(name + ':' + val)
            }
            return '{' + pairs.join(',') + '}'
        }
    };
    $.evalJSON = typeof JSON === 'object' && JSON.parse ? JSON.parse : function(src) {
        return eval('(' + src + ')')
    };
    $.secureEvalJSON = typeof JSON === 'object' && JSON.parse ? JSON.parse : function(src) {
        var filtered = src.replace(/\\["\\\/bfnrtu]/g, '@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']').replace(/(?:^|:|,)(?:\s*\[)+/g, '');
        if (/^[\],:{}\s]*$/.test(filtered)) {
            return eval('(' + src + ')')
        } else {
            throw new SyntaxError('Error parsing JSON, source is not valid.');
        }
    };
    $.quoteString = function(string) {
        if (string.match(escapeable)) {
            return '"' + string.replace(escapeable, function(a) {
                    var c = meta[a];
                    if (typeof c === 'string') {
                        return c
                    }
                    c = a.charCodeAt();
                    return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16)
                }) + '"'
        }
        return '"' + string + '"'
    }
})(jQuery);
(function() {
    var uCheck = {
        list: []
    };
    $.fn.uCheck = function(name, val, opt, apiurl) {
        uCheck.list.push([$(this), name, val, opt]);
        apiurl = apiurl || 'http://cmslib.oa.com/';
        $.uc_api_url = apiurl;
        var url = apiurl + 'tool/?id=userCheck';
        var exec = function() {
            var fn = function(I, name, val, opt) {
                opt = opt && typeof opt == 'object' ? opt : {};
                if (!opt.placeholder) opt.placeholder = opt.mode == 'group' ? '搜索部门' : '搜索用户';
                var s = [];
                if (!opt.noinput) {
                    var a = [];
                    a.push('type="text"');
                    a.push('autocomplete="off"');
                    a.push('placeholder="' + opt.placeholder + '"');
                    a.push('size="' + (opt.size || 8) + '"');
                    a.push('uc_type="input"');
                    a.push('style="margin-right:3px"');
                    if (opt['class']) a.push('class="' + opt['class'] + '"');
                    if (opt.name) a.push('name="' + opt.name + '"');
                    s.push('<input ' + a.join(' ') + ' />')
                }
                if (!opt.nocheck) {
                    if (!opt.batchcheck) {
                        if (opt.limit == 1) {
                            opt.batchcheck = '点击选择'
                        } else {
                            opt.batchcheck = '批量选择'
                        }
                    }
                    s.push('<button uc_type="button" type="button">' + opt.batchcheck + '</button>')
                }
                delete opt.noinput;
                delete opt.nocheck;
                delete opt.size;
                delete opt['class'];
                s.push('<span uc_type="list"></span>');
                if (opt.value_en) {
                    opt.value_en = '[uc_type=value_en]';
                    s.push('<input uc_type="value_en" type="hidden" value="' + val + '" name="' + name + '" />')
                } else if (opt.value_zh) {
                    opt.value_zh = '[uc_type=value_zh]';
                    s.push('<input uc_type="value_zh" type="hidden" value="' + val + '" name="' + name + '" />')
                } else {
                    opt.value_id = '[uc_type=value_id]';
                    s.push('<input uc_type="value_id" type="hidden" value="' + val + '" name="' + name + '" />')
                }
                I.html(s.join(''));
                var set = {
                    mode: 'all',
                    button: '[uc_type=button]',
                    input: '[uc_type=input]',
                    list: '[uc_type=list]'
                };
                if (opt) $.extend(set, opt);
                I.userCheck(set);
                if (typeof set.callback == 'function') set.callback(I, name, val, opt)
            };
            while (1) {
                var v = uCheck.list.shift();
                if (!v) break;
                fn(v[0], v[1], v[2], v[3])
            }
        };
        if (uCheck.ready) {
            exec()
        } else {
            if (uCheck.loading) return;
            uCheck.loading = 1;
            $.getScript(url, function() {
                uCheck.ready = 1;
                exec()
            })
        }
    }
})();
$(document).keydown(function(e) {
    if (M.lock) return;
    var lc = M.local();
    if (!lc) return;
    switch (e.keyCode) {
        case 27:
            lc.close();
            return false;
            break;
        case 32:
        case 13:
            if ($('.dialog_y', lc.obj)[0]) {
                lc.ok();
                return false
            }
            break;
        default:
            break
    }
    M.time = M.microtime()
});
$(window).resize(function() {
    SYS.setSize()
});
var Wmode = {
    init: function(name) {
        var c = {
            name: 'wmode',
            def: '',
            width: 300,
            height: 300
        };
        if (name && typeof name == 'object') {
            $.extend(c, name)
        } else {
            if (name) c.name = name
        }
        var p = {
                width: c.width,
                height: c.height,
                search: 1,
                showid: 1
            },
            s = TPL.selects(c.def, '', 'VAR.wmodeMap', c.name, p);
        $o('#' + c.name + 'Obj').html(s)
    }
};
var isIE = (navigator.appVersion.indexOf("MSIE") != -1) ? true : false;
var isWin = (navigator.appVersion.toLowerCase().indexOf("win") != -1) ? true : false;
var isOpera = (navigator.userAgent.indexOf("Opera") != -1) ? true : false;

function loadFlash(url, flashvars, w, h, wmode, name, opt) {
    name = name || 'texas';
    opt = opt || {};
    var s = getFlash(url, flashvars, w, h, wmode, name, opt);
    if (opt.retstr) return s;
    document.write(s)
}
function getFlash(url, flashvars, w, h, wmode, name, opt) {
    name = name || 'texas';
    opt = opt || {};
    var a = ['codebase', 'https://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0', 'width', w, 'height', h, 'flashvars', flashvars, 'src', url, 'quality', 'high', 'pluginspage', 'http://www.adobe.com/go/getflashplayer', 'align', 'left', 'play', 'true', 'loop', 'true', 'scale', opt.scale || 'showall', 'wmode', wmode, 'devicefont', 'false', 'id', name, 'name', name, 'menu', opt.menu || 'true', 'type', 'application/x-shockwave-flash', 'allowFullScreen', 'true', 'allowScriptAccess', 'always', 'movie', url, 'salign', 'lt'];
    if (!vars.screenType) {
        a.push('bgcolor', opt.bgcolor || '#000')
    }
    if (vars.openFullScreenChat) {
        a.push('allowFullScreenInteractive', 'true')
    }
    a = AC_GetArgs(a, '.swf', 'movie', 'clsid:d27cdb6e-ae6d-11cf-96b8-444553540000', 'application/x-shockwave-flash');
    return AC_Generateobj(a.objAttrs, a.params, a.embedAttrs, 1)
}
function AC_AddExtension(src, ext) {
    if (src.indexOf('?') != -1) return src.replace(/\?/, ext + '?');
    else return src + ext
}
function AC_GetArgs(args, ext, srcParamName, classid, mimeType) {
    var ret = {
        embedAttrs: {},
        params: {},
        objAttrs: {}
    };
    for (var i = 0; i < args.length; i = i + 2) {
        var currArg = args[i].toLowerCase();
        switch (currArg) {
            case 'classid':
                break;
            case 'pluginspage':
                ret.embedAttrs[args[i]] = args[i + 1];
                break;
            case 'src':
            case 'movie':
                args[i + 1] = AC_AddExtension(args[i + 1], ext);
                ret.embedAttrs['src'] = args[i + 1];
                ret.params[srcParamName] = args[i + 1];
                break;
            case 'onafterupdate':
            case 'onbeforeupdate':
            case 'onblur':
            case 'oncellchange':
            case 'onclick':
            case 'ondblclick':
            case 'ondrag':
            case 'ondragend':
            case 'ondragenter':
            case 'ondragleave':
            case 'ondragover':
            case 'ondrop':
            case 'onfinish':
            case 'onfocus':
            case 'onhelp':
            case 'onmousedown':
            case 'onmouseup':
            case 'onmouseover':
            case 'onmousemove':
            case 'onmouseout':
            case 'onkeypress':
            case 'onkeydown':
            case 'onkeyup':
            case 'onload':
            case 'onlosecapture':
            case 'onpropertychange':
            case 'onreadystatechange':
            case 'onrowsdelete':
            case 'onrowenter':
            case 'onrowexit':
            case 'onrowsinserted':
            case 'onstart':
            case 'onscroll':
            case 'onbeforeeditfocus':
            case 'onactivate':
            case 'onbeforedeactivate':
            case 'ondeactivate':
            case 'type':
            case 'codebase':
            case 'id':
                ret.objAttrs[args[i]] = args[i + 1];
                break;
            case 'width':
            case 'height':
            case 'align':
            case 'vspace':
            case 'hspace':
            case 'class':
            case 'title':
            case 'accesskey':
            case 'name':
            case 'tabindex':
                ret.embedAttrs[args[i]] = ret.objAttrs[args[i]] = args[i + 1];
                break;
            default:
                ret.embedAttrs[args[i]] = ret.params[args[i]] = args[i + 1]
        }
    }
    ret.objAttrs['classid'] = classid;
    if (mimeType) ret.embedAttrs['type'] = mimeType;
    return ret
}
function AC_Generateobj(objAttrs, params, embedAttrs, ret) {
    var str = '';
    if (isIE && isWin && !isOpera) {
        str += '<object ';
        for (var i in objAttrs) {
            str += i + '="' + objAttrs[i] + '" '
        }
        str += '>';
        for (var i in params) {
            str += '<param name="' + i + '" value="' + params[i] + '" /> '
        }
        str += '</object>'
    } else {
        str += '<embed ';
        for (var i in embedAttrs) {
            str += i + '="' + embedAttrs[i] + '" '
        }
        str += '></embed>'
    }
    if (ret) return str;
    document.write(str)
}
function AC_FL_RunContent() {
    var ret = AC_GetArgs(arguments, '.swf', 'movie', 'clsid:d27cdb6e-ae6d-11cf-96b8-444553540000', 'application/x-shockwave-flash');
    AC_Generateobj(ret.objAttrs, ret.params, ret.embedAttrs)
}
function AC_FL_RunContent_v2() {
    var ret = AC_GetArgs(arguments, '.swf', 'movie', 'clsid:d27cdb6e-ae6d-11cf-96b8-444553540000', 'application/x-shockwave-flash');
    return AC_Generateobj(ret.objAttrs, ret.params, ret.embedAttrs, true)
};
var _cmsCk = 1;